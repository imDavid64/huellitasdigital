-- ==========================================
-- Orden de creacion de tablas para la base de datos HUELLITAS
-- 1 HUELLITAS_TABLAS.sql
-- 2 HUELLITAS_FUNCIONES.sql
-- 3 HUELLITAS_TRIGGERS.sql
-- 4 HUELLITAS_PROCEDIMIENTOS.sql
-- 5 HUELLITAS_VISTAS.sql
-- 6 HUELLITAS_PRUEBAS.sql
-- ==========================================
use HUELLITASDIGITAL;
-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_ESTADO_ACTIVO_INACTIVO_SP
-- DESCRIPCIÓN: Procedimiento para listar solo los estado de "Activo" e "Inactivo"
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_ESTADO_ACTIVO_INACTIVO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_ESTADO_ACTIVO_INACTIVO_SP()
BEGIN
    SELECT 
        ID_ESTADO_PK,
        ESTADO_DESCRIPCION
    FROM huellitas_estado_tb
    WHERE ESTADO_DESCRIPCION IN ('Activo', 'Inactivo')
    ORDER BY ESTADO_DESCRIPCION ASC;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_ESTADOS_SP
-- DESCRIPCIÓN: Procedimiento obtener todos los estados
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_ESTADOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_ESTADOS_SP()
BEGIN
    SELECT 
        ID_ESTADO_PK,
        ESTADO_DESCRIPCION
    FROM huellitas_estado_tb
    ORDER BY ESTADO_DESCRIPCION ASC;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_ESTADOS_PEDIDO_SP
-- DESCRIPCIÓN: Obtiene únicamente los estados válidos para los pedidos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_ESTADOS_PEDIDO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_ESTADOS_PEDIDO_SP()
BEGIN
    SELECT 
        ID_ESTADO_PK,
        ESTADO_DESCRIPCION
    FROM 
        HUELLITAS_ESTADO_TB
    WHERE 
        ESTADO_DESCRIPCION IN ('PENDIENTE', 'EN PREPARACIÓN', 'ENVIADO', 'ENTREGADO', 'CANCELADO')
    ORDER BY 
        FIELD(ESTADO_DESCRIPCION, 'PENDIENTE', 'EN PREPARACIÓN', 'ENVIADO', 'ENTREGADO', 'CANCELADO');
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_ESTADOS_COMPROBANTE_PAGO_SP
-- DESCRIPCIÓN: Obtiene únicamente los estados válidos para los estados del comprobante de pago
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_ESTADOS_COMPROBANTE_PAGO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_ESTADOS_COMPROBANTE_PAGO_SP()
BEGIN
    SELECT 
        ID_ESTADO_PK,
        ESTADO_DESCRIPCION
    FROM 
        HUELLITAS_ESTADO_TB
    WHERE 
        ESTADO_DESCRIPCION IN ('APROBADO', 'RECHAZADO')
    ORDER BY 
        FIELD(ESTADO_DESCRIPCION, 'APROBADO', 'RECHAZADO');
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_ESTADOS_PAGO_SP
-- DESCRIPCIÓN: Obtiene únicamente los estados válidos para los pagos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_ESTADOS_PAGO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_ESTADOS_PAGO_SP()
BEGIN
    SELECT 
        ID_ESTADO_PK,
        ESTADO_DESCRIPCION
    FROM 
        HUELLITAS_ESTADO_TB
    WHERE 
        ESTADO_DESCRIPCION IN (
			'EN REVISIÓN',
            'PENDIENTE DE PAGO',
            'PAGADO',
            'RECHAZADO',
            'REEMBOLSADO'
        )
    ORDER BY 
        FIELD(
            ESTADO_DESCRIPCION,
            'EN REVISIÓN',
            'PENDIENTE DE PAGO',
            'PAGADO',
            'RECHAZADO',
            'REEMBOLSADO'
        );
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_NUEVO_SP
-- DESCRIPCIÓN: Procedimiento para listar los estado de un producto
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_NUEVO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_NUEVO_SP()
BEGIN
    SELECT 
        ID_NUEVO_PK,
        NUEVO_DESCRIPCION
    FROM HUELLITAS_NUEVO_TB
    ORDER BY ID_NUEVO_PK ASC;
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_CAMBIAR_CONTRASENNA_SP
-- DESCRIPCIÓN: Procedimiento para cambiar la contraseña de un usuario verificando la actual
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CAMBIAR_CONTRASENNA_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_CAMBIAR_CONTRASENNA_SP(
    IN P_USUARIO_ID INT,
    IN P_CONTRASENNA_ACTUAL VARCHAR(255),
    IN P_CONTRASENNA_NUEVA VARCHAR(255)
)
BEGIN
    DECLARE V_CONTRASENNA_VALIDA BOOLEAN;
    DECLARE V_SALT_ANTERIOR VARCHAR(100);
    
    -- VERIFICAR CONTRASEÑA ACTUAL
    SET V_CONTRASENNA_VALIDA = HUELLITAS_VERIFICAR_CONTRASENNA_FN(P_USUARIO_ID, P_CONTRASENNA_ACTUAL);
    
    IF V_CONTRASENNA_VALIDA THEN
        -- OBTENER SALT ANTERIOR (PARA DEPURACIÓN)
        SELECT USUARIO_SALT 
        INTO V_SALT_ANTERIOR 
        FROM huellitas_usuarios_tb 
        WHERE ID_USUARIO_PK = P_USUARIO_ID;
        
        -- ACTUALIZAR CONTRASEÑA (EL TRIGGER SE ENCARGA DE LA ENCRIPTACIÓN)
        UPDATE huellitas_usuarios_tb 
        SET USUARIO_CONTRASENNA = P_CONTRASENNA_NUEVA
        WHERE ID_USUARIO_PK = P_USUARIO_ID;
        
        SELECT 
            'CONTRASEÑA ACTUALIZADA EXITOSAMENTE' AS MENSAJE,
            CONCAT('SALT ANTERIOR: ', V_SALT_ANTERIOR) AS DEBUG_INFO;
    ELSE
        SELECT 'ERROR: CONTRASEÑA ACTUAL INCORRECTA' AS MENSAJE;
    END IF;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_VALIDAR_LOGIN_SP
-- DESCRIPCIÓN: Procedimiento para validar el login de usuario con verificación de estado
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_VALIDAR_LOGIN_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_VALIDAR_LOGIN_SP(
    IN P_USUARIO_CORREO VARCHAR(100),
    IN P_CONTRASENNA_INTENTO VARCHAR(255)
)
BEGIN
    DECLARE V_USUARIO_ID INT;
    DECLARE V_CONTRASENNA_VALIDA BOOLEAN;
    DECLARE V_ID_ESTADO_FK INT;
    
    -- OBTENER DATOS DEL USUARIO
    SELECT 
        ID_USUARIO_PK, 
        ID_ESTADO_FK
    INTO 
        V_USUARIO_ID, 
        V_ID_ESTADO_FK
    FROM huellitas_usuarios_tb 
    WHERE USUARIO_CORREO = P_USUARIO_CORREO;
    
    IF V_USUARIO_ID IS NULL THEN
        SELECT 'ERROR: USUARIO NO ENCONTRADO' AS MENSAJE, FALSE AS LOGIN_EXITOSO;
        
    ELSEIF V_ID_ESTADO_FK != 1 THEN  -- 1 = ACTIVO
        SELECT 'ERROR: USUARIO INACTIVO' AS MENSAJE, FALSE AS LOGIN_EXITOSO;
        
    ELSE
        -- VERIFICAR CONTRASEÑA
        SET V_CONTRASENNA_VALIDA = HUELLITAS_VERIFICAR_CONTRASENNA_FN(V_USUARIO_ID, P_CONTRASENNA_INTENTO);
        
        IF V_CONTRASENNA_VALIDA THEN
            -- ACTUALIZAR ÚLTIMO LOGIN
            UPDATE huellitas_usuarios_tb 
            SET USUARIO_ULTIMO_LOGIN = NOW()
            WHERE ID_USUARIO_PK = V_USUARIO_ID;
            
            -- RETORNAR DATOS DEL USUARIO LOGUEADO
            SELECT
                'LOGIN EXITOSO' AS MENSAJE,
                TRUE AS LOGIN_EXITOSO,
                U.ID_USUARIO_PK AS ID_USUARIO,
                U.USUARIO_NOMBRE,
                U.USUARIO_CORREO,
                R.DESCRIPCION_ROL_USUARIO AS ROL
            FROM huellitas_usuarios_tb U
            INNER JOIN huellitas_rol_usuario_tb R 
                ON U.ID_ROL_USUARIO_FK = R.ID_ROL_USUARIO_PK
            WHERE U.ID_USUARIO_PK = V_USUARIO_ID;
                
        ELSE
            SELECT 'ERROR: CONTRASEÑA INCORRECTA' AS MENSAJE, FALSE AS LOGIN_EXITOSO;
        END IF;
    END IF;
END//
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_INICIALIZAR_CLAVE_ENCRIPTACION_SP
-- DESCRIPCIÓN: Procedimiento para inicializar claves de encriptación si no existen
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_INICIALIZAR_CLAVE_ENCRIPTACION_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_INICIALIZAR_CLAVE_ENCRIPTACION_SP(
    IN P_NOMBRE_CLAVE VARCHAR(100)
)
BEGIN
    DECLARE V_CLAVE_EXISTENTE INT;
    
    SELECT COUNT(*) INTO V_CLAVE_EXISTENTE 
    FROM huellitas_claves_encriptacion_tb 
    WHERE NOMBRE_CLAVE = P_NOMBRE_CLAVE AND ESTA_ACTIVA = TRUE;
    
    IF V_CLAVE_EXISTENTE = 0 THEN
        INSERT INTO huellitas_claves_encriptacion_tb (NOMBRE_CLAVE, CLAVE_ENCRIPTACION, VERSION_CLAVE)
        VALUES (P_NOMBRE_CLAVE, HUELLITAS_GENERAR_CLAVE_AES_FN(), 1);
    END IF;
END//
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_TARJETAS_USUARIO_SP
-- DESCRIPCIÓN: Procedimiento para obtener las tarjetas de un usuario de forma segura
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_TARJETAS_USUARIO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_OBTENER_TARJETAS_USUARIO_SP(
    IN P_ID_USUARIO_FK INT
)
BEGIN
    SELECT 
        ID_TARJETA_PK, 
        TIPO_TARJETA, 
        MARCA_TARJETA, 
        NOMBRE_TITULAR,
        ULTIMOS_CUATRO_DIGITOS, 
        DATE_FORMAT(FECHA_VENCIMIENTO, '%m/%Y') AS FECHA_VENCIMIENTO_FORMATEADA,
        ES_PREDETERMINADO, 
        FECHA_REGISTRO,
        'VIGENTE' AS ESTADO_TARJETA -- EL FRONTEND MANEJA LA LÓGICA DE VENCIMIENTO
    FROM huellitas_tarjetas_tb
    WHERE ID_USUARIO_FK = P_ID_USUARIO_FK 
      AND ESTA_ACTIVO = TRUE
    ORDER BY ES_PREDETERMINADO DESC, FECHA_REGISTRO DESC;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ROTAR_CLAVES_ENCRIPTACION_SP
-- DESCRIPCIÓN: Procedimiento para rotar claves de encriptación y reencriptar datos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ROTAR_CLAVES_ENCRIPTACION_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_ROTAR_CLAVES_ENCRIPTACION_SP(
    IN P_NOMBRE_CLAVE VARCHAR(100),
    IN P_NUEVA_VERSION INT
)
BEGIN
    DECLARE V_FINALIZADO INT DEFAULT 0;
    DECLARE V_ID_TARJETA INT;
    DECLARE V_NUMERO_ENCRIPTADO TEXT;
    DECLARE V_CVV_ENCRIPTADO TEXT;
    
    DECLARE CUR_TARJETAS CURSOR FOR 
    SELECT ID_TARJETA_PK, NUMERO_TARJETA_ENCRIPTADO, CVV_ENCRIPTADO 
    FROM huellitas_tarjetas_tb WHERE ESTA_ACTIVO = TRUE;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET V_FINALIZADO = 1;
    
    UPDATE huellitas_claves_encriptacion_tb 
    SET ESTA_ACTIVA = FALSE 
    WHERE NOMBRE_CLAVE = P_NOMBRE_CLAVE AND ESTA_ACTIVA = TRUE;
    
    INSERT INTO huellitas_claves_encriptacion_tb (NOMBRE_CLAVE, CLAVE_ENCRIPTACION, VERSION_CLAVE)
    VALUES (P_NOMBRE_CLAVE, HUELLITAS_GENERAR_CLAVE_AES_FN(), P_NUEVA_VERSION);
    
    OPEN CUR_TARJETAS;
    BUCLE_REENCRIPTACION: LOOP
        FETCH CUR_TARJETAS INTO V_ID_TARJETA, V_NUMERO_ENCRIPTADO, V_CVV_ENCRIPTADO;
        IF V_FINALIZADO = 1 THEN LEAVE BUCLE_REENCRIPTACION; END IF;
        
        UPDATE huellitas_tarjetas_tb 
        SET NUMERO_TARJETA_ENCRIPTADO = HUELLITAS_ENCRIPTAR_DATO_FN(
            HUELLITAS_DESENCRIPTAR_DATO_FN(V_NUMERO_ENCRIPTADO, P_NOMBRE_CLAVE), P_NOMBRE_CLAVE
        ),
        CVV_ENCRIPTADO = HUELLITAS_ENCRIPTAR_DATO_FN(
            HUELLITAS_DESENCRIPTAR_DATO_FN(V_CVV_ENCRIPTADO, P_NOMBRE_CLAVE), P_NOMBRE_CLAVE
        )
        WHERE ID_TARJETA_PK = V_ID_TARJETA;
    END LOOP;
    CLOSE CUR_TARJETAS;
END//
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_USUARIO_SP
-- DESCRIPCIÓN: Procedimiento para listar todos los usuarios con sus roles y estados
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_USUARIO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_USUARIO_SP()
BEGIN
    SELECT 
        U.ID_USUARIO_PK, 
        U.USUARIO_NOMBRE, 
        U.USUARIO_CORREO,
        R.DESCRIPCION_ROL_USUARIO AS ROL, 
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM huellitas_usuarios_tb U
    INNER JOIN huellitas_rol_usuario_tb R 
        ON U.ID_ROL_USUARIO_FK = R.ID_ROL_USUARIO_PK
    INNER JOIN huellitas_estado_tb E 
        ON U.ID_ESTADO_FK = E.ID_ESTADO_PK
    ORDER BY U.ID_USUARIO_PK;
END//
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_ROLES_SP
-- DESCRIPCIÓN: Procedimiento para listar todos los roles de usuario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_ROLES_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_ROLES_SP()
BEGIN
    SELECT 
        R.ID_ROL_USUARIO_PK,
        R.DESCRIPCION_ROL_USUARIO,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM huellitas_rol_usuario_tb R
    INNER JOIN huellitas_estado_tb E 
        ON R.ID_ESTADO_FK = E.ID_ESTADO_PK
    ORDER BY R.ID_ROL_USUARIO_PK;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_ROLES_SP
-- DESCRIPCIÓN: Procedimiento para listar todos los roles con información completa
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_ROLES_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_ROLES_SP()
BEGIN
    SELECT 
        R.ID_ROL_USUARIO_PK,
        R.DESCRIPCION_ROL_USUARIO,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM huellitas_rol_usuario_tb R
    INNER JOIN huellitas_estado_tb E 
        ON R.ID_ESTADO_FK = E.ID_ESTADO_PK
    ORDER BY R.ID_ROL_USUARIO_PK;
END//
DELIMITER ;



-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_PRODUCTOS_SP
-- DESCRIPCIÓN: Procedimiento para listar todos los productos con información relacionada
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PRODUCTOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_PRODUCTOS_SP()
BEGIN
    SELECT 
        P.ID_PRODUCTO_PK,
        P.PRODUCTO_NOMBRE,
        P.PRODUCTO_DESCRIPCION,
        P.PRODUCTO_PRECIO_UNITARIO,
        P.PRODUCTO_STOCK,
        P.IMAGEN_URL,
        P.FECHA_CREACION,

        -- RELACIONES
        E.ESTADO_DESCRIPCION AS ESTADO,
        PR.PROVEEDOR_NOMBRE AS PROVEEDOR,
        C.DESCRIPCION_CATEGORIA AS CATEGORIA,
        M.NOMBRE_MARCA AS MARCA,
        N.NUEVO_DESCRIPCION AS CONDICION
    FROM 
        huellitas_productos_tb P
        INNER JOIN huellitas_estado_tb E 
            ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
        INNER JOIN huellitas_proveedores_tb PR 
            ON P.ID_PROVEEDOR_FK = PR.ID_PROVEEDOR_PK
        INNER JOIN huellitas_productos_categoria_tb C 
            ON P.ID_CATEGORIA_FK = C.ID_CATEGORIA_PK
        INNER JOIN huellitas_marcas_tb M 
            ON P.ID_MARCA_FK = M.ID_MARCA_PK
        INNER JOIN huellitas_nuevo_tb N 
            ON P.ID_NUEVO_FK = N.ID_NUEVO_PK
    ORDER BY 
        P.FECHA_CREACION DESC;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_PRODUCTO_SP
-- DESCRIPCIÓN: Procedimiento para actualizar la información de un producto
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_PRODUCTO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_PRODUCTO_SP (
    IN P_ID_PRODUCTO INT,
    IN P_ID_PROVEEDOR INT,
    IN P_ID_ESTADO INT,
    IN P_ID_CATEGORIA INT,
    IN P_ID_MARCA INT,
    IN P_ID_NUEVO INT,
    IN P_NOMBRE VARCHAR(100),
    IN P_DESCRIPCION VARCHAR(1000),
    IN P_PRECIO DECIMAL(10,2),
    IN P_STOCK INT,
    IN P_IMAGEN_URL VARCHAR(255)
)
BEGIN
    DECLARE V_EXISTE INT;

    -- VERIFICAR QUE EL PRODUCTO EXISTA
    SELECT COUNT(*) INTO V_EXISTE
    FROM huellitas_productos_tb
    WHERE ID_PRODUCTO_PK = P_ID_PRODUCTO;

    IF V_EXISTE = 0 THEN
        SELECT '❌ ERROR: EL PRODUCTO NO EXISTE' AS MENSAJE;
    ELSE
        -- ACTUALIZAR PRODUCTO
		UPDATE huellitas_productos_tb
		SET 
			ID_PROVEEDOR_FK = P_ID_PROVEEDOR,
			ID_ESTADO_FK = P_ID_ESTADO,
			ID_CATEGORIA_FK = P_ID_CATEGORIA,
			ID_MARCA_FK = P_ID_MARCA,
			ID_NUEVO_FK = P_ID_NUEVO,
			PRODUCTO_NOMBRE = P_NOMBRE,
			PRODUCTO_DESCRIPCION = P_DESCRIPCION,
			PRODUCTO_PRECIO_UNITARIO = P_PRECIO,
			PRODUCTO_STOCK = P_STOCK,
			IMAGEN_URL = P_IMAGEN_URL
		WHERE ID_PRODUCTO_PK = P_ID_PRODUCTO;

        SELECT '✅ PRODUCTO ACTUALIZADO CORRECTAMENTE' AS MENSAJE;
    END IF;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_PRODUCTO_SP
-- DESCRIPCIÓN: Procedimiento para agregar nuevos productos al sistema
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_PRODUCTO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_AGREGAR_PRODUCTO_SP (
    IN P_ID_PROVEEDOR INT,
    IN P_ID_ESTADO INT,
    IN P_ID_CATEGORIA INT,
    IN P_ID_MARCA INT,
    IN P_ID_NUEVO INT,
    IN P_NOMBRE VARCHAR(100),
    IN P_DESCRIPCION VARCHAR(1000),
    IN P_PRECIO DECIMAL(10,2),
    IN P_STOCK INT,
    IN P_IMAGEN_URL VARCHAR(255)
)
BEGIN
    DECLARE V_ERROR VARCHAR(200);

    -- VALIDAR PROVEEDOR EXISTENTE
    IF (SELECT COUNT(*) FROM huellitas_proveedores_tb WHERE ID_PROVEEDOR_PK = P_ID_PROVEEDOR) = 0 THEN
        SET V_ERROR = '❌ ERROR: EL PROVEEDOR NO EXISTE';
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = V_ERROR;
    END IF;

    -- VALIDAR CATEGORÍA EXISTENTE
    IF (SELECT COUNT(*) FROM huellitas_productos_categoria_tb WHERE ID_CATEGORIA_PK = P_ID_CATEGORIA) = 0 THEN
        SET V_ERROR = '❌ ERROR: LA CATEGORÍA NO EXISTE';
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = V_ERROR;
    END IF;

    -- VALIDAR MARCA EXISTENTE
    IF (SELECT COUNT(*) FROM huellitas_marcas_tb WHERE ID_MARCA_PK = P_ID_MARCA) = 0 THEN
        SET V_ERROR = '❌ ERROR: LA MARCA NO EXISTE';
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = V_ERROR;
    END IF;

    -- INSERTAR PRODUCTO
    INSERT INTO huellitas_productos_tb (
        ID_PROVEEDOR_FK,
        ID_ESTADO_FK,
        ID_CATEGORIA_FK,
        ID_MARCA_FK,
        ID_NUEVO_FK,
        PRODUCTO_NOMBRE,
        PRODUCTO_DESCRIPCION,
        PRODUCTO_PRECIO_UNITARIO,
        PRODUCTO_STOCK,
        IMAGEN_URL
    ) VALUES (
        P_ID_PROVEEDOR,
        P_ID_ESTADO,
        P_ID_CATEGORIA,
        P_ID_MARCA,
        P_ID_NUEVO,
        P_NOMBRE,
        P_DESCRIPCION,
        P_PRECIO,
        P_STOCK,
        P_IMAGEN_URL
    );

    -- RETORNAR CONFIRMACIÓN
    SELECT 
        '✅ PRODUCTO AGREGADO CORRECTAMENTE' AS MENSAJE,
        LAST_INSERT_ID() AS ID_PRODUCTO_CREADO;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_SLIDER_BANNER_SP
-- DESCRIPCIÓN: Procedimiento para listar todos los sliders/banners
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_SLIDER_BANNER_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_SLIDER_BANNER_SP()
BEGIN
    SELECT 
        SB.ID_SLIDER_BANNER_PK,
        SB.IMAGEN_URL,
        SB.DESCRIPCION_SLIDER_BANNER,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM 
        huellitas_slider_banner_tb SB
    INNER JOIN 
        huellitas_estado_tb E ON SB.ID_ESTADO_FK = E.ID_ESTADO_PK
    ORDER BY 
        SB.ID_SLIDER_BANNER_PK;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_SLIDER_BANNER_ACTIVOS_SP
-- DESCRIPCIÓN: Procedimiento para listar solo los sliders/banners activos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_SLIDER_BANNER_ACTIVOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_SLIDER_BANNER_ACTIVOS_SP()
BEGIN
    SELECT 
        ID_SLIDER_BANNER_PK,
        IMAGEN_URL,
        DESCRIPCION_SLIDER_BANNER
    FROM huellitas_slider_banner_tb
    WHERE ID_ESTADO_FK = 1; -- solo activos
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_SLIDER_BANNER_POR_ID_SP
-- DESCRIPCIÓN: Procedimiento para obtener un slider/banner por id
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_SLIDER_BANNER_POR_ID_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_OBTENER_SLIDER_BANNER_POR_ID_SP (
    IN P_ID_SLIDER_BANNER INT
)
BEGIN
    -- VERIFICAR SI EL REGISTRO EXISTE
    IF EXISTS (SELECT 1 FROM huellitas_slider_banner_tb WHERE ID_SLIDER_BANNER_PK = P_ID_SLIDER_BANNER) THEN
        -- RETORNAR LOS DATOS DEL SLIDER/BANNER SOLICITADO
        SELECT 
            SB.ID_SLIDER_BANNER_PK,
            SB.IMAGEN_URL,
            SB.DESCRIPCION_SLIDER_BANNER,
            SB.ID_ESTADO_FK,
            E.ESTADO_DESCRIPCION AS NOMBRE_ESTADO
        FROM 
            huellitas_slider_banner_tb SB
        INNER JOIN 
            huellitas_estado_tb E ON SB.ID_ESTADO_FK = E.ID_ESTADO_PK
        WHERE 
            SB.ID_SLIDER_BANNER_PK = P_ID_SLIDER_BANNER;
    ELSE
        -- SI NO EXISTE, RETORNAR MENSAJE
        SELECT 'NO SE ENCONTRÓ EL SLIDER/BANNER CON EL ID ESPECIFICADO' AS MENSAJE;
    END IF;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_SLIDER_BANNER_SP
-- DESCRIPCIÓN: Procedimiento para actualizar la información de un slider/banner
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_SLIDER_BANNER_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_SLIDER_BANNER_SP(
    IN P_ID_SLIDER_BANNER_PK INT,
    IN P_IMAGEN_URL VARCHAR(500),
    IN P_DESCRIPCION_SLIDER_BANNER VARCHAR(255),
    IN P_ID_ESTADO_FK INT
)
BEGIN
    DECLARE V_EXISTE INT;

    -- VERIFICAR QUE EL SLIDER/BANNER EXISTA
    SELECT COUNT(*) INTO V_EXISTE
    FROM huellitas_slider_banner_tb
    WHERE ID_SLIDER_BANNER_PK = P_ID_SLIDER_BANNER_PK;

    IF V_EXISTE = 0 THEN
        SELECT '❌ ERROR: EL SLIDER/BANNER NO EXISTE' AS MENSAJE;
    ELSE
        -- REALIZAR LA ACTUALIZACIÓN
        UPDATE huellitas_slider_banner_tb
        SET 
            IMAGEN_URL = P_IMAGEN_URL,
            DESCRIPCION_SLIDER_BANNER = P_DESCRIPCION_SLIDER_BANNER,
            ID_ESTADO_FK = P_ID_ESTADO_FK
        WHERE ID_SLIDER_BANNER_PK = P_ID_SLIDER_BANNER_PK;

        SELECT '✅ SLIDER/BANNER ACTUALIZADO CORRECTAMENTE' AS MENSAJE;
    END IF;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_SLIDER_BANNER_SP
-- DESCRIPCIÓN: Procedimiento para agregar un slider/banner
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_SLIDER_BANNER_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_AGREGAR_SLIDER_BANNER_SP (
    IN p_imagen_url VARCHAR(500),
    IN p_descripcion VARCHAR(255),
    IN p_id_estado INT
)
BEGIN
    -- Validación URL obligatoria
    IF p_imagen_url IS NULL OR p_imagen_url = '' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = '❌ La imagen del banner es requerida.';
    END IF;

    -- Validación del Estado
    IF NOT EXISTS (SELECT 1 FROM huellitas_estado_tb WHERE ID_ESTADO_PK = p_id_estado) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = '❌ El estado seleccionado no existe.';
    END IF;

    -- Inserción
    INSERT INTO huellitas_slider_banner_tb (
        IMAGEN_URL,
        DESCRIPCION_SLIDER_BANNER,
        ID_ESTADO_FK
    )
    VALUES (
        p_imagen_url,
        p_descripcion,
        p_id_estado
    );
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_PROVEEDOR_SP
-- DESCRIPCIÓN: Procedimiento para agregar nuevos proveedores con manejo de transacciones
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_PROVEEDOR_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_AGREGAR_PROVEEDOR_SP(
    IN P_PROVEEDOR_NOMBRE VARCHAR(100),
    IN P_NOMBRE_REPRESENTANTE VARCHAR(100),
    IN P_PROVEEDOR_CORREO VARCHAR(100),
    IN P_ID_ESTADO_FK INT,
    IN P_TELEFONO_CONTACTO INT
)
BEGIN
    DECLARE V_ID_TELEFONO_FK INT;

    -- MANEJADOR DE ERRORES: REVIERTE SI ALGO FALLA
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SIGNAL SQLSTATE '45000' 
            SET MESSAGE_TEXT = 'ERROR: NO SE PUDO AGREGAR EL PROVEEDOR. SE REVERTIERON LOS CAMBIOS.';
    END;

    START TRANSACTION;

    -- INSERTAR TELÉFONO DE CONTACTO
    INSERT INTO huellitas_telefono_contacto_tb (TELEFONO_CONTACTO, ID_ESTADO_FK)
    VALUES (P_TELEFONO_CONTACTO, P_ID_ESTADO_FK);

    SET V_ID_TELEFONO_FK = LAST_INSERT_ID();

    -- INSERTAR PROVEEDOR CON RELACIÓN AL TELÉFONO
    INSERT INTO huellitas_proveedores_tb 
        (PROVEEDOR_NOMBRE, NOMBRE_REPRESENTANTE, PROVEEDOR_CORREO, ID_ESTADO_FK, ID_TELEFONO_CONTACTO_FK)
    VALUES 
        (P_PROVEEDOR_NOMBRE, P_NOMBRE_REPRESENTANTE, P_PROVEEDOR_CORREO, P_ID_ESTADO_FK, V_ID_TELEFONO_FK);

    COMMIT;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_PROVEEDOR_SP
-- DESCRIPCIÓN: Procedimiento para actualizar información de proveedores
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_PROVEEDOR_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_PROVEEDOR_SP(
    IN P_ID_PROVEEDOR_PK INT,
    IN P_PROVEEDOR_NOMBRE VARCHAR(100),
    IN P_NOMBRE_REPRESENTANTE VARCHAR(100),
    IN P_PROVEEDOR_CORREO VARCHAR(100),
    IN P_ID_ESTADO_FK INT,
    IN P_TELEFONO_CONTACTO VARCHAR(20),
    IN P_DIRECCION_SENNAS VARCHAR(255)
)
BEGIN
    DECLARE V_ID_TELEFONO INT;
    DECLARE V_ID_DIRECCION INT;

    -- VALIDAR QUE EL PROVEEDOR EXISTA
    IF (SELECT COUNT(*) FROM huellitas_proveedores_tb WHERE ID_PROVEEDOR_PK = P_ID_PROVEEDOR_PK) = 0 THEN
        SIGNAL SQLSTATE '45000' 
            SET MESSAGE_TEXT = 'ERROR: EL PROVEEDOR NO EXISTE';
    END IF;

    -- OBTENER LLAVES ACTUALES DE TELÉFONO Y DIRECCIÓN
    SELECT ID_TELEFONO_CONTACTO_FK, ID_DIRECCION_FK
    INTO V_ID_TELEFONO, V_ID_DIRECCION
    FROM huellitas_proveedores_tb
    WHERE ID_PROVEEDOR_PK = P_ID_PROVEEDOR_PK;

    -- ACTUALIZAR TELÉFONO SI EXISTE
    IF V_ID_TELEFONO IS NOT NULL THEN
        UPDATE huellitas_telefono_contacto_tb
        SET TELEFONO_CONTACTO = P_TELEFONO_CONTACTO
        WHERE ID_TELEFONO_CONTACTO_PK = V_ID_TELEFONO;
    END IF;

    -- ACTUALIZAR DIRECCIÓN SI EXISTE
    IF V_ID_DIRECCION IS NOT NULL THEN
        UPDATE huellitas_direccion_tb
        SET DIRECCION_SENNAS = P_DIRECCION_SENNAS
        WHERE ID_DIRECCION_PK = V_ID_DIRECCION;
    END IF;

    -- ACTUALIZAR PROVEEDOR
    UPDATE huellitas_proveedores_tb
    SET 
        PROVEEDOR_NOMBRE = P_PROVEEDOR_NOMBRE,
        NOMBRE_REPRESENTANTE = P_NOMBRE_REPRESENTANTE,
        PROVEEDOR_CORREO = P_PROVEEDOR_CORREO,
        ID_ESTADO_FK = P_ID_ESTADO_FK
    WHERE ID_PROVEEDOR_PK = P_ID_PROVEEDOR_PK;

    SELECT '✅ PROVEEDOR ACTUALIZADO CORRECTAMENTE' AS MENSAJE;
END//
DELIMITER ;

-- ==========================================
-- PROCEDIMIENTO: HUELLITAS_CONTAR_PROVEEDORES_SP
-- DESCRIPCIÓN: Contar todos proveedores existentes
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_PROVEEDORES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CONTAR_PROVEEDORES_SP(
    IN p_query VARCHAR(100)
)
BEGIN
    SELECT 
        COUNT(*) AS TOTAL
    FROM 
        huellitas_proveedores_tb AS p
        INNER JOIN huellitas_estado_tb AS e 
            ON p.id_estado_fk = e.id_estado_pk
        LEFT JOIN huellitas_direccion_tb AS d 
            ON p.id_direccion_fk = d.id_direccion_pk
        LEFT JOIN huellitas_direccion_provincia_tb AS prov 
            ON d.id_direccion_provincia_fk = prov.id_direccion_provincia_pk
        LEFT JOIN huellitas_direccion_canton_tb AS cant 
            ON d.id_direccion_canton_fk = cant.id_direccion_canton_pk
        LEFT JOIN huellitas_direccion_distrito_tb AS dist 
            ON d.id_direccion_distrito_fk = dist.id_direccion_distrito_pk
    WHERE 
        p.proveedor_nombre LIKE CONCAT('%', p_query, '%')
        OR p.proveedor_correo LIKE CONCAT('%', p_query, '%')
        OR p.nombre_representante LIKE CONCAT('%', p_query, '%')
        OR p.proveedor_descripcion_productos LIKE CONCAT('%', p_query, '%')
        OR e.estado_descripcion LIKE CONCAT('%', p_query, '%')
        OR prov.nombre_provincia LIKE CONCAT('%', p_query, '%')
        OR cant.nombre_canton LIKE CONCAT('%', p_query, '%')
        OR dist.nombre_distrito LIKE CONCAT('%', p_query, '%');
END$$
DELIMITER ;

-- ==========================================
-- PROCEDIMIENTO: HUELLITAS_LISTAR_PROVEEDORES_ACTIVOS_SP
-- DESCRIPCIÓN: Obtiene todos los proveedores con estado ACTIVO
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PROVEEDORES_ACTIVOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_PROVEEDORES_ACTIVOS_SP()
BEGIN
    SELECT 
        ID_PROVEEDOR_PK,
        PROVEEDOR_NOMBRE,
        PROVEEDOR_CORREO,
        NOMBRE_REPRESENTANTE,
        PROVEEDOR_DESCRIPCION_PRODUCTOS,
        ID_DIRECCION_FK,
        ID_TELEFONO_CONTACTO_FK,
        ID_ESTADO_FK
    FROM huellitas_proveedores_tb
    WHERE ID_ESTADO_FK = 1
    ORDER BY PROVEEDOR_NOMBRE ASC;
END$$

DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_RECUPERAR_CONTRASENNA_SP
-- DESCRIPCIÓN: Procedimiento para recuperar/resetear contraseña de usuario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_RECUPERAR_CONTRASENNA_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_RECUPERAR_CONTRASENNA_SP (
    IN P_ID_USUARIO INT,
    IN P_NUEVA_CONTRASENNA VARCHAR(255)
)
BEGIN
    DECLARE V_EXISTE INT;

    -- VERIFICAR QUE EL USUARIO EXISTA Y ESTÉ ACTIVO
    SELECT COUNT(*) INTO V_EXISTE
    FROM huellitas_usuarios_tb
    WHERE ID_USUARIO_PK = P_ID_USUARIO 
      AND ID_ESTADO_FK = 1; -- 1 = ACTIVO

    IF V_EXISTE = 0 THEN
        SELECT '❌ ERROR: USUARIO NO ENCONTRADO O INACTIVO' AS MENSAJE;
    ELSE
        -- ACTUALIZAR LA CONTRASEÑA (EL TRIGGER HARÁ LA ENCRIPTACIÓN Y REGENERACIÓN DEL SALT)
        UPDATE huellitas_usuarios_tb
        SET USUARIO_CONTRASENNA = P_NUEVA_CONTRASENNA
        WHERE ID_USUARIO_PK = P_ID_USUARIO;

        SELECT '✅ CONTRASEÑA RECUPERADA EXITOSAMENTE' AS MENSAJE;
    END IF;
END//
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_USUARIO_POR_ID_SP
-- DESCRIPCIÓN: Procedimiento para obtener información detallada de un usuario por ID
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_USUARIO_POR_ID_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_OBTENER_USUARIO_POR_ID_SP(IN P_ID_USUARIO INT)
BEGIN
    SELECT 
        U.ID_USUARIO_PK,
        U.CODIGO_USUARIO,
        U.USUARIO_NOMBRE,
        U.USUARIO_CORREO,
        U.USUARIO_IMAGEN_URL,
        U.USUARIO_IDENTIFICACION,

        -- CAMPOS QUE FALTABAN (OBLIGATORIOS)
        U.ID_ESTADO_FK,
        U.ID_CLIENTE_VINCULADO_FK,

        R.DESCRIPCION_ROL_USUARIO AS ROL,
        T.TELEFONO_CONTACTO,
        D.DIRECCION_SENNAS,
        D.ID_DIRECCION_PROVINCIA_FK,
        D.ID_DIRECCION_CANTON_FK,
        D.ID_DIRECCION_DISTRITO_FK,
        P.NOMBRE_PROVINCIA,
        C.NOMBRE_CANTON,
        DI.NOMBRE_DISTRITO
    FROM huellitas_usuarios_tb U
    INNER JOIN huellitas_rol_usuario_tb R 
        ON U.ID_ROL_USUARIO_FK = R.ID_ROL_USUARIO_PK
    LEFT JOIN huellitas_telefono_contacto_tb T 
        ON U.ID_TELEFONO_CONTACTO_FK = T.ID_TELEFONO_CONTACTO_PK
    LEFT JOIN huellitas_direccion_tb D 
        ON U.ID_DIRECCION_FK = D.ID_DIRECCION_PK
    LEFT JOIN huellitas_direccion_provincia_tb P 
        ON D.ID_DIRECCION_PROVINCIA_FK = P.ID_DIRECCION_PROVINCIA_PK
    LEFT JOIN huellitas_direccion_canton_tb C 
        ON D.ID_DIRECCION_CANTON_FK = C.ID_DIRECCION_CANTON_PK
    LEFT JOIN huellitas_direccion_distrito_tb DI 
        ON D.ID_DIRECCION_DISTRITO_FK = DI.ID_DIRECCION_DISTRITO_PK
    WHERE U.ID_USUARIO_PK = P_ID_USUARIO;
END//
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_PERFIL_USUARIO_SP
-- DESCRIPCIÓN: Procedimiento para actualizar el perfil completo del usuario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_PERFIL_USUARIO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_PERFIL_USUARIO_SP(
    IN P_ID_USUARIO_PK INT,
    IN P_USUARIO_NOMBRE VARCHAR(100),
    IN P_USUARIO_IDENTIFICACION INT,
    IN P_USUARIO_CUENTA_BANCARIA VARCHAR(50),
    IN P_USUARIO_IMAGEN_URL VARCHAR(500),
    IN P_ID_PROVINCIA_FK INT,
    IN P_ID_CANTON_FK INT,
    IN P_ID_DISTRITO_FK INT,
    IN P_DIRECCION_SENNAS VARCHAR(200),
    IN P_TELEFONO_CONTACTO INT
)
BEGIN
    DECLARE V_ID_DIRECCION INT;
    DECLARE V_ID_TELEFONO INT;
    DECLARE V_ID_ESTADO_ACTIVO INT DEFAULT 1;

    -- Usuario existe
    IF NOT EXISTS (SELECT 1 FROM huellitas_usuarios_tb WHERE ID_USUARIO_PK = P_ID_USUARIO_PK) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'EL USUARIO ESPECIFICADO NO EXISTE.';
    END IF;

    -- Evitar choque de identificación con otro usuario
    IF P_USUARIO_IDENTIFICACION IS NOT NULL AND P_USUARIO_IDENTIFICACION <> 0 THEN
        IF EXISTS (
            SELECT 1 FROM huellitas_usuarios_tb 
            WHERE USUARIO_IDENTIFICACION = P_USUARIO_IDENTIFICACION
              AND ID_USUARIO_PK <> P_ID_USUARIO_PK
        ) THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'La identificación ya está registrada por otro usuario.';
        END IF;
    END IF;

    -- DIRECCIÓN
    SELECT ID_DIRECCION_FK INTO V_ID_DIRECCION
      FROM huellitas_usuarios_tb
     WHERE ID_USUARIO_PK = P_ID_USUARIO_PK;

    IF P_ID_PROVINCIA_FK > 0 AND P_ID_CANTON_FK > 0 AND P_ID_DISTRITO_FK > 0 THEN
        IF V_ID_DIRECCION IS NULL THEN
            INSERT INTO huellitas_direccion_tb (
                ID_ESTADO_FK, ID_DIRECCION_PROVINCIA_FK, ID_DIRECCION_CANTON_FK, ID_DIRECCION_DISTRITO_FK, DIRECCION_SENNAS
            ) VALUES (
                V_ID_ESTADO_ACTIVO, P_ID_PROVINCIA_FK, P_ID_CANTON_FK, P_ID_DISTRITO_FK, P_DIRECCION_SENNAS
            );
            SET V_ID_DIRECCION = LAST_INSERT_ID();
        ELSE
            UPDATE huellitas_direccion_tb
               SET ID_DIRECCION_PROVINCIA_FK = P_ID_PROVINCIA_FK,
                   ID_DIRECCION_CANTON_FK   = P_ID_CANTON_FK,
                   ID_DIRECCION_DISTRITO_FK = P_ID_DISTRITO_FK,
                   DIRECCION_SENNAS         = P_DIRECCION_SENNAS
             WHERE ID_DIRECCION_PK = V_ID_DIRECCION;
        END IF;
    END IF;

    -- TELÉFONO (solo si viene > 0)
    SELECT ID_TELEFONO_CONTACTO_FK INTO V_ID_TELEFONO
      FROM huellitas_usuarios_tb
     WHERE ID_USUARIO_PK = P_ID_USUARIO_PK;

    IF COALESCE(P_TELEFONO_CONTACTO,0) > 0 THEN
        IF V_ID_TELEFONO IS NULL THEN
            INSERT INTO huellitas_telefono_contacto_tb (ID_ESTADO_FK, TELEFONO_CONTACTO)
            VALUES (V_ID_ESTADO_ACTIVO, P_TELEFONO_CONTACTO);
            SET V_ID_TELEFONO = LAST_INSERT_ID();
        ELSE
            UPDATE huellitas_telefono_contacto_tb
               SET TELEFONO_CONTACTO = P_TELEFONO_CONTACTO
             WHERE ID_TELEFONO_CONTACTO_PK = V_ID_TELEFONO;
        END IF;
    END IF;

    -- USUARIO (nota COALESCE/NULLIF)
    UPDATE huellitas_usuarios_tb
       SET USUARIO_NOMBRE         = P_USUARIO_NOMBRE,
           USUARIO_IDENTIFICACION = COALESCE(NULLIF(P_USUARIO_IDENTIFICACION,0), USUARIO_IDENTIFICACION),
           USUARIO_CUENTA_BANCARIA= P_USUARIO_CUENTA_BANCARIA,
           USUARIO_IMAGEN_URL     = P_USUARIO_IMAGEN_URL,
           ID_DIRECCION_FK        = COALESCE(V_ID_DIRECCION, ID_DIRECCION_FK),
           ID_TELEFONO_CONTACTO_FK= COALESCE(V_ID_TELEFONO, ID_TELEFONO_CONTACTO_FK)
     WHERE ID_USUARIO_PK = P_ID_USUARIO_PK;

    -- CONFIRMACIÓN
    SELECT '✅ DATOS ACTUALIZADOS' AS MENSAJE, P_ID_USUARIO_PK AS ID_USUARIO,
           V_ID_DIRECCION AS ID_DIRECCION, V_ID_TELEFONO AS ID_TELEFONO;
END//
DELIMITER ;
  
-- ==========================================
-- NOMBRE: HUELLITAS_CREAR_DESCUENTO_SP
-- DESCRIPCIÓN: Procedimiento para crear nuevos descuentos temporales en productos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CREAR_DESCUENTO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_CREAR_DESCUENTO_SP(
    IN P_ID_PRODUCTO_FK INT,
    IN P_PORCENTAJE_DESCUENTO DECIMAL(5,2),
    IN P_FECHA_FIN DATE
)
BEGIN
    DECLARE V_PRODUCTO_EXISTE INT;
    
    -- VERIFICAR QUE EL PRODUCTO EXISTA
    SELECT COUNT(*) INTO V_PRODUCTO_EXISTE
    FROM huellitas_productos_tb 
    WHERE ID_PRODUCTO_PK = P_ID_PRODUCTO_FK 
      AND ID_ESTADO_FK = 1; -- 1 = ACTIVO
    
    IF V_PRODUCTO_EXISTE = 0 THEN
        SELECT '❌ ERROR: PRODUCTO NO ENCONTRADO O INACTIVO' AS MENSAJE;
        
    ELSEIF P_FECHA_FIN < CURDATE() THEN
        SELECT '❌ ERROR: LA FECHA FIN NO PUEDE SER ANTERIOR A HOY' AS MENSAJE;
        
    ELSE
        -- INSERTAR NUEVO DESCUENTO (FECHA INICIO IMPLÍCITA = HOY)
        INSERT INTO huellitas_descuentos_tb (
            ID_PRODUCTO_FK,
            ID_ESTADO_FK,
            PORCENTAJE_DESCUENTO,
            FECHA_FIN
        ) VALUES (
            P_ID_PRODUCTO_FK,
            1, -- ACTIVO
            P_PORCENTAJE_DESCUENTO,
            P_FECHA_FIN
        );
        
        SELECT 
            '✅ DESCUENTO CREADO EXITOSAMENTE' AS MENSAJE,
            LAST_INSERT_ID() AS ID_DESCUENTO_CREADO,
            CURDATE() AS FECHA_INICIO,
            P_FECHA_FIN AS FECHA_FIN;
    END IF;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_DESACTIVAR_DESCUENTOS_VENCIDOS_SP
-- DESCRIPCIÓN: Procedimiento para desactivar automáticamente descuentos vencidos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_DESACTIVAR_DESCUENTOS_VENCIDOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_DESACTIVAR_DESCUENTOS_VENCIDOS_SP()
BEGIN
    -- DESACTIVAR DESCUENTOS CUYA FECHA_FIN YA PASÓ
    UPDATE huellitas_descuentos_tb 
    SET ID_ESTADO_FK = 0 -- INACTIVO
    WHERE ID_ESTADO_FK = 1 -- ACTIVO
      AND FECHA_FIN < CURDATE();
    
    -- MOSTRAR CUÁNTOS REGISTROS FUERON AFECTADOS
    SELECT 
        CONCAT('✅ DESCUENTOS DESACTIVADOS: ', ROW_COUNT()) AS RESULTADO;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LIMPIAR_DESCUENTOS_VENCIDOS_EV
-- DESCRIPCIÓN: Evento programado para limpiar descuentos vencidos diariamente
-- ==========================================
DROP EVENT IF EXISTS HUELLITAS_LIMPIAR_DESCUENTOS_VENCIDOS_EV;
DELIMITER //
CREATE EVENT HUELLITAS_LIMPIAR_DESCUENTOS_VENCIDOS_EV
ON SCHEDULE EVERY 1 DAY
STARTS CURRENT_TIMESTAMP
DO
BEGIN
    CALL HUELLITAS_DESACTIVAR_DESCUENTOS_VENCIDOS_SP();
END//
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_DESCUENTOS_ACTIVOS_SP
-- DESCRIPCIÓN: Procedimiento para obtener descuentos activos de productos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_DESCUENTOS_ACTIVOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_OBTENER_DESCUENTOS_ACTIVOS_SP(
    IN P_ID_PRODUCTO_FK INT -- NULL PARA TODOS LOS PRODUCTOS
)
BEGIN
    IF P_ID_PRODUCTO_FK IS NULL THEN
        -- OBTENER TODOS LOS DESCUENTOS ACTIVOS
        SELECT 
            D.ID_DESCUENTO_PK,
            P.PRODUCTO_NOMBRE AS NOMBRE_PRODUCTO,
            D.PORCENTAJE_DESCUENTO,
            D.FECHA_CREACION AS FECHA_INICIO, -- FECHA CREACIÓN COMO INICIO
            D.FECHA_FIN,
            CASE 
                WHEN D.FECHA_FIN >= CURDATE() THEN 'ACTIVO'
                ELSE 'VENCIDO'
            END AS ESTADO_DESCUENTO,
            DATEDIFF(D.FECHA_FIN, CURDATE()) AS DIAS_RESTANTES
        FROM huellitas_descuentos_tb D
        INNER JOIN huellitas_productos_tb P 
            ON D.ID_PRODUCTO_FK = P.ID_PRODUCTO_PK
        WHERE D.ID_ESTADO_FK = 1
          AND D.FECHA_FIN >= CURDATE()
        ORDER BY D.FECHA_FIN ASC;
    ELSE
        -- OBTENER DESCUENTOS DE UN PRODUCTO ESPECÍFICO
        SELECT 
            D.ID_DESCUENTO_PK,
            P.PRODUCTO_NOMBRE AS NOMBRE_PRODUCTO,
            D.PORCENTAJE_DESCUENTO,
            D.FECHA_CREACION AS FECHA_INICIO,
            D.FECHA_FIN,
            CASE 
                WHEN D.FECHA_FIN >= CURDATE() THEN 'ACTIVO'
                ELSE 'VENCIDO'
            END AS ESTADO_DESCUENTO,
            DATEDIFF(D.FECHA_FIN, CURDATE()) AS DIAS_RESTANTES
        FROM huellitas_descuentos_tb D
        INNER JOIN huellitas_productos_tb P 
            ON D.ID_PRODUCTO_FK = P.ID_PRODUCTO_PK
        WHERE D.ID_PRODUCTO_FK = P_ID_PRODUCTO_FK
          AND D.ID_ESTADO_FK = 1
          AND D.FECHA_FIN >= CURDATE()
        ORDER BY D.FECHA_FIN ASC;
    END IF;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_CATEGORIA_SP
-- DESCRIPCIÓN: Procedimiento para insertar nuevas categorías de productos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_CATEGORIA_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_AGREGAR_CATEGORIA_SP (
    IN P_ID_ESTADO_FK INT,
    IN P_DESCRIPCION_CATEGORIA VARCHAR(100)
)
BEGIN
    INSERT INTO huellitas_productos_categoria_tb (ID_ESTADO_FK, DESCRIPCION_CATEGORIA)
    VALUES (P_ID_ESTADO_FK, P_DESCRIPCION_CATEGORIA);

    SELECT 
        '✅ CATEGORÍA AGREGADA CORRECTAMENTE' AS MENSAJE,
        LAST_INSERT_ID() AS ID_CATEGORIA_CREADA;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_CATEGORIAS_SP
-- DESCRIPCIÓN: Procedimiento para listar todas las categorías de productos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_CATEGORIAS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_CATEGORIAS_SP()
BEGIN
    SELECT 
        C.ID_CATEGORIA_PK,
        C.DESCRIPCION_CATEGORIA,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM huellitas_productos_categoria_tb AS C
    INNER JOIN huellitas_estado_tb AS E 
        ON E.ID_ESTADO_PK = C.ID_ESTADO_FK
    ORDER BY C.ID_CATEGORIA_PK ASC;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_CATEGORIAS_ACTIVAS_SP
-- DESCRIPCIÓN: Obtiene todas las categorías activas
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_CATEGORIAS_ACTIVAS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_CATEGORIAS_ACTIVAS_SP()
BEGIN
    SELECT 
        ID_CATEGORIA_PK,
        DESCRIPCION_CATEGORIA,
        ID_ESTADO_FK
    FROM huellitas_productos_categoria_tb
    WHERE ID_ESTADO_FK = 1
    ORDER BY DESCRIPCION_CATEGORIA ASC;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_CATEGORIA_SP
-- DESCRIPCIÓN: Procedimiento para actualizar categorías de productos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_CATEGORIA_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_CATEGORIA_SP (
    IN P_ID_CATEGORIA_PK INT,
    IN P_ID_ESTADO_FK INT,
    IN P_DESCRIPCION_CATEGORIA VARCHAR(100)
)
BEGIN
    DECLARE V_AFECTADAS INT;

    UPDATE huellitas_productos_categoria_tb
    SET 
        ID_ESTADO_FK = P_ID_ESTADO_FK,
        DESCRIPCION_CATEGORIA = P_DESCRIPCION_CATEGORIA
    WHERE ID_CATEGORIA_PK = P_ID_CATEGORIA_PK;

    SET V_AFECTADAS = ROW_COUNT();

    IF V_AFECTADAS > 0 THEN
        SELECT CONCAT('✅ CATEGORÍA ACTUALIZADA CORRECTAMENTE (ID: ', P_ID_CATEGORIA_PK, ')') AS MENSAJE;
    ELSE
        SELECT '⚠️ NO SE ENCONTRÓ NINGUNA CATEGORÍA CON EL ID ESPECIFICADO O NO HUBO CAMBIOS.' AS MENSAJE;
    END IF;
END //
DELIMITER ;

-- ==========================================
-- PROCEDIMIENTO: HUELLITAS_CONTAR_CATEGORIAS_SP
-- DESCRIPCIÓN: Contar las categorias existentes
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_CATEGORIAS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CONTAR_CATEGORIAS_SP(
    IN p_query VARCHAR(100)
)
BEGIN
    SELECT 
        COUNT(*) AS total
    FROM 
        huellitas_productos_categoria_tb AS c
        INNER JOIN huellitas_estado_tb AS e 
            ON c.ID_ESTADO_FK = e.ID_ESTADO_PK
    WHERE 
        c.DESCRIPCION_CATEGORIA LIKE CONCAT('%', p_query, '%')
        OR e.ESTADO_DESCRIPCION LIKE CONCAT('%', p_query, '%');
END$$
DELIMITER ;


-- ==========================================
-- PROCEDIMIENTO: HUELLITAS_OBTENER_CATEGORIA_POR_ID_SP
-- DESCRIPCIÓN: Obtiene una categoría por ID
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_CATEGORIA_POR_ID_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_CATEGORIA_POR_ID_SP(
    IN p_id_categoria INT
)
BEGIN
    SELECT ID_CATEGORIA_PK,
           DESCRIPCION_CATEGORIA,
           ID_ESTADO_FK
    FROM huellitas_productos_categoria_tb
    WHERE ID_CATEGORIA_PK = p_id_categoria;
END$$

DELIMITER ;



-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_MARCA_SP
-- DESCRIPCIÓN: Procedimiento para insertar nuevas marcas de productos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_MARCA_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_AGREGAR_MARCA_SP (
    IN P_NOMBRE_MARCA VARCHAR(100),
    IN P_ID_ESTADO_FK INT,
    IN P_MARCA_IMAGEN_URL VARCHAR(500)
)
BEGIN
    DECLARE V_ID_MARCA INT;

    -- INSERTA NUEVA MARCA
    INSERT INTO huellitas_marcas_tb (NOMBRE_MARCA, ID_ESTADO_FK, MARCA_IMAGEN_URL)
    VALUES (P_NOMBRE_MARCA, P_ID_ESTADO_FK, P_MARCA_IMAGEN_URL);

    SET V_ID_MARCA = LAST_INSERT_ID();

    -- DEVUELVE MENSAJE Y EL ID GENERADO
    SELECT 
        '✅ MARCA AGREGADA CORRECTAMENTE' AS MENSAJE,
        V_ID_MARCA AS ID_MARCA_CREADA,
        P_NOMBRE_MARCA AS NOMBRE_MARCA,
        P_MARCA_IMAGEN_URL AS IMAGEN;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_MARCA_SP
-- DESCRIPCIÓN: Procedimiento para actualizar marcas de productos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_MARCA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_MARCA_SP(
    IN p_id_marca INT,
    IN p_nombre_marca VARCHAR(100),
    IN p_id_estado INT,
    IN p_imagen_url VARCHAR(500)
)
BEGIN
    UPDATE huellitas_marcas_tb
    SET
        NOMBRE_MARCA = p_nombre_marca,
        ID_ESTADO_FK = p_id_estado,
        MARCA_IMAGEN_URL = p_imagen_url
    WHERE ID_MARCA_PK = p_id_marca;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_MARCAS_SP
-- DESCRIPCIÓN: Procedimiento para listar
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_MARCAS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_MARCAS_SP()
BEGIN
    SELECT 
        M.ID_MARCA_PK,
        M.NOMBRE_MARCA,
        M.MARCA_IMAGEN_URL,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM huellitas_marcas_tb AS M
    INNER JOIN huellitas_estado_tb AS E 
        ON E.ID_ESTADO_PK = M.ID_ESTADO_FK
    ORDER BY M.ID_MARCA_PK ASC;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_CONTAR_MARCAS_SP
-- DESCRIPCIÓN: Procedimiento para contar todas las marcas existentes
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_MARCAS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CONTAR_MARCAS_SP(
    IN p_query VARCHAR(100)
)
BEGIN
    SELECT 
        COUNT(*) AS total
    FROM 
        huellitas_marcas_tb AS m
        INNER JOIN huellitas_estado_tb AS e 
            ON m.ID_ESTADO_FK = e.ID_ESTADO_PK
    WHERE 
        m.NOMBRE_MARCA LIKE CONCAT('%', p_query, '%')
        OR e.ESTADO_DESCRIPCION LIKE CONCAT('%', p_query, '%');
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_MARCAS_ACTIVAS_SP
-- DESCRIPCIÓN: Procedimiento para listar solo las marcas activas
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_MARCAS_ACTIVAS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_MARCAS_ACTIVAS_SP()
BEGIN
    SELECT 
        ID_MARCA_PK,
        NOMBRE_MARCA,
        MARCA_IMAGEN_URL,
        ID_ESTADO_FK
    FROM huellitas_marcas_tb
    WHERE ID_ESTADO_FK = 1
    ORDER BY NOMBRE_MARCA ASC;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_PRODUCTOS_ACTIVOS_SP
-- DESCRIPCIÓN: Procedimiento para listar solo los productos activos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PRODUCTOS_ACTIVOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_PRODUCTOS_ACTIVOS_SP()
BEGIN
    SELECT
        P.ID_PRODUCTO_PK,
        P.PRODUCTO_NOMBRE,
        P.PRODUCTO_DESCRIPCION,
        P.PRODUCTO_PRECIO_UNITARIO,
        P.PRODUCTO_STOCK,
        P.IMAGEN_URL,
        P.FECHA_CREACION,
        
        -- RELACIONES
        E.ESTADO_DESCRIPCION AS ESTADO,
        PR.PROVEEDOR_NOMBRE AS PROVEEDOR,
        C.DESCRIPCION_CATEGORIA AS CATEGORIA,
        M.NOMBRE_MARCA AS MARCA,
        N.NUEVO_DESCRIPCION AS CONDICION
    FROM 
        huellitas_productos_tb AS P
        INNER JOIN huellitas_estado_tb AS E 
            ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
        INNER JOIN huellitas_proveedores_tb AS PR 
            ON P.ID_PROVEEDOR_FK = PR.ID_PROVEEDOR_PK
        INNER JOIN huellitas_productos_categoria_tb AS C 
            ON P.ID_CATEGORIA_FK = C.ID_CATEGORIA_PK
        INNER JOIN huellitas_marcas_tb AS M 
            ON P.ID_MARCA_FK = M.ID_MARCA_PK
        INNER JOIN huellitas_nuevo_tb AS N 
            ON P.ID_NUEVO_FK = N.ID_NUEVO_PK
    WHERE P.ID_ESTADO_FK = 1  -- SOLO PRODUCTOS ACTIVOS
    ORDER BY P.FECHA_CREACION DESC;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_CONTAR_PRODUCTOS_SP
-- DESCRIPCIÓN: Procedimiento para contar todos los productos existentes
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_PRODUCTOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CONTAR_PRODUCTOS_SP(
    IN p_query VARCHAR(100)
)
BEGIN
    SELECT 
        COUNT(*) AS total
    FROM 
        huellitas_productos_tb AS p
        INNER JOIN huellitas_productos_categoria_tb AS c 
            ON p.ID_CATEGORIA_FK = c.ID_CATEGORIA_PK
        INNER JOIN huellitas_proveedores_tb AS pr 
            ON p.ID_PROVEEDOR_FK = pr.ID_PROVEEDOR_PK
    WHERE 
        p.PRODUCTO_NOMBRE LIKE CONCAT('%', p_query, '%')
        OR c.DESCRIPCION_CATEGORIA LIKE CONCAT('%', p_query, '%')
        OR pr.PROVEEDOR_NOMBRE LIKE CONCAT('%', p_query, '%');
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_PRODUCTOS_ACTIVOS_NUEVOS_SP
-- DESCRIPCIÓN: Procedimiento para listar productos activos y nuevos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PRODUCTOS_ACTIVOS_NUEVOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_PRODUCTOS_ACTIVOS_NUEVOS_SP()
BEGIN
    SELECT
        P.ID_PRODUCTO_PK,
        P.PRODUCTO_NOMBRE,
        P.PRODUCTO_DESCRIPCION,
        P.PRODUCTO_PRECIO_UNITARIO,
        P.PRODUCTO_STOCK,
        P.IMAGEN_URL,
        P.FECHA_CREACION,
        
        -- RELACIONES
        E.ESTADO_DESCRIPCION AS ESTADO,
        PR.PROVEEDOR_NOMBRE AS PROVEEDOR,
        C.DESCRIPCION_CATEGORIA AS CATEGORIA,
        M.NOMBRE_MARCA AS MARCA,
        N.NUEVO_DESCRIPCION AS CONDICION
    FROM 
        huellitas_productos_tb AS P
        INNER JOIN huellitas_estado_tb AS E 
            ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
        INNER JOIN huellitas_proveedores_tb AS PR 
            ON P.ID_PROVEEDOR_FK = PR.ID_PROVEEDOR_PK
        INNER JOIN huellitas_productos_categoria_tb AS C 
            ON P.ID_CATEGORIA_FK = C.ID_CATEGORIA_PK
        INNER JOIN huellitas_marcas_tb AS M 
            ON P.ID_MARCA_FK = M.ID_MARCA_PK
        INNER JOIN huellitas_nuevo_tb AS N 
            ON P.ID_NUEVO_FK = N.ID_NUEVO_PK
    WHERE P.ID_ESTADO_FK = 1  -- SOLO PRODUCTOS ACTIVOS
      AND P.ID_NUEVO_FK = 1   -- SOLO PRODUCTOS NUEVOS
    ORDER BY P.FECHA_CREACION DESC;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_PRODUCTOS_ALIMENTOS_SP
-- DESCRIPCIÓN: Procedimiento para listar solo los alimentos.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PRODUCTOS_ALIMENTOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_PRODUCTOS_ALIMENTOS_SP()
BEGIN
    SELECT
        P.ID_PRODUCTO_PK,
        P.PRODUCTO_NOMBRE,
        P.PRODUCTO_DESCRIPCION,
        P.PRODUCTO_PRECIO_UNITARIO,
        P.PRODUCTO_STOCK,
        P.IMAGEN_URL,
        P.FECHA_CREACION,

        -- RELACIONES
        E.ESTADO_DESCRIPCION AS ESTADO,
        PR.PROVEEDOR_NOMBRE AS PROVEEDOR,
        C.DESCRIPCION_CATEGORIA AS CATEGORIA,
        M.NOMBRE_MARCA AS MARCA,
        N.NUEVO_DESCRIPCION AS CONDICION
    FROM 
        huellitas_productos_tb AS P
        INNER JOIN huellitas_estado_tb AS E 
            ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
        INNER JOIN huellitas_proveedores_tb AS PR 
            ON P.ID_PROVEEDOR_FK = PR.ID_PROVEEDOR_PK
        INNER JOIN huellitas_productos_categoria_tb AS C 
            ON P.ID_CATEGORIA_FK = C.ID_CATEGORIA_PK
        INNER JOIN huellitas_marcas_tb AS M 
            ON P.ID_MARCA_FK = M.ID_MARCA_PK
        INNER JOIN huellitas_nuevo_tb AS N 
            ON P.ID_NUEVO_FK = N.ID_NUEVO_PK
    WHERE 
        P.ID_ESTADO_FK = 1
        AND C.DESCRIPCION_CATEGORIA = 'Alimentos'
    ORDER BY 
        P.FECHA_CREACION DESC;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_PRODUCTOS_MEDICAMENTOS_SP
-- DESCRIPCIÓN: Procedimiento para listar solo los medicamentos.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PRODUCTOS_MEDICAMENTOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_PRODUCTOS_MEDICAMENTOS_SP()
BEGIN
    SELECT
        P.ID_PRODUCTO_PK,
        P.PRODUCTO_NOMBRE,
        P.PRODUCTO_DESCRIPCION,
        P.PRODUCTO_PRECIO_UNITARIO,
        P.PRODUCTO_STOCK,
        P.IMAGEN_URL,
        P.FECHA_CREACION,

        -- RELACIONES
        E.ESTADO_DESCRIPCION AS ESTADO,
        PR.PROVEEDOR_NOMBRE AS PROVEEDOR,
        C.DESCRIPCION_CATEGORIA AS CATEGORIA,
        M.NOMBRE_MARCA AS MARCA,
        N.NUEVO_DESCRIPCION AS CONDICION
    FROM 
        huellitas_productos_tb AS P
        INNER JOIN huellitas_estado_tb AS E 
            ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
        INNER JOIN huellitas_proveedores_tb AS PR 
            ON P.ID_PROVEEDOR_FK = PR.ID_PROVEEDOR_PK
        INNER JOIN huellitas_productos_categoria_tb AS C 
            ON P.ID_CATEGORIA_FK = C.ID_CATEGORIA_PK
        INNER JOIN huellitas_marcas_tb AS M 
            ON P.ID_MARCA_FK = M.ID_MARCA_PK
        INNER JOIN huellitas_nuevo_tb AS N 
            ON P.ID_NUEVO_FK = N.ID_NUEVO_PK
    WHERE 
        P.ID_ESTADO_FK = 1
        AND C.DESCRIPCION_CATEGORIA = 'Medicamentos'
    ORDER BY 
        P.FECHA_CREACION DESC;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_PRODUCTOS_ACCESORIOS_SP
-- DESCRIPCIÓN: Procedimiento para listar solo los accesorios.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PRODUCTOS_ACCESORIOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_PRODUCTOS_ACCESORIOS_SP()
BEGIN
    SELECT
        P.ID_PRODUCTO_PK,
        P.PRODUCTO_NOMBRE,
        P.PRODUCTO_DESCRIPCION,
        P.PRODUCTO_PRECIO_UNITARIO,
        P.PRODUCTO_STOCK,
        P.IMAGEN_URL,
        P.FECHA_CREACION,

        -- RELACIONES
        E.ESTADO_DESCRIPCION AS ESTADO,
        PR.PROVEEDOR_NOMBRE AS PROVEEDOR,
        C.DESCRIPCION_CATEGORIA AS CATEGORIA,
        M.NOMBRE_MARCA AS MARCA,
        N.NUEVO_DESCRIPCION AS CONDICION
    FROM 
        huellitas_productos_tb AS P
        INNER JOIN huellitas_estado_tb AS E 
            ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
        INNER JOIN huellitas_proveedores_tb AS PR 
            ON P.ID_PROVEEDOR_FK = PR.ID_PROVEEDOR_PK
        INNER JOIN huellitas_productos_categoria_tb AS C 
            ON P.ID_CATEGORIA_FK = C.ID_CATEGORIA_PK
        INNER JOIN huellitas_marcas_tb AS M 
            ON P.ID_MARCA_FK = M.ID_MARCA_PK
        INNER JOIN huellitas_nuevo_tb AS N 
            ON P.ID_NUEVO_FK = N.ID_NUEVO_PK
    WHERE 
        P.ID_ESTADO_FK = 1
        AND C.DESCRIPCION_CATEGORIA = 'Accesorios'
    ORDER BY 
        P.FECHA_CREACION DESC;
END//
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_PRODUCTO_ACTIVO_POR_ID_SP
-- DESCRIPCIÓN: Procedimiento para obtener producto activo por id
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_PRODUCTO_ACTIVO_POR_ID_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_OBTENER_PRODUCTO_ACTIVO_POR_ID_SP(IN P_ID_PRODUCTO INT)
BEGIN
    SELECT
        P.ID_PRODUCTO_PK,
        P.PRODUCTO_NOMBRE,
        P.PRODUCTO_DESCRIPCION,
        P.PRODUCTO_PRECIO_UNITARIO,
        P.PRODUCTO_STOCK,
        P.IMAGEN_URL,
        P.FECHA_CREACION,
        
        -- RELACIONES
        E.ESTADO_DESCRIPCION AS ESTADO,
        PR.PROVEEDOR_NOMBRE AS PROVEEDOR,
        C.DESCRIPCION_CATEGORIA AS CATEGORIA,
        M.NOMBRE_MARCA AS MARCA,
        N.NUEVO_DESCRIPCION AS CONDICION
    FROM 
        huellitas_productos_tb AS P
        INNER JOIN huellitas_estado_tb AS E 
            ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
        INNER JOIN huellitas_proveedores_tb AS PR 
            ON P.ID_PROVEEDOR_FK = PR.ID_PROVEEDOR_PK
        INNER JOIN huellitas_productos_categoria_tb AS C 
            ON P.ID_CATEGORIA_FK = C.ID_CATEGORIA_PK
        INNER JOIN huellitas_marcas_tb AS M 
            ON P.ID_MARCA_FK = M.ID_MARCA_PK
        INNER JOIN huellitas_nuevo_tb AS N 
            ON P.ID_NUEVO_FK = N.ID_NUEVO_PK
    WHERE P.ID_ESTADO_FK = 1  -- SOLO PRODUCTOS ACTIVOS
      AND P.ID_PRODUCTO_PK = P_ID_PRODUCTO;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_PRODUCTOS_BUSCADOS_ACTIVOS_SP
-- DESCRIPCIÓN: Procedimiento para listar los productos buscados por el cliente
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PRODUCTOS_BUSCADOS_ACTIVOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_PRODUCTOS_BUSCADOS_ACTIVOS_SP(
    IN P_BUSQUEDA VARCHAR(100)
)
BEGIN
    SELECT
        P.ID_PRODUCTO_PK,
        P.PRODUCTO_NOMBRE,
        P.PRODUCTO_DESCRIPCION,
        P.PRODUCTO_PRECIO_UNITARIO,
        P.PRODUCTO_STOCK,
        P.IMAGEN_URL,
        P.FECHA_CREACION,
        
        -- RELACIONES
        E.ESTADO_DESCRIPCION AS ESTADO,
        PR.PROVEEDOR_NOMBRE AS PROVEEDOR,
        C.DESCRIPCION_CATEGORIA AS CATEGORIA,
        M.NOMBRE_MARCA AS MARCA,
        N.NUEVO_DESCRIPCION AS CONDICION
    FROM 
        huellitas_productos_tb AS P
        INNER JOIN huellitas_estado_tb AS E 
            ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
        INNER JOIN huellitas_proveedores_tb AS PR 
            ON P.ID_PROVEEDOR_FK = PR.ID_PROVEEDOR_PK
        INNER JOIN huellitas_productos_categoria_tb AS C 
            ON P.ID_CATEGORIA_FK = C.ID_CATEGORIA_PK
        INNER JOIN huellitas_marcas_tb AS M 
            ON P.ID_MARCA_FK = M.ID_MARCA_PK
        INNER JOIN huellitas_nuevo_tb AS N 
            ON P.ID_NUEVO_FK = N.ID_NUEVO_PK
    WHERE 
        P.ID_ESTADO_FK = 1  -- SOLO PRODUCTOS ACTIVOS
        AND (
            P.PRODUCTO_NOMBRE LIKE CONCAT('%', P_BUSQUEDA, '%')
            OR P.PRODUCTO_DESCRIPCION LIKE CONCAT('%', P_BUSQUEDA, '%')
            OR M.NOMBRE_MARCA LIKE CONCAT('%', P_BUSQUEDA, '%')
            OR C.DESCRIPCION_CATEGORIA LIKE CONCAT('%', P_BUSQUEDA, '%')
        )
    ORDER BY P.FECHA_CREACION DESC;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_BUSCAR_PRODUCTOS_ADMIN_SP
-- DESCRIPCIÓN: Procedimiento para buscar productos por parte del admin con paginación.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_BUSCAR_PRODUCTOS_ADMIN_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_BUSCAR_PRODUCTOS_ADMIN_SP(
    IN P_SEARCH_TERM VARCHAR(100),
    IN P_LIMIT_ROWS INT,
    IN P_OFFSET_ROWS INT
)
BEGIN
    SELECT 
        P.ID_PRODUCTO_PK,
        P.PRODUCTO_NOMBRE,
        P.PRODUCTO_DESCRIPCION,
        P.PRODUCTO_PRECIO_UNITARIO,
        P.PRODUCTO_STOCK,
        P.IMAGEN_URL,
        C.DESCRIPCION_CATEGORIA AS CATEGORIA,
        PR.PROVEEDOR_NOMBRE AS PROVEEDOR,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM huellitas_productos_tb AS P
    INNER JOIN huellitas_productos_categoria_tb AS C 
        ON P.ID_CATEGORIA_FK = C.ID_CATEGORIA_PK
    INNER JOIN huellitas_proveedores_tb AS PR 
        ON P.ID_PROVEEDOR_FK = PR.ID_PROVEEDOR_PK
    INNER JOIN huellitas_estado_tb AS E 
        ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
    WHERE 
        P.PRODUCTO_NOMBRE LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR C.DESCRIPCION_CATEGORIA LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR PR.PROVEEDOR_NOMBRE LIKE CONCAT('%', P_SEARCH_TERM, '%')
    ORDER BY P.PRODUCTO_NOMBRE ASC
    LIMIT P_LIMIT_ROWS OFFSET P_OFFSET_ROWS;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_BUSCAR_CATEGORIAS_ADMIN_SP
-- DESCRIPCIÓN: Procedimiento para buscar categorías con paginación.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_BUSCAR_CATEGORIAS_ADMIN_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_BUSCAR_CATEGORIAS_ADMIN_SP(
    IN P_SEARCH_TERM VARCHAR(100),
    IN P_LIMIT_ROWS INT,
    IN P_OFFSET_ROWS INT
)
BEGIN
    SELECT 
        C.ID_CATEGORIA_PK,
        C.DESCRIPCION_CATEGORIA,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM huellitas_productos_categoria_tb AS C
    INNER JOIN huellitas_estado_tb AS E 
        ON C.ID_ESTADO_FK = E.ID_ESTADO_PK
    WHERE 
        C.DESCRIPCION_CATEGORIA LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR E.ESTADO_DESCRIPCION LIKE CONCAT('%', P_SEARCH_TERM, '%')
    ORDER BY C.DESCRIPCION_CATEGORIA ASC
    LIMIT P_LIMIT_ROWS OFFSET P_OFFSET_ROWS;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_BUSCAR_MARCAS_ADMIN_SP
-- DESCRIPCIÓN: Procedimiento para buscar marcas con paginación.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_BUSCAR_MARCAS_ADMIN_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_BUSCAR_MARCAS_ADMIN_SP(
    IN P_SEARCH_TERM VARCHAR(100),
    IN P_LIMIT_ROWS INT,
    IN P_OFFSET_ROWS INT
)
BEGIN
    SELECT 
        M.ID_MARCA_PK,
        M.NOMBRE_MARCA,
        M.MARCA_IMAGEN_URL,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM huellitas_marcas_tb AS M
    INNER JOIN huellitas_estado_tb AS E 
        ON M.ID_ESTADO_FK = E.ID_ESTADO_PK
    WHERE 
        M.NOMBRE_MARCA LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR E.ESTADO_DESCRIPCION LIKE CONCAT('%', P_SEARCH_TERM, '%')
    ORDER BY M.NOMBRE_MARCA ASC
    LIMIT P_LIMIT_ROWS OFFSET P_OFFSET_ROWS;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_BUSCAR_USUARIOS_ADMIN_SP
-- DESCRIPCIÓN: Procedimiento para buscar usuarios con paginación.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_BUSCAR_USUARIOS_ADMIN_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_BUSCAR_USUARIOS_ADMIN_SP(
    IN P_SEARCH_TERM VARCHAR(100),
    IN P_LIMIT_ROWS INT,
    IN P_OFFSET_ROWS INT
)
BEGIN
    SELECT 
        U.ID_USUARIO_PK,
        U.USUARIO_NOMBRE,
        U.USUARIO_CORREO,
        U.USUARIO_IDENTIFICACION,
        R.DESCRIPCION_ROL_USUARIO AS ROL,
        E.ESTADO_DESCRIPCION AS ESTADO,
        COALESCE(T.TELEFONO_CONTACTO, 'NO REGISTRADO') AS TELEFONO,
        COALESCE(D.DIRECCION_SENNAS, 'NO REGISTRADA') AS DIRECCION,
        COALESCE(PROV.NOMBRE_PROVINCIA, '') AS PROVINCIA,
        COALESCE(CANT.NOMBRE_CANTON, '') AS CANTON,
        COALESCE(DIST.NOMBRE_DISTRITO, '') AS DISTRITO
    FROM huellitas_usuarios_tb AS U
    INNER JOIN huellitas_rol_usuario_tb AS R 
        ON U.ID_ROL_USUARIO_FK = R.ID_ROL_USUARIO_PK
    INNER JOIN huellitas_estado_tb AS E 
        ON U.ID_ESTADO_FK = E.ID_ESTADO_PK
    LEFT JOIN huellitas_telefono_contacto_tb AS T 
        ON U.ID_TELEFONO_CONTACTO_FK = T.ID_TELEFONO_CONTACTO_PK
    LEFT JOIN huellitas_direccion_tb AS D 
        ON U.ID_DIRECCION_FK = D.ID_DIRECCION_PK
    LEFT JOIN huellitas_direccion_provincia_tb AS PROV 
        ON D.ID_DIRECCION_PROVINCIA_FK = PROV.ID_DIRECCION_PROVINCIA_PK
    LEFT JOIN huellitas_direccion_canton_tb AS CANT 
        ON D.ID_DIRECCION_CANTON_FK = CANT.ID_DIRECCION_CANTON_PK
    LEFT JOIN huellitas_direccion_distrito_tb AS DIST 
        ON D.ID_DIRECCION_DISTRITO_FK = DIST.ID_DIRECCION_DISTRITO_PK
    WHERE 
        U.USUARIO_NOMBRE LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR U.USUARIO_CORREO LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR R.DESCRIPCION_ROL_USUARIO LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR E.ESTADO_DESCRIPCION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR PROV.NOMBRE_PROVINCIA LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR CANT.NOMBRE_CANTON LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR DIST.NOMBRE_DISTRITO LIKE CONCAT('%', P_SEARCH_TERM, '%')
    ORDER BY U.USUARIO_NOMBRE ASC
    LIMIT P_LIMIT_ROWS OFFSET P_OFFSET_ROWS;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_BUSCAR_PROVEEDORES_ADMIN_SP
-- DESCRIPCIÓN: Procedimiento para buscar proveedores con paginación.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_BUSCAR_PROVEEDORES_ADMIN_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_BUSCAR_PROVEEDORES_ADMIN_SP(
    IN P_SEARCH_TERM VARCHAR(100),
    IN P_LIMIT_ROWS INT,
    IN P_OFFSET_ROWS INT
)
BEGIN
    SELECT 
        P.ID_PROVEEDOR_PK,
        P.PROVEEDOR_NOMBRE,
        P.PROVEEDOR_CORREO,
        P.NOMBRE_REPRESENTANTE,
        P.PROVEEDOR_DESCRIPCION_PRODUCTOS,
        E.ESTADO_DESCRIPCION AS ESTADO,
        COALESCE(T.TELEFONO_CONTACTO, 'NO REGISTRADO') AS TELEFONO,
        COALESCE(D.DIRECCION_SENNAS, 'NO REGISTRADA') AS DIRECCION,
        COALESCE(PROV.NOMBRE_PROVINCIA, '') AS PROVINCIA,
        COALESCE(CANT.NOMBRE_CANTON, '') AS CANTON,
        COALESCE(DIST.NOMBRE_DISTRITO, '') AS DISTRITO
    FROM huellitas_proveedores_tb AS P
    INNER JOIN huellitas_estado_tb AS E 
        ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
    LEFT JOIN huellitas_telefono_contacto_tb AS T 
        ON P.ID_TELEFONO_CONTACTO_FK = T.ID_TELEFONO_CONTACTO_PK
    LEFT JOIN huellitas_direccion_tb AS D 
        ON P.ID_DIRECCION_FK = D.ID_DIRECCION_PK
    LEFT JOIN huellitas_direccion_provincia_tb AS PROV 
        ON D.ID_DIRECCION_PROVINCIA_FK = PROV.ID_DIRECCION_PROVINCIA_PK
    LEFT JOIN huellitas_direccion_canton_tb AS CANT 
        ON D.ID_DIRECCION_CANTON_FK = CANT.ID_DIRECCION_CANTON_PK
    LEFT JOIN huellitas_direccion_distrito_tb AS DIST 
        ON D.ID_DIRECCION_DISTRITO_FK = DIST.ID_DIRECCION_DISTRITO_PK
    WHERE 
        P.PROVEEDOR_NOMBRE LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR P.PROVEEDOR_CORREO LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR P.NOMBRE_REPRESENTANTE LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR P.PROVEEDOR_DESCRIPCION_PRODUCTOS LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR E.ESTADO_DESCRIPCION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR PROV.NOMBRE_PROVINCIA LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR CANT.NOMBRE_CANTON LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR DIST.NOMBRE_DISTRITO LIKE CONCAT('%', P_SEARCH_TERM, '%')
    ORDER BY P.PROVEEDOR_NOMBRE ASC
    LIMIT P_LIMIT_ROWS OFFSET P_OFFSET_ROWS;
END //
DELIMITER ;


-- ============================================================
-- NOMBRE: HUELLITAS_BUSCAR_NOTIFICACIONES_ADMIN_SP
-- DESCRIPCIÓN: Procedimiento para buscar notificaciones con paginación.
-- ============================================================
DROP PROCEDURE IF EXISTS HUELLITAS_BUSCAR_NOTIFICACIONES_ADMIN_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_BUSCAR_NOTIFICACIONES_ADMIN_SP(
    IN P_SEARCH_TERM VARCHAR(150),
    IN P_LIMIT_ROWS INT,
    IN P_OFFSET_ROWS INT
)
BEGIN
    SELECT 
        N.ID_NOTIFICACION_PK,
        N.ID_USUARIO_FK,
        U.USUARIO_NOMBRE AS NOMBRE_USUARIO,
        N.TITULO_NOTIFICACION,
        N.MENSAJE_NOTIFICACION,
        N.TIPO_NOTIFICACION,
        N.PRIORIDAD,
        N.ES_LEIDA,
        N.URL_REDIRECCION,
        N.FECHA_CREACION,
        N.FECHA_LECTURA,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM HUELLITAS_NOTIFICACIONES_TB AS N
    INNER JOIN HUELLITAS_ESTADO_TB AS E 
        ON N.ID_ESTADO_FK = E.ID_ESTADO_PK
    INNER JOIN HUELLITAS_USUARIOS_TB AS U
        ON N.ID_USUARIO_FK = U.ID_USUARIO_PK
    WHERE 
        N.TITULO_NOTIFICACION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR N.MENSAJE_NOTIFICACION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR N.TIPO_NOTIFICACION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR N.PRIORIDAD LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR E.ESTADO_DESCRIPCION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR U.USUARIO_NOMBRE LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR N.URL_REDIRECCION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR DATE_FORMAT(N.FECHA_CREACION, '%d/%m/%Y %H:%i') LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR DATE_FORMAT(N.FECHA_LECTURA, '%d/%m/%Y %H:%i') LIKE CONCAT('%', P_SEARCH_TERM, '%')
    ORDER BY N.FECHA_CREACION DESC
    LIMIT P_LIMIT_ROWS OFFSET P_OFFSET_ROWS;
END //
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_BUSCAR_ROLES_ADMIN_SP
-- DESCRIPCIÓN: Procedimiento para buscar roles con paginación.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_BUSCAR_ROLES_ADMIN_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_BUSCAR_ROLES_ADMIN_SP(
    IN P_SEARCH_TERM VARCHAR(100),
    IN P_LIMIT_ROWS INT,
    IN P_OFFSET_ROWS INT
)
BEGIN
    SELECT 
        R.ID_ROL_USUARIO_PK,
        R.DESCRIPCION_ROL_USUARIO,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM huellitas_rol_usuario_tb AS R
    INNER JOIN huellitas_estado_tb AS E 
        ON R.ID_ESTADO_FK = E.ID_ESTADO_PK
    WHERE 
        R.DESCRIPCION_ROL_USUARIO LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR E.ESTADO_DESCRIPCION LIKE CONCAT('%', P_SEARCH_TERM, '%')
    ORDER BY R.DESCRIPCION_ROL_USUARIO ASC
    LIMIT P_LIMIT_ROWS OFFSET P_OFFSET_ROWS;
END //
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_COMENTARIOS_ACTIVOS_POR_PRODUCTO_SP
-- DESCRIPCIÓN: Procedimiento para listar los comentarios de un producto en especifico.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_COMENTARIOS_ACTIVOS_POR_PRODUCTO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_COMENTARIOS_ACTIVOS_POR_PRODUCTO_SP(
    IN P_ID_PRODUCTO INT
)
BEGIN
    SELECT 
        C.ID_COMENTARIO_PK,
        C.ID_PRODUCTO_FK,
        C.ID_USUARIO_FK,
        U.USUARIO_NOMBRE AS NOMBRE_USUARIO,
        C.COMENTARIO_TEXTO,
        C.CALIFICACION_TIPO,
        C.FECHA_CREACION
    FROM huellitas_productos_comentarios_tb AS C
    INNER JOIN huellitas_usuarios_tb AS U 
        ON C.ID_USUARIO_FK = U.ID_USUARIO_PK
    WHERE C.ID_PRODUCTO_FK = P_ID_PRODUCTO
      AND C.ID_ESTADO_FK = 1  -- SOLO COMENTARIOS ACTIVOS
    ORDER BY C.FECHA_CREACION DESC;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_COMENTARIO_SP
-- DESCRIPCIÓN: Procedimiento para agregar comentarios a productos.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_COMENTARIO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_AGREGAR_COMENTARIO_SP(
    IN p_id_producto INT,
    IN p_id_usuario INT,
    IN p_comentario VARCHAR(1000),
    IN p_calificacion ENUM('1','2','3','4','5')
)
BEGIN
    INSERT INTO huellitas_productos_comentarios_tb
    (ID_PRODUCTO_FK, ID_USUARIO_FK, ID_ESTADO_FK, COMENTARIO_TEXTO, CALIFICACION_TIPO)
    VALUES (p_id_producto, p_id_usuario, 1, p_comentario, p_calificacion);
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_EDITAR_COMENTARIO_SP
-- DESCRIPCIÓN: Procedimiento para editar comentario de un producto.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_COMENTARIO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_COMENTARIO_SP(
    IN p_id_comentario INT,
    IN p_id_usuario INT,
    IN p_comentario VARCHAR(1000),
    IN p_calificacion ENUM('1','2','3','4','5')
)
BEGIN
    UPDATE huellitas_productos_comentarios_tb
    SET COMENTARIO_TEXTO = p_comentario,
        CALIFICACION_TIPO = p_calificacion
    WHERE ID_COMENTARIO_PK = p_id_comentario AND ID_USUARIO_FK = p_id_usuario;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ELIMINAR_COMENTARIO_SP
-- DESCRIPCIÓN: Procedimiento para "eliminar/desactivar" comentario de un producto.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ELIMINAR_COMENTARIO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ELIMINAR_COMENTARIO_SP(
    IN p_id_comentario INT,
    IN p_id_usuario INT
)
BEGIN
    UPDATE huellitas_productos_comentarios_tb
    SET ID_ESTADO_FK = 2
    WHERE ID_COMENTARIO_PK = p_id_comentario AND ID_USUARIO_FK = p_id_usuario;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_TARJETA_SP
-- DESCRIPCIÓN: Procedimiento para agregar tarjeta
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_TARJETA_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_AGREGAR_TARJETA_SP (
    IN  P_ID_USUARIO INT,
    IN  P_TIPO_TARJETA VARCHAR(10),       -- 'CREDITO' | 'DEBITO'
    IN  P_MARCA_TARJETA VARCHAR(20),      -- 'VISA','MASTERCARD','AMEX','DINERS','OTHER'
    IN  P_NOMBRE_TITULAR VARCHAR(255),
    IN  P_NUMERO_TARJETA VARCHAR(25),     -- PLANO, TRIGGER CIFRA
    IN  P_FECHA_VENC_YM CHAR(7),          -- 'YYYY-MM'
    IN  P_CVV VARCHAR(4),                 -- PLANO, TRIGGER CIFRA
    IN  P_ES_PREDETERMINADO TINYINT(1),
    IN  P_IP VARCHAR(45),
    OUT P_ID_TARJETA INT
)
MODIFIES SQL DATA
BEGIN
    DECLARE V_FECHA_VENC DATE;

    -- VALIDAR QUE EL USUARIO EXISTA
    IF (SELECT COUNT(*) FROM huellitas_usuarios_tb WHERE ID_USUARIO_PK = P_ID_USUARIO) = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '❌ ERROR: EL USUARIO NO EXISTE.';
    END IF;

    -- CONVERTIR 'YYYY-MM' EN EL ÚLTIMO DÍA DEL MES
    SET V_FECHA_VENC = LAST_DAY(STR_TO_DATE(CONCAT(P_FECHA_VENC_YM, '-01'), '%Y-%m-%d'));

    -- SI SERÁ LA TARJETA PREDETERMINADA, DESACTIVAR OTRAS DEL MISMO USUARIO
    IF P_ES_PREDETERMINADO = 1 THEN
        UPDATE huellitas_tarjetas_tb
        SET ES_PREDETERMINADO = 0
        WHERE ID_USUARIO_FK = P_ID_USUARIO;
    END IF;

    -- INSERTAR LA NUEVA TARJETA (EN TEXTO PLANO; TRIGGERS HARÁN LA ENCRIPTACIÓN)
    INSERT INTO huellitas_tarjetas_tb (
        ID_USUARIO_FK,
        TIPO_TARJETA,
        MARCA_TARJETA,
        NOMBRE_TITULAR,
        NUMERO_TARJETA_ENCRIPTADO,
        ULTIMOS_CUATRO_DIGITOS,
        FECHA_VENCIMIENTO,
        CVV_ENCRIPTADO,
        ES_PREDETERMINADO,
        ESTA_ACTIVO,
        IP_REGISTRO
    ) VALUES (
        P_ID_USUARIO,
        UPPER(P_TIPO_TARJETA),
        UPPER(P_MARCA_TARJETA),
        P_NOMBRE_TITULAR,
        P_NUMERO_TARJETA,
        RIGHT(P_NUMERO_TARJETA, 4),
        V_FECHA_VENC,
        P_CVV,
        P_ES_PREDETERMINADO,
        TRUE,
        P_IP
    );

    -- RETORNAR EL ID INSERTADO
    SET P_ID_TARJETA = LAST_INSERT_ID();
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_NOTIFICACION_SP
-- DESCRIPCIÓN: Inserta una notificación para un usuario específico.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_NOTIFICACION_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_AGREGAR_NOTIFICACION_SP(
    IN P_ID_USUARIO INT,
    IN P_TITULO VARCHAR(150),
    IN P_MENSAJE VARCHAR(1000),
    IN P_TIPO ENUM('SISTEMA','PEDIDO','CITA','PROMOCION','SEGURIDAD','OTRO'),
    IN P_PRIORIDAD ENUM('BAJA','MEDIA','ALTA')
)
BEGIN
    -- VALIDAR QUE EL USUARIO EXISTA
    IF (SELECT COUNT(*) FROM huellitas_usuarios_tb WHERE ID_USUARIO_PK = P_ID_USUARIO) = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '❌ ERROR: EL USUARIO NO EXISTE.';
    END IF;

    -- INSERTAR NUEVA NOTIFICACIÓN
    INSERT INTO huellitas_notificaciones_tb (
        ID_USUARIO_FK,
        ID_ESTADO_FK,
        TITULO_NOTIFICACION,
        MENSAJE_NOTIFICACION,
        TIPO_NOTIFICACION,
        PRIORIDAD
    ) VALUES (
        P_ID_USUARIO,
        1, -- ESTADO ACTIVO
        P_TITULO,
        P_MENSAJE,
        P_TIPO,
        P_PRIORIDAD
    );
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_NOTIFICACION_MASIVA_SP
-- DESCRIPCIÓN: Enviar notificaciones de forma global
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_NOTIFICACION_MASIVA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_NOTIFICACION_MASIVA_SP(
    IN P_ID_ESTADO INT,
    IN P_TITULO VARCHAR(150),
    IN P_MENSAJE VARCHAR(1000),
    IN P_TIPO VARCHAR(20),
    IN P_PRIORIDAD VARCHAR(10),
    IN P_URL_REDIRECCION VARCHAR(500)
)
BEGIN
    INSERT INTO HUELLITAS_NOTIFICACIONES_TB (
        ID_USUARIO_FK,
        ID_ESTADO_FK,
        TITULO_NOTIFICACION,
        MENSAJE_NOTIFICACION,
        TIPO_NOTIFICACION,
        PRIORIDAD,
        URL_REDIRECCION
    )
    SELECT
        U.ID_USUARIO_PK,
        P_ID_ESTADO,
        P_TITULO,
        P_MENSAJE,
        P_TIPO,
        P_PRIORIDAD,
        P_URL_REDIRECCION
    FROM HUELLITAS_USUARIOS_TB U
    WHERE U.ID_ESTADO_FK = 1; -- Solo usuarios activos

    SELECT ROW_COUNT() AS NOTIFICACIONES_GENERADAS;
END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_NOTIFICACION_SP
-- DESCRIPCIÓN: Procedimiento para obtener una notificación por ID
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_NOTIFICACION_POR_ID_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_NOTIFICACION_POR_ID_SP(
    IN P_ID_NOTIFICACION INT
)
BEGIN
    SELECT
        N.ID_NOTIFICACION_PK,
        N.ID_USUARIO_FK,
        N.ID_ESTADO_FK,
        N.TITULO_NOTIFICACION,
        N.MENSAJE_NOTIFICACION,
        N.TIPO_NOTIFICACION,
        N.PRIORIDAD,
        N.ES_LEIDA,
        N.URL_REDIRECCION,
        N.FECHA_CREACION,
        N.FECHA_LECTURA
    FROM HUELLITAS_NOTIFICACIONES_TB AS N
    WHERE N.ID_NOTIFICACION_PK = P_ID_NOTIFICACION;
END $$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_NOTIFICACIONES_SP
-- DESCRIPCIÓN: Procedimiento para obtener todas las notificaciones por usuario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_NOTIFICACIONES_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_OBTENER_NOTIFICACIONES_SP (
    IN P_ID_USUARIO INT
)
BEGIN
    SELECT 
        ID_NOTIFICACION_PK,
        TITULO_NOTIFICACION,
        MENSAJE_NOTIFICACION,
        FECHA_CREACION,
        ES_LEIDA,
        URL_REDIRECCION
    FROM huellitas_notificaciones_tb
    WHERE ID_USUARIO_FK = P_ID_USUARIO
      AND ES_LEIDA = FALSE
    ORDER BY FECHA_CREACION DESC
    LIMIT 10;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_NOTIFICACION_SP
-- DESCRIPCIÓN: Procedimiento para actualizar una notificación
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_NOTIFICACION_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_NOTIFICACION_SP(
    IN P_ID_NOTIFICACION INT,
    IN P_ID_ESTADO INT,
    IN P_TITULO VARCHAR(150),
    IN P_MENSAJE VARCHAR(1000),
    IN P_TIPO VARCHAR(20),
    IN P_PRIORIDAD VARCHAR(10),
    IN P_ES_LEIDA BOOLEAN,
    IN P_URL_REDIRECCION VARCHAR(500)
)
BEGIN
    UPDATE HUELLITAS_NOTIFICACIONES_TB
    SET 
        ID_ESTADO_FK = P_ID_ESTADO,
        TITULO_NOTIFICACION = P_TITULO,
        MENSAJE_NOTIFICACION = P_MENSAJE,
        TIPO_NOTIFICACION = P_TIPO,
        PRIORIDAD = P_PRIORIDAD,
        ES_LEIDA = P_ES_LEIDA,
        URL_REDIRECCION = P_URL_REDIRECCION,
        FECHA_LECTURA = CASE 
                            WHEN P_ES_LEIDA = TRUE AND FECHA_LECTURA IS NULL 
                                THEN NOW()
                            ELSE FECHA_LECTURA
                        END
    WHERE ID_NOTIFICACION_PK = P_ID_NOTIFICACION;

    SELECT ROW_COUNT() AS FILAS_AFECTADAS;
END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_CONTAR_NOTIFICACIONES_NO_LEIDAS_SP
-- DESCRIPCIÓN: Procedimiento para las notificaciones NO leídas
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_NOTIFICACIONES_NO_LEIDAS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_CONTAR_NOTIFICACIONES_NO_LEIDAS_SP (
    IN P_ID_USUARIO INT
)
BEGIN
    SELECT COUNT(*) AS total
    FROM huellitas_notificaciones_tb
    WHERE ID_USUARIO_FK = P_ID_USUARIO
    AND ES_LEIDA = FALSE;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_MARCAR_NOTIFICACION_LEIDA_SP
-- DESCRIPCIÓN: Procedimiento para marcar una notificación como leida.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_MARCAR_NOTIFICACION_LEIDA_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_MARCAR_NOTIFICACION_LEIDA_SP (
    IN P_ID_NOTIFICACION INT
)
BEGIN
    UPDATE huellitas_notificaciones_tb
    SET ES_LEIDA = TRUE,
        FECHA_LECTURA = NOW(),
        ID_ESTADO_FK = 2
    WHERE ID_NOTIFICACION_PK = P_ID_NOTIFICACION;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_MARCAR_TODAS_LEIDAS_SP
-- DESCRIPCIÓN: Procedimiento para marcar TODAS las notificaiones como leídas
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_MARCAR_TODAS_LEIDAS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_MARCAR_TODAS_LEIDAS_SP (
    IN P_ID_USUARIO INT
)
BEGIN
    UPDATE huellitas_notificaciones_tb
    SET ES_LEIDA = TRUE,
        FECHA_LECTURA = NOW(),
        ID_ESTADO_FK = 2
    WHERE ID_USUARIO_FK = P_ID_USUARIO
    AND ES_LEIDA = FALSE;
END //
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_SERVICIO_SP
-- DESCRIPCIÓN: Procedimiento para agregar un nuevo servicio veterinario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_SERVICIO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_AGREGAR_SERVICIO_SP (
    IN P_ID_ESTADO_FK INT,
    IN P_NOMBRE_SERVICIO VARCHAR(150),
    IN P_DESCRIPCION_SERVICIO VARCHAR(1000),
    IN P_IMAGEN_URL VARCHAR(500)
)
BEGIN
    -- VERIFICAR QUE EL ESTADO EXISTA
    IF (SELECT COUNT(*) FROM huellitas_estado_tb WHERE ID_ESTADO_PK = P_ID_ESTADO_FK) = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '❌ ERROR: EL ESTADO ESPECIFICADO NO EXISTE.';
    END IF;

    -- INSERTAR EL NUEVO SERVICIO
    INSERT INTO huellitas_servicios_tb (
        ID_ESTADO_FK,
        NOMBRE_SERVICIO,
        DESCRIPCION_SERVICIO,
        IMAGEN_URL
    )
    VALUES (
        P_ID_ESTADO_FK,
        P_NOMBRE_SERVICIO,
        P_DESCRIPCION_SERVICIO,
        P_IMAGEN_URL
    );

    -- CONFIRMAR CREACIÓN
    SELECT 
        '✅ SERVICIO AGREGADO CORRECTAMENTE' AS MENSAJE,
        LAST_INSERT_ID() AS ID_SERVICIO_CREADO;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_SERVICIO_SP
-- DESCRIPCIÓN: Procedimiento para actualizar la información de un servicio veterinario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_SERVICIO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_SERVICIO_SP (
    IN P_ID_SERVICIO_PK INT,
    IN P_ID_ESTADO_FK INT,
    IN P_NOMBRE_SERVICIO VARCHAR(150),
    IN P_DESCRIPCION_SERVICIO VARCHAR(1000),
    IN P_IMAGEN_URL VARCHAR(500)
)
BEGIN
    DECLARE V_EXISTE INT;

    -- VERIFICAR QUE EL SERVICIO EXISTA
    SELECT COUNT(*) INTO V_EXISTE
    FROM huellitas_servicios_tb
    WHERE ID_SERVICIO_PK = P_ID_SERVICIO_PK;

    IF V_EXISTE = 0 THEN
        SELECT '❌ ERROR: EL SERVICIO NO EXISTE' AS MENSAJE;
    ELSE
        -- VALIDAR QUE EL ESTADO EXISTA
        IF (SELECT COUNT(*) FROM huellitas_estado_tb WHERE ID_ESTADO_PK = P_ID_ESTADO_FK) = 0 THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '❌ ERROR: EL ESTADO ESPECIFICADO NO EXISTE.';
        END IF;

        -- ACTUALIZAR EL SERVICIO
        UPDATE huellitas_servicios_tb
        SET 
            ID_ESTADO_FK = P_ID_ESTADO_FK,
            NOMBRE_SERVICIO = P_NOMBRE_SERVICIO,
            DESCRIPCION_SERVICIO = P_DESCRIPCION_SERVICIO,
            IMAGEN_URL = P_IMAGEN_URL,
            FECHA_ACTUALIZACION = NOW()
        WHERE ID_SERVICIO_PK = P_ID_SERVICIO_PK;

        SELECT '✅ SERVICIO ACTUALIZADO CORRECTAMENTE' AS MENSAJE;
    END IF;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_SERVICIOS_SP
-- DESCRIPCIÓN: Procedimiento para listar todos los servicios de la veterinaria
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_SERVICIOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_SERVICIOS_SP()
BEGIN
    SELECT 
        S.ID_SERVICIO_PK,
        S.NOMBRE_SERVICIO,
        S.DESCRIPCION_SERVICIO,
        S.IMAGEN_URL,
        S.FECHA_CREACION,
        S.FECHA_ACTUALIZACION,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM huellitas_servicios_tb AS S
    INNER JOIN huellitas_estado_tb AS E 
        ON S.ID_ESTADO_FK = E.ID_ESTADO_PK
    ORDER BY S.ID_SERVICIO_PK ASC;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_SERVICIO_POR_ID_SP
-- DESCRIPCIÓN: Procedimiento para obtener un servicio veterinario por su ID
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_SERVICIO_POR_ID_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_OBTENER_SERVICIO_POR_ID_SP (
    IN P_ID_SERVICIO_PK INT
)
BEGIN
    -- VERIFICAR SI EL SERVICIO EXISTE
    IF EXISTS (SELECT 1 FROM huellitas_servicios_tb WHERE ID_SERVICIO_PK = P_ID_SERVICIO_PK) THEN
        SELECT 
            S.ID_SERVICIO_PK,
            S.NOMBRE_SERVICIO,
            S.DESCRIPCION_SERVICIO,
            S.IMAGEN_URL,
            S.FECHA_CREACION,
            S.FECHA_ACTUALIZACION,
            S.ID_ESTADO_FK,
            E.ESTADO_DESCRIPCION AS ESTADO
        FROM huellitas_servicios_tb AS S
        INNER JOIN huellitas_estado_tb AS E 
            ON S.ID_ESTADO_FK = E.ID_ESTADO_PK
        WHERE S.ID_SERVICIO_PK = P_ID_SERVICIO_PK;
    ELSE
        SELECT '❌ ERROR: EL SERVICIO NO EXISTE' AS MENSAJE;
    END IF;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_SERVICIOS_ACTIVOS_SP
-- DESCRIPCIÓN: Procedimiento para listar todos los servicios activos (ID_ESTADO_FK = 1)
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_SERVICIOS_ACTIVOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_LISTAR_SERVICIOS_ACTIVOS_SP()
BEGIN
    SELECT 
        S.ID_SERVICIO_PK,
        S.NOMBRE_SERVICIO,
        S.DESCRIPCION_SERVICIO,
        S.IMAGEN_URL,
        S.FECHA_CREACION,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM 
        huellitas_servicios_tb AS S
    INNER JOIN 
        huellitas_estado_tb AS E ON S.ID_ESTADO_FK = E.ID_ESTADO_PK
    WHERE 
        S.ID_ESTADO_FK = 1 -- SOLO SERVICIOS ACTIVOS
    ORDER BY 
        S.FECHA_CREACION DESC;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_CREAR_TOKEN_SP
-- DESCRIPCIÓN: Procedimiento para crear tokens
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CREAR_TOKEN_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_CREAR_TOKEN_SP(
    IN p_id_usuario INT,
    IN p_tipo ENUM('VERIFICACION','RECUPERACION','AUTENTICACION'),
    IN p_duracion_min INT,
    IN p_ip VARCHAR(45),
    IN p_dispositivo VARCHAR(200),
    OUT p_token VARCHAR(255)
)
BEGIN
    SET p_token = HEX(AES_ENCRYPT(UUID(), 'HUELLITAS_SECRET_KEY'));
    INSERT INTO huellitas_tokens_tb (
        ID_USUARIO_FK, TOKEN_VALOR, TIPO_TOKEN, FECHA_EXPIRA, IP_SOLICITUD, DISPOSITIVO
    )
    VALUES (
        p_id_usuario, p_token, p_tipo, DATE_ADD(NOW(), INTERVAL p_duracion_min MINUTE), p_ip, p_dispositivo
    );
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_VALIDAR_TOKEN_SP
-- DESCRIPCIÓN: Procedimiento para validar tokens
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_VALIDAR_TOKEN_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_VALIDAR_TOKEN_SP(
    IN p_token VARCHAR(255),
    IN p_tipo ENUM('VERIFICACION','RECUPERACION','AUTENTICACION')
)
BEGIN
    SELECT ID_USUARIO_FK
    FROM huellitas_tokens_tb
    WHERE TOKEN_VALOR = p_token
      AND TIPO_TOKEN = p_tipo
      AND USADO = FALSE
      AND FECHA_EXPIRA > NOW();
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_REESTABLECER_CONTRASENNA_SP
-- DESCRIPCIÓN: Permite cambiar la contraseña de un usuario usando token válido
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_REESTABLECER_CONTRASENNA_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_REESTABLECER_CONTRASENNA_SP(
    IN p_token VARCHAR(255),
    IN p_nueva_contrasenna VARCHAR(255)
)
BEGIN
    DECLARE v_id_usuario INT;

    -- Validar token activo y obtener usuario
    SELECT ID_USUARIO_FK INTO v_id_usuario
    FROM huellitas_tokens_tb
    WHERE TOKEN_VALOR = p_token
      AND TIPO_TOKEN = 'RECUPERACION'
      AND USADO = FALSE
      AND FECHA_EXPIRA > NOW()
    LIMIT 1;

    IF v_id_usuario IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = '❌ Token inválido o expirado.';
    ELSE
        -- Actualizar contraseña (el trigger se encarga de encriptarla)
        UPDATE huellitas_usuarios_tb
        SET USUARIO_CONTRASENNA = p_nueva_contrasenna
        WHERE ID_USUARIO_PK = v_id_usuario;

        -- Marcar token como usado
        UPDATE huellitas_tokens_tb
        SET USADO = TRUE
        WHERE TOKEN_VALOR = p_token;

        SELECT '✅ Contraseña restablecida correctamente' AS MENSAJE;
    END IF;
END//
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ADMIN_AGREGAR_USUARIO_SP
-- DESCRIPCIÓN: Procedimiento para agregar nuevos usuarios por parte del admin
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ADMIN_AGREGAR_USUARIO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ADMIN_AGREGAR_USUARIO_SP(
    IN p_nombre VARCHAR(100),
    IN p_email VARCHAR(100),
    IN p_password VARCHAR(255),
    IN p_id_estado INT,
    IN p_id_rol INT,
    IN p_identificacion INT,
    IN p_telefono VARCHAR(20)
)
BEGIN
    DECLARE v_id_telefono INT;

    -- VALIDAR EMAIL ÚNICO
    IF EXISTS (SELECT 1 FROM huellitas_usuarios_tb WHERE USUARIO_CORREO = p_email) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = '⚠️ El correo ya está registrado.';
    END IF;

    -- VALIDAR IDENTIFICACIÓN ÚNICA
    IF p_identificacion IS NOT NULL AND EXISTS (
        SELECT 1 FROM huellitas_usuarios_tb WHERE USUARIO_IDENTIFICACION = p_identificacion
    ) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = '⚠️ La identificación ya está registrada.';
    END IF;

    -- ✅ Insertar teléfono
    INSERT INTO huellitas_telefono_contacto_tb (ID_ESTADO_FK, TELEFONO_CONTACTO)
    VALUES (1, p_telefono);

    SET v_id_telefono = LAST_INSERT_ID();

    -- ✅ Insertar usuario con teléfono asignado
    INSERT INTO huellitas_usuarios_tb
    (
        USUARIO_NOMBRE,
        USUARIO_CORREO,
        USUARIO_CONTRASENNA,
        ID_ESTADO_FK,
        ID_ROL_USUARIO_FK,
        USUARIO_IDENTIFICACION,
        ID_TELEFONO_CONTACTO_FK
    )
    VALUES (
        p_nombre,
        p_email,
        p_password,
        p_id_estado,
        p_id_rol,
        p_identificacion,
        v_id_telefono
    );

END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_CONTAR_USUARIOS_SP
-- DESCRIPCIÓN: Contar todos los usuario existentes
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_USUARIOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CONTAR_USUARIOS_SP(
    IN p_query VARCHAR(100)
)
BEGIN
    SELECT 
        COUNT(*) AS TOTAL
    FROM 
        huellitas_usuarios_tb AS u
        INNER JOIN huellitas_rol_usuario_tb AS r 
            ON u.id_rol_usuario_fk = r.id_rol_usuario_pk
        INNER JOIN huellitas_estado_tb AS e 
            ON u.id_estado_fk = e.id_estado_pk
        LEFT JOIN huellitas_direccion_tb AS d 
            ON u.id_direccion_fk = d.id_direccion_pk
        LEFT JOIN huellitas_direccion_provincia_tb AS prov 
            ON d.id_direccion_provincia_fk = prov.id_direccion_provincia_pk
        LEFT JOIN huellitas_direccion_canton_tb AS cant 
            ON d.id_direccion_canton_fk = cant.id_direccion_canton_pk
        LEFT JOIN huellitas_direccion_distrito_tb AS dist 
            ON d.id_direccion_distrito_fk = dist.id_direccion_distrito_pk
    WHERE 
        u.usuario_nombre LIKE CONCAT('%', p_query, '%')
        OR u.usuario_correo LIKE CONCAT('%', p_query, '%')
        OR r.descripcion_rol_usuario LIKE CONCAT('%', p_query, '%')
        OR e.estado_descripcion LIKE CONCAT('%', p_query, '%')
        OR prov.nombre_provincia LIKE CONCAT('%', p_query, '%')
        OR cant.nombre_canton LIKE CONCAT('%', p_query, '%')
        OR dist.nombre_distrito LIKE CONCAT('%', p_query, '%');
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_ADMIN_ACTUALIZAR_USUARIO_SP
-- DESCRIPCIÓN: Procedimiento para actualizar usuarios por parte del admin
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ADMIN_ACTUALIZAR_USUARIO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ADMIN_ACTUALIZAR_USUARIO_SP(
    IN p_id INT,
    IN p_nombre VARCHAR(100),
    IN p_email VARCHAR(100),
    IN p_estado INT,
    IN p_rol INT,
    IN p_identificacion INT,
    IN p_telefono VARCHAR(20),
    IN p_password VARCHAR(255),
    IN p_imagen VARCHAR(500)
)
BEGIN
    DECLARE v_id_telefono INT;
    DECLARE v_current_password VARCHAR(255);
    DECLARE v_current_image VARCHAR(500);

    -- Obtener ID del teléfono actual
    SELECT ID_TELEFONO_CONTACTO_FK INTO v_id_telefono
    FROM huellitas_usuarios_tb
    WHERE ID_USUARIO_PK = p_id;

    -- ✅ Actualizar teléfono
    UPDATE huellitas_telefono_contacto_tb
    SET TELEFONO_CONTACTO = p_telefono
    WHERE ID_TELEFONO_CONTACTO_PK = v_id_telefono;

    -- ✅ Mantener contraseña si no se envió una nueva
    SELECT USUARIO_CONTRASENNA INTO v_current_password
    FROM huellitas_usuarios_tb WHERE ID_USUARIO_PK = p_id;

    IF p_password IS NULL OR p_password = '' THEN
        SET p_password = v_current_password;
    END IF;

    -- ✅ Mantener imagen si no se mandó nueva
    SELECT USUARIO_IMAGEN_URL INTO v_current_image
    FROM huellitas_usuarios_tb WHERE ID_USUARIO_PK = p_id;

    IF p_imagen IS NULL OR p_imagen = '' THEN
        SET p_imagen = v_current_image;
    END IF;

    -- ✅ Actualizar usuario
    UPDATE huellitas_usuarios_tb
    SET
        USUARIO_NOMBRE = p_nombre,
        USUARIO_CORREO = p_email,
        ID_ESTADO_FK = p_estado,
        ID_ROL_USUARIO_FK = p_rol,
        USUARIO_IDENTIFICACION = p_identificacion,
        USUARIO_IMAGEN_URL = p_imagen,
        USUARIO_CONTRASENNA = p_password
    WHERE ID_USUARIO_PK = p_id;
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_USUARIO_POR_ID_ADMIN_SP
-- DESCRIPCIÓN: Procedimiento para obtener usuarios meditante id por parte del admin
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ADMIN_OBTENER_USUARIO_POR_ID_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ADMIN_OBTENER_USUARIO_POR_ID_SP(
    IN p_idUsuario INT
)
BEGIN
    SELECT 
        u.ID_USUARIO_PK,
        u.USUARIO_NOMBRE,
        u.USUARIO_CORREO,
        u.USUARIO_IDENTIFICACION,
        u.USUARIO_IMAGEN_URL,
        u.ID_ROL_USUARIO_FK,
        r.DESCRIPCION_ROL_USUARIO AS ROL,
        u.ID_ESTADO_FK,
        e.ESTADO_DESCRIPCION AS ESTADO,
        u.ID_DIRECCION_FK,
        u.ID_TELEFONO_CONTACTO_FK,
        t.TELEFONO_CONTACTO AS USUARIO_TELEFONO,
        d.ID_DIRECCION_PROVINCIA_FK,
        prov.NOMBRE_PROVINCIA,
        d.ID_DIRECCION_CANTON_FK,
        cant.NOMBRE_CANTON,
        d.ID_DIRECCION_DISTRITO_FK,
        dist.NOMBRE_DISTRITO
    FROM huellitas_usuarios_tb u
    INNER JOIN huellitas_rol_usuario_tb r ON u.ID_ROL_USUARIO_FK = r.ID_ROL_USUARIO_PK
    INNER JOIN huellitas_estado_tb e ON u.ID_ESTADO_FK = e.ID_ESTADO_PK
    LEFT JOIN huellitas_telefono_contacto_tb t ON u.ID_TELEFONO_CONTACTO_FK = t.ID_TELEFONO_CONTACTO_PK
    LEFT JOIN huellitas_direccion_tb d ON u.ID_DIRECCION_FK = d.ID_DIRECCION_PK
    LEFT JOIN huellitas_direccion_provincia_tb prov ON d.ID_DIRECCION_PROVINCIA_FK = prov.ID_DIRECCION_PROVINCIA_PK
    LEFT JOIN huellitas_direccion_canton_tb cant ON d.ID_DIRECCION_CANTON_FK = cant.ID_DIRECCION_CANTON_PK
    LEFT JOIN huellitas_direccion_distrito_tb dist ON d.ID_DIRECCION_DISTRITO_FK = dist.ID_DIRECCION_DISTRITO_PK
    WHERE u.ID_USUARIO_PK = p_idUsuario;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_ROL_POR_ID_SP
-- DESCRIPCIÓN: Obtiene un rol según su ID
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_ROL_POR_ID_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_ROL_POR_ID_SP(
    IN p_id_rol INT
)
BEGIN
    SELECT *
    FROM huellitas_rol_usuario_tb
    WHERE ID_ROL_USUARIO_PK = p_id_rol;
END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_ROL_SP
-- DESCRIPCIÓN: Agrega un nuevo rol validando duplicados
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_ROL_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_AGREGAR_ROL_SP(
    IN p_descripcion VARCHAR(100),
    IN p_estado INT
)
BEGIN
    -- Validar si existe nombre repetido
    IF EXISTS(SELECT 1 FROM huellitas_rol_usuario_tb 
              WHERE DESCRIPCION_ROL_USUARIO = p_descripcion) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = '⚠️ Ya existe un rol con esa descripción.';
    END IF;

    INSERT INTO huellitas_rol_usuario_tb
    (DESCRIPCION_ROL_USUARIO, ID_ESTADO_FK)
    VALUES (p_descripcion, p_estado);

END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_ROL_SP
-- DESCRIPCIÓN: Actualiza un rol según ID
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_ROL_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_ROL_SP(
    IN p_id_rol INT,
    IN p_descripcion VARCHAR(100),
    IN p_estado INT
)
BEGIN
    -- Validar duplicado excepto mismo rol
    IF EXISTS (SELECT 1 FROM huellitas_rol_usuario_tb
               WHERE DESCRIPCION_ROL_USUARIO = p_descripcion
               AND ID_ROL_USUARIO_PK <> p_id_rol) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = '⚠️ La descripción del rol ya está en uso por otro rol.';
    END IF;

    UPDATE huellitas_rol_usuario_tb
    SET DESCRIPCION_ROL_USUARIO = p_descripcion,
        ID_ESTADO_FK = p_estado
    WHERE ID_ROL_USUARIO_PK = p_id_rol;

END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_CONTAR_ROLES_SP
-- DESCRIPCIÓN: Contar los roles existentes
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_ROLES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CONTAR_ROLES_SP(
    IN p_query VARCHAR(100)
)
BEGIN
    SELECT 
        COUNT(*) AS total
    FROM 
        huellitas_rol_usuario_tb AS r
        INNER JOIN huellitas_estado_tb AS e 
            ON r.ID_ESTADO_FK = e.ID_ESTADO_PK
    WHERE 
        r.DESCRIPCION_ROL_USUARIO LIKE CONCAT('%', p_query, '%')
        OR e.ESTADO_DESCRIPCION LIKE CONCAT('%', p_query, '%');
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_ROLES_ACTIVOS_SP
-- DESCRIPCIÓN: Lista únicamente los roles con estado activo
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_ROLES_ACTIVOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_ROLES_ACTIVOS_SP()
BEGIN
    SELECT 
        r.ID_ROL_USUARIO_PK,
        r.DESCRIPCION_ROL_USUARIO,
        r.ID_ESTADO_FK
    FROM 
        huellitas_rol_usuario_tb r
    INNER JOIN huellitas_estado_tb e 
        ON r.ID_ESTADO_FK = e.ID_ESTADO_PK
    WHERE 
        e.ESTADO_DESCRIPCION = 'Activo';
END $$
DELIMITER ;

-- ============================================================
-- NOMBRE: HUELLITAS_CONTAR_NOTIFICACIONES_ADMIN_SP
-- DESCRIPCIÓN: Retorna la cantidad total de notificaciones que coinciden con un término de búsqueda.
-- ============================================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_NOTIFICACIONES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CONTAR_NOTIFICACIONES_SP(
    IN P_SEARCH_TERM VARCHAR(150)
)
BEGIN
    SELECT 
        COUNT(*) AS TOTAL
    FROM 
        HUELLITAS_NOTIFICACIONES_TB AS N
        INNER JOIN HUELLITAS_ESTADO_TB AS E 
            ON N.ID_ESTADO_FK = E.ID_ESTADO_PK
        INNER JOIN HUELLITAS_USUARIOS_TB AS U
            ON N.ID_USUARIO_FK = U.ID_USUARIO_PK
    WHERE 
        N.TITULO_NOTIFICACION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR N.MENSAJE_NOTIFICACION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR N.TIPO_NOTIFICACION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR N.PRIORIDAD LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR E.ESTADO_DESCRIPCION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR U.USUARIO_NOMBRE LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR N.URL_REDIRECCION LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR DATE_FORMAT(N.FECHA_CREACION, '%d/%m/%Y %H:%i') LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR DATE_FORMAT(N.FECHA_LECTURA, '%d/%m/%Y %H:%i') LIKE CONCAT('%', P_SEARCH_TERM, '%');
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_PROVEEDOR_POR_ID_SP
-- DESCRIPCIÓN: Procedimiento para obtener proveedor mediante ID
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_PROVEEDOR_POR_ID_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_PROVEEDOR_POR_ID_SP(
    IN p_id_proveedor INT
)
BEGIN
    SELECT 
        P.ID_PROVEEDOR_PK,
        P.PROVEEDOR_NOMBRE,
        P.NOMBRE_REPRESENTANTE,
        P.PROVEEDOR_CORREO,
        P.PROVEEDOR_DESCRIPCION_PRODUCTOS,
        P.ID_ESTADO_FK,
        E.ESTADO_DESCRIPCION AS ESTADO,
        
        -- Teléfono
        COALESCE(T.TELEFONO_CONTACTO, 'NO REGISTRADO') AS TELEFONO_CONTACTO,

        -- Dirección completa
        COALESCE(D.DIRECCION_SENNAS, 'SIN DIRECCIÓN') AS DIRECCION,
        COALESCE(PROV.NOMBRE_PROVINCIA, '') AS PROVINCIA,
        COALESCE(CANT.NOMBRE_CANTON, '') AS CANTON,
        COALESCE(DIST.NOMBRE_DISTRITO, '') AS DISTRITO
        
    FROM huellitas_proveedores_tb P
    INNER JOIN huellitas_estado_tb E 
        ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
    LEFT JOIN huellitas_telefono_contacto_tb T 
        ON P.ID_TELEFONO_CONTACTO_FK = T.ID_TELEFONO_CONTACTO_PK
    LEFT JOIN huellitas_direccion_tb D 
        ON P.ID_DIRECCION_FK = D.ID_DIRECCION_PK
    LEFT JOIN huellitas_direccion_provincia_tb PROV 
        ON D.ID_DIRECCION_PROVINCIA_FK = PROV.ID_DIRECCION_PROVINCIA_PK
    LEFT JOIN huellitas_direccion_canton_tb CANT 
        ON D.ID_DIRECCION_CANTON_FK = CANT.ID_DIRECCION_CANTON_PK
    LEFT JOIN huellitas_direccion_distrito_tb DIST 
        ON D.ID_DIRECCION_DISTRITO_FK = DIST.ID_DIRECCION_DISTRITO_PK
    WHERE P.ID_PROVEEDOR_PK = p_id_proveedor;
END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_PRODUCTO_POR_ID_SP
-- DESCRIPCIÓN: Procedimiento para obtener producto mediante ID
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_PRODUCTO_POR_ID_SP;
DELIMITER $$

CREATE PROCEDURE HUELLITAS_OBTENER_PRODUCTO_POR_ID_SP(
    IN p_id_producto INT
)
BEGIN
    SELECT 
        P.ID_PRODUCTO_PK,
        P.PRODUCTO_NOMBRE,
        P.PRODUCTO_DESCRIPCION,
        P.PRODUCTO_PRECIO_UNITARIO,
        P.PRODUCTO_STOCK,
        P.IMAGEN_URL,
        P.FECHA_CREACION,
        
        -- Estado
        P.ID_ESTADO_FK,
        E.ESTADO_DESCRIPCION AS ESTADO,

        -- Proveedor
        P.ID_PROVEEDOR_FK,
        PROV.PROVEEDOR_NOMBRE,
        PROV.PROVEEDOR_CORREO,
        
        -- Categoría
        P.ID_CATEGORIA_FK,
        CAT.DESCRIPCION_CATEGORIA,

        -- Marca
        P.ID_MARCA_FK,
        M.NOMBRE_MARCA,
        M.MARCA_IMAGEN_URL,

        -- Nuevo o no
        P.ID_NUEVO_FK,
        N.NUEVO_DESCRIPCION AS NUEVO

    FROM huellitas_productos_tb P
    INNER JOIN huellitas_estado_tb E 
        ON P.ID_ESTADO_FK = E.ID_ESTADO_PK
    INNER JOIN huellitas_proveedores_tb PROV
        ON P.ID_PROVEEDOR_FK = PROV.ID_PROVEEDOR_PK
    INNER JOIN huellitas_productos_categoria_tb CAT
        ON P.ID_CATEGORIA_FK = CAT.ID_CATEGORIA_PK
    INNER JOIN huellitas_marcas_tb M
        ON P.ID_MARCA_FK = M.ID_MARCA_PK
    INNER JOIN huellitas_nuevo_tb N
        ON P.ID_NUEVO_FK = N.ID_NUEVO_PK
    WHERE P.ID_PRODUCTO_PK = p_id_producto;
END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_PROVINCIAS_SP
-- DESCRIPCIÓN: Procedimiento listar todas las provincias
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PROVINCIAS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_PROVINCIAS_SP()
BEGIN
    SELECT 
        ID_DIRECCION_PROVINCIA_PK,
        NOMBRE_PROVINCIA
    FROM huellitas_direccion_provincia_tb
    ORDER BY NOMBRE_PROVINCIA ASC;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_CANTONES_SP
-- DESCRIPCIÓN: Procedimiento listar todos los cantones
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_CANTONES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_CANTONES_SP()
BEGIN
    SELECT 
        ID_DIRECCION_CANTON_PK,
        ID_PROVINCIA_FK,
        NOMBRE_CANTON
    FROM huellitas_direccion_canton_tb
    ORDER BY NOMBRE_CANTON ASC;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_DISTRITOS_SP
-- DESCRIPCIÓN: Procedimiento listar todos los distritos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_DISTRITOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_DISTRITOS_SP()
BEGIN
    SELECT 
        ID_DIRECCION_DISTRITO_PK,
        ID_CANTON_FK,
        NOMBRE_DISTRITO
    FROM huellitas_direccion_distrito_tb
    ORDER BY NOMBRE_DISTRITO ASC;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_CANTONES_POR_PROVINCIA_SP
-- DESCRIPCIÓN: Procedimiento listar todos los "Cantones" por "Provincia"
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_CANTONES_POR_PROVINCIA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_CANTONES_POR_PROVINCIA_SP(IN p_idProvincia INT)
BEGIN
    SELECT 
        ID_DIRECCION_CANTON_PK,
        NOMBRE_CANTON
    FROM huellitas_direccion_canton_tb
    WHERE ID_PROVINCIA_FK = p_idProvincia
    ORDER BY NOMBRE_CANTON ASC;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_DISTRITOS_POR_CANTON_SP
-- DESCRIPCIÓN: Procedimiento listar todos los "Distritos" por "Canton"
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_DISTRITOS_POR_CANTON_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_DISTRITOS_POR_CANTON_SP(IN p_idCanton INT)
BEGIN
    SELECT 
        ID_DIRECCION_DISTRITO_PK,
        NOMBRE_DISTRITO
    FROM huellitas_direccion_distrito_tb
    WHERE ID_CANTON_FK = p_idCanton
      AND ID_ESTADO_FK = 1
    ORDER BY NOMBRE_DISTRITO ASC;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_AL_CARRITO_SP
-- DESCRIPCIÓN: Agrega o actualiza un producto en el carrito
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_AL_CARRITO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_AGREGAR_AL_CARRITO_SP(
    IN p_usuario_id INT,
    IN p_producto_id INT,
    IN p_cantidad INT
)
BEGIN
    DECLARE v_stock_actual INT DEFAULT 0;
    DECLARE v_cantidad_actual INT DEFAULT 0;
    DECLARE v_total_deseado INT DEFAULT 0;
    DECLARE v_mensaje VARCHAR(255);

    -- Obtener stock del producto
    SELECT PRODUCTO_STOCK INTO v_stock_actual
    FROM huellitas_productos_tb
    WHERE ID_PRODUCTO_PK = p_producto_id;

    -- Si no existe el producto
    IF v_stock_actual IS NULL THEN
        SET v_mensaje = 'El producto no existe.';
        SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = v_mensaje;
    END IF;

    -- Obtener cantidad actual en el carrito (si existe)
    SELECT CANTIDAD INTO v_cantidad_actual
    FROM huellitas_carrito_tb
    WHERE ID_USUARIO_FK = p_usuario_id
      AND ID_PRODUCTO_FK = p_producto_id;

    SET v_total_deseado = IFNULL(v_cantidad_actual, 0) + p_cantidad;

    -- Validar stock disponible
    IF v_total_deseado > v_stock_actual THEN
        SET v_mensaje = CONCAT('Stock insuficiente. Solo hay ', v_stock_actual, ' unidades disponibles.');
        SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = v_mensaje;
    END IF;

    -- Insertar o actualizar según corresponda
    IF EXISTS (
        SELECT 1
        FROM huellitas_carrito_tb
        WHERE ID_USUARIO_FK = p_usuario_id
          AND ID_PRODUCTO_FK = p_producto_id
    ) THEN
        UPDATE huellitas_carrito_tb
        SET CANTIDAD = v_total_deseado
        WHERE ID_USUARIO_FK = p_usuario_id
          AND ID_PRODUCTO_FK = p_producto_id;
    ELSE
        INSERT INTO huellitas_carrito_tb (ID_USUARIO_FK, ID_PRODUCTO_FK, CANTIDAD)
        VALUES (p_usuario_id, p_producto_id, p_cantidad);
    END IF;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_CARRITO_USUARIO_SP
-- DESCRIPCIÓN: Obtiene el carrito completo del usuario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_CARRITO_USUARIO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_CARRITO_USUARIO_SP(IN p_usuario_id INT)
BEGIN
    SELECT 
        c.ID_CARRITO_PK,
        p.ID_PRODUCTO_PK,
        p.PRODUCTO_NOMBRE,
        p.PRODUCTO_PRECIO_UNITARIO AS PRECIO_UNITARIO,
        p.IMAGEN_URL,
        c.CANTIDAD,
        (p.PRODUCTO_PRECIO_UNITARIO * c.CANTIDAD) AS SUBTOTAL
    FROM huellitas_carrito_tb c
    INNER JOIN huellitas_productos_tb p ON c.ID_PRODUCTO_FK = p.ID_PRODUCTO_PK
    WHERE c.ID_USUARIO_FK = p_usuario_id;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ELIMINAR_ITEM_CARRITO_SP
-- DESCRIPCIÓN: Eliminar producto del carrito
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ELIMINAR_ITEM_CARRITO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ELIMINAR_ITEM_CARRITO_SP(IN p_id_carrito INT)
BEGIN
    DELETE FROM huellitas_carrito_tb WHERE ID_CARRITO_PK = p_id_carrito;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_VACIAR_CARRITO_SP
-- DESCRIPCIÓN: Vaciar todos el carrito
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_VACIAR_CARRITO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_VACIAR_CARRITO_SP(IN p_usuario_id INT)
BEGIN
    DELETE FROM huellitas_carrito_tb WHERE ID_USUARIO_FK = p_usuario_id;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_CANTIDAD_CARRITO_SP
-- DESCRIPCIÓN: Actualizar la cantidad de un producto en el carrito
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_CANTIDAD_CARRITO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_CANTIDAD_CARRITO_SP(
    IN p_usuario_id INT,
    IN p_producto_id INT,
    IN p_nueva_cantidad INT
)
BEGIN
    DECLARE v_stock_actual INT DEFAULT 0;
    DECLARE v_mensaje VARCHAR(255);

    -- Verificar existencia y stock
    SELECT PRODUCTO_STOCK INTO v_stock_actual
    FROM huellitas_productos_tb
    WHERE ID_PRODUCTO_PK = p_producto_id;

    IF v_stock_actual IS NULL THEN
        SET v_mensaje = 'El producto no existe.';
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = v_mensaje;
    END IF;

    IF p_nueva_cantidad > v_stock_actual THEN
        SET v_mensaje = CONCAT('Stock insuficiente. Solo hay ', v_stock_actual, ' unidades disponibles.');
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = v_mensaje;
    END IF;

    -- Actualizar cantidad directamente
    UPDATE huellitas_carrito_tb
    SET CANTIDAD = p_nueva_cantidad
    WHERE ID_USUARIO_FK = p_usuario_id AND ID_PRODUCTO_FK = p_producto_id;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_CALCULAR_TOTAL_CARRITO_SP
-- DESCRIPCIÓN: Calcula subtotal, IVA y total del carrito de un usuario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CALCULAR_TOTAL_CARRITO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CALCULAR_TOTAL_CARRITO_SP(
    IN p_usuario_id INT,
    IN p_costo_envio DECIMAL(10,2)
)
BEGIN
    DECLARE v_subtotal DECIMAL(10,2) DEFAULT 0.00;
    DECLARE v_iva DECIMAL(10,2) DEFAULT 0.00;
    DECLARE v_total DECIMAL(10,2) DEFAULT 0.00;
    DECLARE v_iva_porcentaje DECIMAL(5,2) DEFAULT 0.13;

    -- Calcular subtotal
    SELECT 
        IFNULL(SUM(p.PRODUCTO_PRECIO_UNITARIO * c.CANTIDAD), 0)
    INTO v_subtotal
    FROM huellitas_carrito_tb c
    INNER JOIN huellitas_productos_tb p 
        ON c.ID_PRODUCTO_FK = p.ID_PRODUCTO_PK
    WHERE c.ID_USUARIO_FK = p_usuario_id;

    -- Calcular IVA
    SET v_iva = v_subtotal * v_iva_porcentaje;

    -- Calcular total final
    SET v_total = v_subtotal + v_iva + p_costo_envio;

    -- Retornar resultados
    SELECT 
        v_subtotal AS SUBTOTAL,
        v_iva AS IVA,
        p_costo_envio AS ENVIO,
        v_total AS TOTAL_FINAL;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_PROCESAR_CHECKOUT_SP
-- DESCRIPCIÓN: Procesa el checkout completo (pedido, detalle, pago, stock, notificación)
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_PROCESAR_CHECKOUT_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_PROCESAR_CHECKOUT_SP(
    IN p_usuario_id INT,
    IN p_envio_provincia VARCHAR(100),
    IN p_envio_canton VARCHAR(100),
    IN p_envio_distrito VARCHAR(100),
    IN p_envio_sennas VARCHAR(255),
    IN p_metodo_pago VARCHAR(20),
    IN p_tarjeta_id INT,
    IN p_costo_envio DECIMAL(10,2),
    OUT p_pedido_id INT,
    OUT p_codigo_pedido VARCHAR(30)
)
BEGIN
    DECLARE v_total DECIMAL(10,2);
    DECLARE v_subtotal DECIMAL(10,2);
    DECLARE v_iva DECIMAL(10,2);
    DECLARE v_estado_pago VARCHAR(30);

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;

    START TRANSACTION;

    -- Calcular totales
    SELECT 
        IFNULL(SUM(p.PRODUCTO_PRECIO_UNITARIO * c.CANTIDAD), 0),
        IFNULL(SUM(p.PRODUCTO_PRECIO_UNITARIO * c.CANTIDAD) * 0.13, 0),
        IFNULL(SUM(p.PRODUCTO_PRECIO_UNITARIO * c.CANTIDAD) * 1.13 + p_costo_envio, p_costo_envio)
    INTO v_subtotal, v_iva, v_total
    FROM HUELLITAS_CARRITO_TB c
    INNER JOIN HUELLITAS_PRODUCTOS_TB p 
        ON c.ID_PRODUCTO_FK = p.ID_PRODUCTO_PK
    WHERE c.ID_USUARIO_FK = p_usuario_id;

    IF v_subtotal = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'El carrito está vacío.';
    END IF;

    IF EXISTS (
        SELECT 1 FROM HUELLITAS_CARRITO_TB c
        JOIN HUELLITAS_PRODUCTOS_TB p ON p.ID_PRODUCTO_PK = c.ID_PRODUCTO_FK
        WHERE c.ID_USUARIO_FK = p_usuario_id
        AND p.PRODUCTO_STOCK < c.CANTIDAD
    ) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Stock insuficiente para uno o más productos.';
    END IF;

    -- Crear pedido
    INSERT INTO HUELLITAS_PEDIDOS_TB (
        ID_USUARIO_FK, ID_ESTADO_FK, TOTAL,
        ENVIO_PROVINCIA, ENVIO_CANTON, ENVIO_DISTRITO, ENVIO_SENNAS
    ) VALUES (
        p_usuario_id, 3, v_total,
        p_envio_provincia, p_envio_canton, p_envio_distrito, p_envio_sennas
    );

    SET p_pedido_id = LAST_INSERT_ID();

    -- Generar código legible
    SET p_codigo_pedido = CONCAT(
        'HD-', DATE_FORMAT(NOW(), '%Y%m%d'), '-', p_pedido_id
    );

    UPDATE HUELLITAS_PEDIDOS_TB
    SET CODIGO_PEDIDO = p_codigo_pedido
    WHERE ID_PEDIDO_PK = p_pedido_id;

    -- Insertar detalle
    INSERT INTO HUELLITAS_PEDIDOS_DETALLE_TB (ID_PEDIDO_FK, ID_PRODUCTO_FK, CANTIDAD, PRECIO_UNITARIO)
    SELECT p_pedido_id, c.ID_PRODUCTO_FK, c.CANTIDAD, p.PRODUCTO_PRECIO_UNITARIO
    FROM HUELLITAS_CARRITO_TB c
    INNER JOIN HUELLITAS_PRODUCTOS_TB p ON p.ID_PRODUCTO_PK = c.ID_PRODUCTO_FK
    WHERE c.ID_USUARIO_FK = p_usuario_id;

	IF p_metodo_pago = 'TARJETA' THEN
		SET v_estado_pago = 'EN REVISIÓN';
	ELSEIF p_metodo_pago = 'PAYPAL' THEN
		SET v_estado_pago = 'PAGADO';
	ELSEIF p_metodo_pago = 'TRANSFERENCIA' THEN
		SET v_estado_pago = 'EN REVISIÓN';
	ELSEIF p_metodo_pago = 'EFECTIVO' THEN
		SET v_estado_pago = 'PENDIENTE DE PAGO';
	ELSE
		SET v_estado_pago = 'EN REVISIÓN';
	END IF;

    -- Insertar pago
    INSERT INTO HUELLITAS_PAGOS_TB (ID_PEDIDO_FK, ID_TARJETA_FK, METODO_PAGO, MONTO, ESTADO_PAGO)
    VALUES (
		p_pedido_id,
		NULLIF(p_tarjeta_id, 0),
		p_metodo_pago,
		v_total,
		v_estado_pago
    );

    -- Actualizar stock
    UPDATE HUELLITAS_PRODUCTOS_TB p
    JOIN HUELLITAS_CARRITO_TB c ON p.ID_PRODUCTO_PK = c.ID_PRODUCTO_FK
    SET p.PRODUCTO_STOCK = p.PRODUCTO_STOCK - c.CANTIDAD
    WHERE c.ID_USUARIO_FK = p_usuario_id;

    -- Vaciar carrito
    DELETE FROM HUELLITAS_CARRITO_TB WHERE ID_USUARIO_FK = p_usuario_id;

    -- Notificación
    INSERT INTO HUELLITAS_NOTIFICACIONES_TB (
        ID_USUARIO_FK, ID_ESTADO_FK, TITULO_NOTIFICACION, MENSAJE_NOTIFICACION, TIPO_NOTIFICACION
    ) VALUES (
        p_usuario_id, 1, 'Compra confirmada',
        CONCAT('Tu pedido ', p_codigo_pedido, ' se registró correctamente.'),
        'PEDIDO'
    );

    COMMIT;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_SUBIR_COMPROBANTE_PAGO_SP
-- DESCRIPCIÓN: Procedimiento para almacenar comprobantes de pago
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_SUBIR_COMPROBANTE_PAGO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_SUBIR_COMPROBANTE_PAGO_SP(
    IN P_ID_PEDIDO INT,
    IN P_ID_USUARIO INT,
    IN P_URL_COMPROBANTE VARCHAR(1000)
)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 0 AS EXITO, '❌ Error inesperado al registrar comprobante' AS MENSAJE;
    END;

    START TRANSACTION;

    -- Insertar el comprobante
    INSERT INTO HUELLITAS_COMPROBANTES_PAGO_TB (
        ID_PEDIDO_FK,
        ID_USUARIO_FK,
        URL_COMPROBANTE,
        ESTADO_VERIFICACION,
        FECHA_SUBIDA
    )
    VALUES (
        P_ID_PEDIDO,
        P_ID_USUARIO,
        P_URL_COMPROBANTE,
        'EN REVISIÓN',
        NOW()
    );

    -- Cambiar estado del pago a "EN REVISIÓN"
    UPDATE HUELLITAS_PAGOS_TB
    SET ESTADO_PAGO = 'EN REVISIÓN'
    WHERE ID_PEDIDO_FK = P_ID_PEDIDO;

    COMMIT;

    SELECT 1 AS EXITO,
           '📄 Comprobante registrado correctamente. El pago está en revisión.' AS MENSAJE;
END //
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_SUBIR_NUEVO_COMPROBANTE_SP
-- DESCRIPCIÓN: Procedimiento subir un nuevo comprobante de pago en caso de que el pago sea rechazado
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_SUBIR_NUEVO_COMPROBANTE_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_SUBIR_NUEVO_COMPROBANTE_SP(
    IN p_codigo_pedido VARCHAR(30),
    IN p_usuario_id INT,
    IN p_url_comprobante VARCHAR(1000)
)
BEGIN
    DECLARE v_pedido_id INT DEFAULT NULL;
    DECLARE v_metodo_pago VARCHAR(30) DEFAULT NULL;
    DECLARE v_ultimo_estado VARCHAR(30) DEFAULT NULL;
    DECLARE v_intentos INT DEFAULT 0;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION 
    BEGIN
        ROLLBACK;
        SELECT 0 AS EXITO, '❌ Error inesperado al subir el comprobante.' AS MENSAJE;
    END;

    START TRANSACTION;

    -- ============================================
    -- 1. VALIDAR QUE EL PEDIDO EXISTE Y ES DEL USUARIO
    -- ============================================
    SELECT ID_PEDIDO_PK
    INTO v_pedido_id
    FROM HUELLITAS_PEDIDOS_TB
    WHERE CODIGO_PEDIDO = p_codigo_pedido
      AND ID_USUARIO_FK = p_usuario_id
    LIMIT 1;

    IF v_pedido_id IS NULL THEN
        ROLLBACK;
        SELECT 0 AS EXITO, '❌ El pedido no existe o no pertenece al usuario.' AS MENSAJE;
        COMMIT;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'END';
    END IF;

    -- ============================================
    -- 2. VALIDAR QUE EL MÉTODO DE PAGO SEA TRANSFERENCIA
    -- ============================================
    SELECT METODO_PAGO
    INTO v_metodo_pago
    FROM HUELLITAS_PAGOS_TB
    WHERE ID_PEDIDO_FK = v_pedido_id
    LIMIT 1;

    IF v_metodo_pago <> 'TRANSFERENCIA' THEN
        ROLLBACK;
        SELECT 0 AS EXITO, '❌ Este pedido no utiliza pago por transferencia.' AS MENSAJE;
        COMMIT;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'END';
    END IF;

    -- ============================================
    -- 3. OBTENER EL ÚLTIMO COMPROBANTE SUBIDO
    -- ============================================
    SELECT ESTADO_VERIFICACION, INTENTOS
    INTO v_ultimo_estado, v_intentos
    FROM HUELLITAS_COMPROBANTES_PAGO_TB
    WHERE ID_PEDIDO_FK = v_pedido_id
    ORDER BY ID_COMPROBANTE_PK DESC
    LIMIT 1;

    -- Si no hay comprobante (caso raro)
    IF v_ultimo_estado IS NULL THEN
        SET v_ultimo_estado = 'RECHAZADO';
        SET v_intentos = 0;
    END IF;

    -- ============================================
    -- 4. VALIDAR QUE ÚLTIMO ESTADO = RECHAZADO
    -- ============================================
    IF v_ultimo_estado <> 'RECHAZADO' THEN
        ROLLBACK;
        SELECT 0 AS EXITO, '❌ No puedes subir un nuevo comprobante hasta que el anterior sea rechazado.' AS MENSAJE;
        COMMIT;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'END';
    END IF;

    -- ============================================
    -- 5. VALIDAR LÍMITE DE INTENTOS
    -- ============================================
    IF v_intentos >= 3 THEN
        ROLLBACK;
        SELECT 0 AS EXITO, '❌ Límite máximo de intentos alcanzado (3). Contacte soporte.' AS MENSAJE;
        COMMIT;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'END';
    END IF;

    -- ============================================
    -- 6. INSERTAR NUEVO COMPROBANTE
    -- ============================================
    INSERT INTO HUELLITAS_COMPROBANTES_PAGO_TB (
        ID_PEDIDO_FK,
        ID_USUARIO_FK,
        URL_COMPROBANTE,
        ESTADO_VERIFICACION,
        INTENTOS
    )
    VALUES (
        v_pedido_id,
        p_usuario_id,
        p_url_comprobante,
        'EN REVISIÓN',
        v_intentos + 1
    );

    -- ============================================
    -- 7. CAMBIAR ESTADO DE PAGO A "EN REVISIÓN"
    -- ============================================
    UPDATE HUELLITAS_PAGOS_TB
    SET ESTADO_PAGO = 'EN REVISIÓN'
    WHERE ID_PEDIDO_FK = v_pedido_id;

    COMMIT;

    SELECT 1 AS EXITO,
           '✅ Comprobante enviado correctamente. Será revisado por un administrador.' AS MENSAJE;

END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_ULTIMO_COMPROBANTE_SP
-- DESCRIPCIÓN: Procedimiento obtener el ultmo comprobante de pago subido por el cliente
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_ULTIMO_COMPROBANTE_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_ULTIMO_COMPROBANTE_SP(
    IN p_codigo_pedido VARCHAR(30)
)
BEGIN
    SELECT 
        cp.ID_COMPROBANTE_PK,
        cp.ID_PEDIDO_FK,
        cp.ID_USUARIO_FK,
        cp.URL_COMPROBANTE,
        cp.FECHA_SUBIDA,
        cp.ESTADO_VERIFICACION,
        cp.OBSERVACIONES_ADMIN,
        cp.INTENTOS
    FROM HUELLITAS_COMPROBANTES_PAGO_TB cp
    INNER JOIN HUELLITAS_PEDIDOS_TB p 
        ON p.ID_PEDIDO_PK = cp.ID_PEDIDO_FK
    WHERE p.CODIGO_PEDIDO = p_codigo_pedido
    ORDER BY cp.ID_COMPROBANTE_PK DESC
    LIMIT 1;
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_COMPROBANTE_PAGO_SP
-- DESCRIPCIÓN: Procedimiento obtener el comprobante de pago de un pedido
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_COMPROBANTE_PAGO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_COMPROBANTE_PAGO_SP(
    IN p_codigo_pedido VARCHAR(30)
)
BEGIN
    DECLARE v_id_pedido INT DEFAULT 0;

    -- 1️⃣ Obtener ID del pedido
    SELECT ID_PEDIDO_PK
    INTO v_id_pedido
    FROM HUELLITAS_PEDIDOS_TB
    WHERE CODIGO_PEDIDO = p_codigo_pedido;

    -- Si no existe el pedido
    IF v_id_pedido IS NULL OR v_id_pedido = 0 THEN
        SELECT 
            0 AS EXITO,
            '❌ El código de pedido no existe.' AS MENSAJE,
            NULL AS ID_COMPROBANTE_PK,
            NULL AS URL_COMPROBANTE,
            NULL AS ESTADO_VERIFICACION,
            NULL AS FECHA_SUBIDA,
            NULL AS OBSERVACIONES_ADMIN,
            NULL AS METODO_PAGO,
            NULL AS MONTO,
            NULL AS ESTADO_PAGO,
            NULL AS USUARIO_NOMBRE,
            NULL AS USUARIO_CORREO;
    ELSE
        -- 2️⃣ Mostrar datos del comprobante y del pago
        SELECT 
            1 AS EXITO,
            '✔ Datos del comprobante encontrados.' AS MENSAJE,

            c.ID_COMPROBANTE_PK,
            c.URL_COMPROBANTE,
            c.ESTADO_VERIFICACION,
            c.FECHA_SUBIDA,
            c.OBSERVACIONES_ADMIN,

            p.METODO_PAGO,
            p.MONTO,
            p.ESTADO_PAGO,

            u.USUARIO_NOMBRE,
            u.USUARIO_CORREO

        FROM HUELLITAS_PEDIDOS_TB pd
        LEFT JOIN HUELLITAS_PAGOS_TB p 
            ON p.ID_PEDIDO_FK = pd.ID_PEDIDO_PK
        LEFT JOIN HUELLITAS_COMPROBANTES_PAGO_TB c 
            ON c.ID_PEDIDO_FK = pd.ID_PEDIDO_PK
        LEFT JOIN HUELLITAS_USUARIOS_TB u 
            ON u.ID_USUARIO_PK = pd.ID_USUARIO_FK
        WHERE pd.ID_PEDIDO_PK = v_id_pedido
        ORDER BY c.ID_COMPROBANTE_PK DESC
        LIMIT 1;
    END IF;

END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_COMPROBANTE_PAGO_SP
-- DESCRIPCIÓN: Procedimiento verificar el comprobante de pago.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_COMPROBANTE_PAGO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_COMPROBANTE_PAGO_SP(
    IN p_codigo_pedido    VARCHAR(30),
    IN p_estado_id        INT,           -- ID_ESTADO_PK (ej: Aprobado / Rechazado / En revisión)
    IN p_observaciones    VARCHAR(500),
    OUT p_exito           INT,
    OUT p_mensaje         VARCHAR(255)
)
BEGIN
    DECLARE v_pedido_id          INT DEFAULT NULL;
    DECLARE v_comprobante_id     INT DEFAULT NULL;
    DECLARE v_estado_texto       VARCHAR(100) DEFAULT NULL;
    DECLARE v_nuevo_estado_pago  VARCHAR(20) DEFAULT NULL;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION 
    BEGIN
        ROLLBACK;
        SET p_exito   = 0;
        SET p_mensaje = '❌ Error inesperado al actualizar el comprobante.';
    END;

    START TRANSACTION;

    -- 1. Obtener ID del pedido
    SELECT ID_PEDIDO_PK
    INTO v_pedido_id
    FROM HUELLITAS_PEDIDOS_TB
    WHERE CODIGO_PEDIDO = p_codigo_pedido
    LIMIT 1;

    IF v_pedido_id IS NULL THEN
        ROLLBACK;
        SET p_exito   = 0;
        SET p_mensaje = '❌ Pedido no encontrado para el código indicado.';
    ELSE

        -- 2. Obtener el último comprobante de ese pedido
        SELECT ID_COMPROBANTE_PK
        INTO v_comprobante_id
        FROM HUELLITAS_COMPROBANTES_PAGO_TB
        WHERE ID_PEDIDO_FK = v_pedido_id
        ORDER BY ID_COMPROBANTE_PK DESC
        LIMIT 1;

        IF v_comprobante_id IS NULL THEN
            ROLLBACK;
            SET p_exito   = 0;
            SET p_mensaje = '❌ No existe comprobante para este pedido.';
        ELSE

            -- 3. Traducir ID_ESTADO_PK → texto (EN REVISIÓN / APROBADO / RECHAZADO)
            SELECT UPPER(ESTADO_DESCRIPCION)
            INTO v_estado_texto
            FROM HUELLITAS_ESTADO_TB
            WHERE ID_ESTADO_PK = p_estado_id
            LIMIT 1;

            IF v_estado_texto IS NULL THEN
                ROLLBACK;
                SET p_exito   = 0;
                SET p_mensaje = '❌ Estado de comprobante inválido.';
            ELSE
                -- 4. Actualizar comprobante
                UPDATE HUELLITAS_COMPROBANTES_PAGO_TB
                SET ESTADO_VERIFICACION = v_estado_texto,
                    OBSERVACIONES_ADMIN = p_observaciones
                WHERE ID_COMPROBANTE_PK = v_comprobante_id;

                -- 5. Ajustar estado de pago según el comprobante
                IF v_estado_texto = 'APROBADO' THEN
                    SET v_nuevo_estado_pago = 'PAGADO';
                ELSEIF v_estado_texto = 'RECHAZADO' THEN
                    SET v_nuevo_estado_pago = 'RECHAZADO';
                ELSE
                    SET v_nuevo_estado_pago = 'EN REVISIÓN';
                END IF;

                UPDATE HUELLITAS_PAGOS_TB
                SET ESTADO_PAGO = v_nuevo_estado_pago
                WHERE ID_PEDIDO_FK = v_pedido_id;

                COMMIT;
                SET p_exito   = 1;
                SET p_mensaje = '✅ Comprobante actualizado correctamente.';
            END IF;
        END IF;
    END IF;
END $$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_PEDIDOS_USUARIO_PAG_SP
-- DESCRIPCIÓN: Obtiene pedidos de un usuario con paginación, incluyendo estado de pago
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PEDIDOS_USUARIO_PAG_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_PEDIDOS_USUARIO_PAG_SP(
    IN p_usuario_id INT,
    IN p_limit INT,
    IN p_offset INT
)
BEGIN
    SELECT 
        p.ID_PEDIDO_PK,
        p.CODIGO_PEDIDO,
        p.TOTAL,
        p.FECHA_PEDIDO,
        est.ESTADO_DESCRIPCION AS ESTADO,

        -- ============================
        -- ESTADO DE PAGO (último pago)
        -- ============================
        (
            SELECT pg.ESTADO_PAGO
            FROM HUELLITAS_PAGOS_TB pg
            WHERE pg.ID_PEDIDO_FK = p.ID_PEDIDO_PK
            ORDER BY pg.FECHA_PAGO DESC
            LIMIT 1
        ) AS ESTADO_PAGO

    FROM HUELLITAS_PEDIDOS_TB p
    INNER JOIN HUELLITAS_ESTADO_TB est 
        ON est.ID_ESTADO_PK = p.ID_ESTADO_FK
    WHERE p.ID_USUARIO_FK = p_usuario_id
    ORDER BY p.FECHA_PEDIDO DESC
    LIMIT p_limit OFFSET p_offset;
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_CONTAR_PEDIDOS_USUARIO_SP
-- DESCRIPCIÓN: contar total de pedidos por usuario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_PEDIDOS_USUARIO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CONTAR_PEDIDOS_USUARIO_SP(IN p_usuario_id INT)
BEGIN
    SELECT COUNT(*) AS total
    FROM HUELLITAS_PEDIDOS_TB
    WHERE ID_USUARIO_FK = p_usuario_id;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_DETALLE_PEDIDO_SP
-- DESCRIPCIÓN: Obtiene los datos completos de un pedido y sus productos
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_DETALLE_PEDIDO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_DETALLE_PEDIDO_SP(IN p_codigo VARCHAR(50))
BEGIN
    -- Información general del pedido
    SELECT 
        p.ID_PEDIDO_PK,
        p.CODIGO_PEDIDO,
        p.FECHA_PEDIDO,
        p.TOTAL,
        p.ENVIO_PROVINCIA,
        p.ENVIO_CANTON,
        p.ENVIO_DISTRITO,
        p.ENVIO_SENNAS,
        e.ESTADO_DESCRIPCION AS ESTADO_PEDIDO,
        pg.METODO_PAGO,
        pg.MONTO AS MONTO_PAGO,
        pg.ESTADO_PAGO,
        p.ID_USUARIO_FK,
        u.USUARIO_NOMBRE,
        u.USUARIO_CORREO
    FROM HUELLITAS_PEDIDOS_TB p
    INNER JOIN HUELLITAS_ESTADO_TB e ON e.ID_ESTADO_PK = p.ID_ESTADO_FK
    INNER JOIN HUELLITAS_USUARIOS_TB u ON u.ID_USUARIO_PK = p.ID_USUARIO_FK
    LEFT JOIN HUELLITAS_PAGOS_TB pg ON pg.ID_PEDIDO_FK = p.ID_PEDIDO_PK
    WHERE p.CODIGO_PEDIDO = p_codigo;

    -- Detalle de productos del pedido
    SELECT 
        d.ID_PEDIDO_DETALLE_PK,
        pr.PRODUCTO_NOMBRE,
        pr.IMAGEN_URL,
        d.CANTIDAD,
        d.PRECIO_UNITARIO,
        d.SUBTOTAL
    FROM HUELLITAS_PEDIDOS_DETALLE_TB d
    INNER JOIN HUELLITAS_PRODUCTOS_TB pr ON pr.ID_PRODUCTO_PK = d.ID_PRODUCTO_FK
    INNER JOIN HUELLITAS_PEDIDOS_TB p ON p.ID_PEDIDO_PK = d.ID_PEDIDO_FK
    WHERE p.CODIGO_PEDIDO = p_codigo;
END$$
DELIMITER ;



-- ==========================================
-- NOMBRE: HUELLITAS_CONTAR_PEDIDOS_SP
-- DESCRIPCIÓN: Contar todos los pedidos existentes
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_PEDIDOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CONTAR_PEDIDOS_SP(IN P_SEARCH_TERM VARCHAR(100))
BEGIN
    SELECT COUNT(*) AS TOTAL
    FROM huellitas_pedidos_tb AS p
    INNER JOIN huellitas_usuarios_tb AS u 
        ON p.id_usuario_fk = u.id_usuario_pk
    INNER JOIN huellitas_estado_tb AS e 
        ON p.id_estado_fk = e.id_estado_pk
    LEFT JOIN huellitas_pagos_tb AS pg 
        ON pg.id_pedido_fk = p.id_pedido_pk
    WHERE 
        p.codigo_pedido LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR u.usuario_nombre LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR u.usuario_correo LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR e.estado_descripcion LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR pg.metodo_pago LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR pg.estado_pago LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR p.envio_provincia LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR p.envio_canton LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR p.envio_distrito LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR DATE_FORMAT(p.fecha_pedido, '%Y-%m-%d') LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR CAST(p.total AS CHAR) LIKE CONCAT('%', P_SEARCH_TERM, '%');
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_BUSCAR_ORDENES_ADMIN_SP
-- DESCRIPCIÓN: Procedimiento para buscar ordenes
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_BUSCAR_PEDIDOS_ADMIN_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_BUSCAR_PEDIDOS_ADMIN_SP(
    IN P_SEARCH_TERM VARCHAR(100),
    IN P_LIMIT_ROWS INT,
    IN P_OFFSET_ROWS INT
)
BEGIN
    SELECT 
		p.ID_PEDIDO_PK,
        p.codigo_pedido AS CODIGO_PEDIDO,
        u.usuario_nombre AS CLIENTE,
        u.usuario_correo AS CORREO,
        e.estado_descripcion AS ESTADO_PEDIDO,
        p.fecha_pedido AS FECHA_PEDIDO,
        p.total AS TOTAL,
        CONCAT(p.envio_provincia, ', ', p.envio_canton, ', ', p.envio_distrito) AS DIRECCION_ENVIO,
        pg.metodo_pago AS METODO_PAGO,
        pg.estado_pago AS ESTADO_PAGO
    FROM huellitas_pedidos_tb AS p
    INNER JOIN huellitas_usuarios_tb AS u 
        ON p.id_usuario_fk = u.id_usuario_pk
    INNER JOIN huellitas_estado_tb AS e 
        ON p.id_estado_fk = e.id_estado_pk
    LEFT JOIN huellitas_pagos_tb AS pg 
        ON pg.id_pedido_fk = p.id_pedido_pk
    WHERE 
        p.codigo_pedido LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR u.usuario_nombre LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR u.usuario_correo LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR e.estado_descripcion LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR pg.metodo_pago LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR pg.estado_pago LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR p.envio_provincia LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR p.envio_canton LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR p.envio_distrito LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR DATE_FORMAT(p.fecha_pedido, '%Y-%m-%d') LIKE CONCAT('%', P_SEARCH_TERM, '%')
        OR CAST(p.total AS CHAR) LIKE CONCAT('%', P_SEARCH_TERM, '%')
    ORDER BY p.fecha_pedido DESC
    LIMIT P_LIMIT_ROWS OFFSET P_OFFSET_ROWS;
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_VER_DETALLE_PEDIDO_SP
-- DESCRIPCIÓN: Procedimiento para ver todos los detalles del pedido
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_VER_DETALLE_PEDIDO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_VER_DETALLE_PEDIDO_SP(IN P_CODIGO_PEDIDO VARCHAR(30))
BEGIN
    -- Datos generales del pedido
    SELECT
		p.ID_PEDIDO_PK,
        p.codigo_pedido AS CODIGO_PEDIDO,
        u.usuario_nombre AS CLIENTE,
        u.usuario_correo AS CORREO,
        e.estado_descripcion AS ESTADO_PEDIDO,
        p.fecha_pedido AS FECHA_PEDIDO,
        p.total AS TOTAL,
        p.envio_provincia, 
        p.envio_canton, 
        p.envio_distrito, 
        p.envio_sennas,
        pg.metodo_pago, 
        pg.monto AS MONTO_PAGO,
        pg.estado_pago AS ESTADO_PAGO,
        en.numero_seguimiento,
        en.fecha_envio,
        en.fecha_entrega_estimada,
        en.costo_envio
    FROM huellitas_pedidos_tb AS p
    INNER JOIN huellitas_usuarios_tb AS u ON p.id_usuario_fk = u.id_usuario_pk
    INNER JOIN huellitas_estado_tb AS e ON p.id_estado_fk = e.id_estado_pk
    LEFT JOIN huellitas_pagos_tb AS pg ON pg.id_pedido_fk = p.id_pedido_pk
    LEFT JOIN huellitas_envios_tb AS en ON en.id_pedido_fk = p.id_pedido_pk
    WHERE p.codigo_pedido = P_CODIGO_PEDIDO;

    -- Detalle de productos
    SELECT 
        d.id_pedido_detalle_pk AS ID_DETALLE,
        pr.producto_nombre AS PRODUCTO,
        d.cantidad AS CANTIDAD,
        d.precio_unitario AS PRECIO_UNITARIO,
        d.subtotal AS SUBTOTAL
    FROM huellitas_pedidos_detalle_tb AS d
    INNER JOIN huellitas_productos_tb AS pr ON d.id_producto_fk = pr.id_producto_pk
    INNER JOIN huellitas_pedidos_tb AS p ON d.id_pedido_fk = p.id_pedido_pk
    WHERE p.codigo_pedido = P_CODIGO_PEDIDO;
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_ESTADO_PEDIDO_SP
-- DESCRIPCIÓN: Procedimiento para actualizar el estado del pedido
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_ESTADO_PEDIDO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_ESTADO_PEDIDO_SP(
    IN p_codigo_o_id VARCHAR(30),
    IN p_nuevo_estado_id INT
)
BEGIN
    DECLARE v_pedido_id INT;

    IF p_codigo_o_id REGEXP '^[0-9]+$' THEN
        SET v_pedido_id = CAST(p_codigo_o_id AS SIGNED);
    ELSE
        SELECT ID_PEDIDO_PK INTO v_pedido_id
        FROM HUELLITAS_PEDIDOS_TB
        WHERE CODIGO_PEDIDO = p_codigo_o_id
        LIMIT 1;
    END IF;

    IF v_pedido_id IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'El pedido no existe.';
    END IF;

    UPDATE HUELLITAS_PEDIDOS_TB
    SET ID_ESTADO_FK = p_nuevo_estado_id
    WHERE ID_PEDIDO_PK = v_pedido_id;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_ESTADO_PAGO_SP
-- DESCRIPCIÓN: Procedimiento para actualizar el estado de pago del pedido
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_ESTADO_PAGO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_ESTADO_PAGO_SP(
    IN P_ID_PAGO INT,
    IN P_NUEVO_ESTADO VARCHAR(50),
    OUT P_MENSAJE VARCHAR(200),
    OUT P_ID_PEDIDO INT
)
BEGIN
    DECLARE V_EXISTE_PAGO INT DEFAULT 0;
    DECLARE V_ID_PEDIDO INT DEFAULT NULL;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET P_MENSAJE = '❌ Error interno al actualizar el estado del pago.';
        SET P_ID_PEDIDO = NULL;
    END;

    START TRANSACTION;

    -- ================================================
    -- 1) VALIDAR QUE EL PAGO EXISTA
    -- ================================================
    SELECT COUNT(*)
    INTO V_EXISTE_PAGO
    FROM HUELLITAS_PAGOS_TB
    WHERE ID_PAGO_PK = P_ID_PAGO;

    IF V_EXISTE_PAGO = 0 THEN
        ROLLBACK;
        SET P_MENSAJE = '❌ El pago no existe.';
        SET P_ID_PEDIDO = NULL;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Fin del procedimiento';
    END IF;

    -- Obtener ID del pedido
    SELECT ID_PEDIDO_FK
    INTO V_ID_PEDIDO
    FROM HUELLITAS_PAGOS_TB
    WHERE ID_PAGO_PK = P_ID_PAGO;

    -- ================================================
    -- 2) ACTUALIZAR ESTADO DEL PAGO
    -- ================================================
    UPDATE HUELLITAS_PAGOS_TB
    SET ESTADO_PAGO = P_NUEVO_ESTADO
    WHERE ID_PAGO_PK = P_ID_PAGO;

    -- ================================================
    -- 3) SINCRONIZAR EL ESTADO DEL PEDIDO
    -- ================================================
    IF P_NUEVO_ESTADO = 'PAGADO' THEN
        UPDATE HUELLITAS_PEDIDOS_TB
        SET ID_ESTADO_FK = (
            SELECT ID_ESTADO_PK 
            FROM HUELLITAS_ESTADO_TB 
            WHERE ESTADO_DESCRIPCION = 'PAGADO' LIMIT 1
        )
        WHERE ID_PEDIDO_PK = V_ID_PEDIDO;
    END IF;

    IF P_NUEVO_ESTADO = 'RECHAZADO' THEN
        UPDATE HUELLITAS_PEDIDOS_TB
        SET ID_ESTADO_FK = (
            SELECT ID_ESTADO_PK 
            FROM HUELLITAS_ESTADO_TB 
            WHERE ESTADO_DESCRIPCION = 'CANCELADO' LIMIT 1
        )
        WHERE ID_PEDIDO_PK = V_ID_PEDIDO;
    END IF;

    COMMIT;

    SET P_MENSAJE = '✔ Estado de pago actualizado correctamente.';
    SET P_ID_PEDIDO = V_ID_PEDIDO;

END$$
DELIMITER ;




-- ==========================================
-- NOMBRE: HUELLITAS_CANCELAR_PEDIDO_SP
-- DESCRIPCIÓN: Procedimiento para cancelar el pedido
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CANCELAR_PEDIDO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CANCELAR_PEDIDO_SP(
    IN p_pedido_id INT,
    IN p_usuario_id INT
)
BEGIN
    DECLARE v_estado_actual INT;
    DECLARE v_estado_cancelado INT;
    DECLARE v_in_trigger BOOLEAN DEFAULT FALSE;

    -- Detectar si viene del trigger
    IF @TRIGGER_ORIGIN = 'TRIGGER' THEN
        SET v_in_trigger = TRUE;
    END IF;

    -- Marcar origen
    SET @TRIGGER_ORIGIN = 'CANCEL_SP';

    -- Buscar ID de CANCELADO
    SELECT ID_ESTADO_PK INTO v_estado_cancelado 
    FROM HUELLITAS_ESTADO_TB 
    WHERE ESTADO_DESCRIPCION = 'CANCELADO'
    LIMIT 1;

    -- Estado actual
    SELECT ID_ESTADO_FK INTO v_estado_actual
    FROM HUELLITAS_PEDIDOS_TB
    WHERE ID_PEDIDO_PK = p_pedido_id;

    -- Validaciones
    IF v_estado_actual IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'El pedido no existe.';
    END IF;

    IF v_estado_actual NOT IN (
        SELECT ID_ESTADO_PK FROM HUELLITAS_ESTADO_TB 
        WHERE ESTADO_DESCRIPCION IN ('PENDIENTE', 'EN PREPARACIÓN', 'CANCELADO')
    ) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'El pedido no se puede cancelar en su estado actual.';
    END IF;

    -- ❗ Solo hacer UPDATE si fue llamado directamente (no desde el trigger)
    IF v_in_trigger = FALSE THEN
        UPDATE HUELLITAS_PEDIDOS_TB
        SET ID_ESTADO_FK = v_estado_cancelado
        WHERE ID_PEDIDO_PK = p_pedido_id;
    END IF;

    -- Revertir stock
    UPDATE HUELLITAS_PRODUCTOS_TB p
    JOIN HUELLITAS_PEDIDOS_DETALLE_TB d ON d.ID_PRODUCTO_FK = p.ID_PRODUCTO_PK
    SET p.PRODUCTO_STOCK = p.PRODUCTO_STOCK + d.CANTIDAD
    WHERE d.ID_PEDIDO_FK = p_pedido_id;

    -- Actualizar pago
    UPDATE HUELLITAS_PAGOS_TB
    SET ESTADO_PAGO = 'CANCELADO'
    WHERE ID_PEDIDO_FK = p_pedido_id;

    -- Insertar notificación
    INSERT INTO HUELLITAS_NOTIFICACIONES_TB (
        ID_USUARIO_FK, ID_ESTADO_FK, TITULO_NOTIFICACION, MENSAJE_NOTIFICACION, TIPO_NOTIFICACION
    )
    VALUES (
        p_usuario_id,
        v_estado_cancelado,
        'Pedido cancelado',
        CONCAT('Tu pedido #', p_pedido_id, ' fue cancelado correctamente.'),
        'PEDIDO'
    );

    -- Limpiar bandera
    SET @TRIGGER_ORIGIN = NULL;
END$$
DELIMITER ;

-- -----------------------------------Clientes Veterinarios------------------------------------------
-- ==========================================
-- NOMBRE: HUELLITAS_VINCULAR_CLIENTE_USUARIO_SP
-- DESCRIPCIÓN: Procedimiento vincular cliente con usuario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_VINCULAR_CLIENTE_USUARIO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_VINCULAR_CLIENTE_USUARIO_SP(
    IN p_codigo_usuario VARCHAR(30)
)
main_block: BEGIN
    DECLARE v_id_usuario INT;
    DECLARE v_correo VARCHAR(100);
    DECLARE v_id_cliente INT;
    DECLARE v_cantidad_mascotas INT DEFAULT 0;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 0 AS EXITO, '❌ Error al vincular el cliente.' AS MENSAJE;
    END;

    START TRANSACTION;

    -- Buscar usuario
    SELECT ID_USUARIO_PK, USUARIO_CORREO
    INTO v_id_usuario, v_correo
    FROM HUELLITAS_USUARIOS_TB
    WHERE CODIGO_USUARIO = p_codigo_usuario;

    IF v_id_usuario IS NULL THEN
        ROLLBACK;
        SELECT 0 AS EXITO, '⚠ Usuario no encontrado.' AS MENSAJE;
        LEAVE main_block;
    END IF;

    -- Buscar cliente por correo
    SELECT ID_CLIENTE_PK INTO v_id_cliente
    FROM HUELLITAS_CLIENTES_TB
    WHERE CLIENTE_CORREO = v_correo;

    IF v_id_cliente IS NULL THEN
        ROLLBACK;
        SELECT 0 AS EXITO, '⚠ No existe cliente con ese correo.' AS MENSAJE;
        LEAVE main_block;
    END IF;

    -- Evitar doble vinculación
    IF (SELECT ID_USUARIO_VINCULADO_FK FROM HUELLITAS_CLIENTES_TB WHERE ID_CLIENTE_PK = v_id_cliente) IS NOT NULL THEN
        ROLLBACK;
        SELECT 0 AS EXITO, '⚠ Este cliente ya está vinculado.' AS MENSAJE;
        LEAVE main_block;
    END IF;

    -- Vincular cliente ⇄ usuario
    UPDATE HUELLITAS_CLIENTES_TB
    SET ID_USUARIO_VINCULADO_FK = v_id_usuario
    WHERE ID_CLIENTE_PK = v_id_cliente;

    UPDATE HUELLITAS_USUARIOS_TB
    SET ID_CLIENTE_VINCULADO_FK = v_id_cliente
    WHERE ID_USUARIO_PK = v_id_usuario;

    -- Migrar mascotas
    UPDATE HUELLITAS_MASCOTA_TB
    SET ID_USUARIO_FK = v_id_usuario,
        ID_CLIENTE_FK = NULL
    WHERE ID_CLIENTE_FK = v_id_cliente;

    SELECT ROW_COUNT() INTO v_cantidad_mascotas;

    COMMIT;

    SELECT 
        1 AS EXITO,
        v_id_usuario AS USUARIO,
        v_id_cliente AS CLIENTE,
        v_cantidad_mascotas AS MASCOTAS_MIGRADAS,
        '✔ Vinculación exitosa.' AS MENSAJE;

END main_block$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_CLIENTE_SP
-- DESCRIPCIÓN: Procedimiento agregar cliente por parte del empleado
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_CLIENTE_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_AGREGAR_CLIENTE_SP(
    IN p_nombre VARCHAR(100),
    IN p_correo VARCHAR(100),
    IN p_identificacion VARCHAR(50),
    IN p_direccion_id INT,
    IN p_telefono_id INT,
    IN p_observaciones VARCHAR(500),
    IN p_estado_id INT,
    IN p_creado_por VARCHAR(50)
)
proc:BEGIN

    DECLARE v_correo_existente INT DEFAULT 0;
    DECLARE v_identificacion_existente INT DEFAULT 0;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 0 AS EXITO, '❌ Error al registrar el cliente.' AS MENSAJE;
    END;

    START TRANSACTION;

    -- ==========================================================
    -- VALIDACIÓN 1: CORREO YA EXISTE EN CLIENTES O USUARIOS
    -- ==========================================================
    SELECT  
        (SELECT COUNT(*) FROM HUELLITAS_CLIENTES_TB 
            WHERE CLIENTE_CORREO = p_correo)
        +
        (SELECT COUNT(*) FROM HUELLITAS_USUARIOS_TB 
            WHERE USUARIO_CORREO = p_correo)
    INTO v_correo_existente;

    IF v_correo_existente > 0 THEN
        ROLLBACK;
        SELECT 0 AS EXITO, 'El correo ya está registrado en clientes o usuarios.' AS MENSAJE;
        LEAVE proc;
    END IF;

    -- ==========================================================
    -- VALIDACIÓN 2: IDENTIFICACIÓN DUPLICADA SOLO EN CLIENTES
    -- ==========================================================
    IF p_identificacion IS NOT NULL AND p_identificacion != '' THEN
        
        SELECT COUNT(*) INTO v_identificacion_existente
        FROM HUELLITAS_CLIENTES_TB
        WHERE CLIENTE_IDENTIFICACION = p_identificacion;

        IF v_identificacion_existente > 0 THEN
            ROLLBACK;
            SELECT 0 AS EXITO, 'La identificación ya está registrada en otro cliente.' AS MENSAJE;
            LEAVE proc;
        END IF;

    END IF;

    -- ==========================================================
    -- INSERTAR CLIENTE
    -- ==========================================================
    INSERT INTO HUELLITAS_CLIENTES_TB (
        ID_ESTADO_FK,
        ID_DIRECCION_FK,
        ID_TELEFONO_CONTACTO_FK,
        CLIENTE_NOMBRE,
        CLIENTE_CORREO,
        CLIENTE_IDENTIFICACION,
        CLIENTE_OBSERVACIONES,
        CLIENTE_FECHA_REGISTRO
    )
    VALUES (
        p_estado_id,
        p_direccion_id,
        p_telefono_id,
        p_nombre,
        p_correo,
        p_identificacion,
        p_observaciones,
        NOW()
    );

    COMMIT;

    SELECT 
        LAST_INSERT_ID() AS ID_CLIENTE,
        1 AS EXITO,
        CONCAT('Cliente ', p_nombre, ' registrado correctamente por ', p_creado_por) AS MENSAJE;

END proc$$
DELIMITER ;




-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_CLIENTE_SP
-- DESCRIPCIÓN: Actualiza un cliente sin permitir modificar el correo
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_CLIENTE_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_ACTUALIZAR_CLIENTE_SP(
    IN P_CODIGO_CLIENTE VARCHAR(30),
    IN P_NOMBRE VARCHAR(100),
    IN P_IDENTIFICACION VARCHAR(50),
    IN P_ID_DIRECCION_FK INT,
    IN P_ID_TELEFONO_FK INT,
    IN P_OBSERVACIONES VARCHAR(500),
    IN P_ID_ESTADO_FK INT
)
proc: BEGIN
    DECLARE V_ID_CLIENTE INT;
    DECLARE V_EXISTE_IDENT_CLIENTE INT DEFAULT 0;
    DECLARE V_EXISTE_IDENT_USUARIO INT DEFAULT 0;

    -- Buscar el ID interno del cliente
    SELECT ID_CLIENTE_PK INTO V_ID_CLIENTE
    FROM HUELLITAS_CLIENTES_TB
    WHERE CODIGO_CLIENTE = P_CODIGO_CLIENTE;

    IF V_ID_CLIENTE IS NULL THEN
        SELECT 0 AS EXITO, '❌ No se encontró el cliente especificado.' AS MENSAJE;
        LEAVE proc;
    END IF;

    -- Validar identificación duplicada en clientes (excepto el actual)
    IF P_IDENTIFICACION IS NOT NULL AND P_IDENTIFICACION <> '' THEN
        SELECT COUNT(*) INTO V_EXISTE_IDENT_CLIENTE
        FROM HUELLITAS_CLIENTES_TB
        WHERE CLIENTE_IDENTIFICACION = P_IDENTIFICACION
          AND ID_CLIENTE_PK <> V_ID_CLIENTE;

        SELECT COUNT(*) INTO V_EXISTE_IDENT_USUARIO
        FROM HUELLITAS_USUARIOS_TB
        WHERE USUARIO_IDENTIFICACION = P_IDENTIFICACION;
    END IF;

    IF V_EXISTE_IDENT_CLIENTE > 0 OR V_EXISTE_IDENT_USUARIO > 0 THEN
        SELECT 0 AS EXITO, '⚠️ La identificación ya está registrada en otro cliente o usuario.' AS MENSAJE;
        LEAVE proc;
    END IF;

    -- Actualizar los datos (correo NO se modifica)
    UPDATE HUELLITAS_CLIENTES_TB
    SET 
        CLIENTE_NOMBRE = P_NOMBRE,
        CLIENTE_IDENTIFICACION = P_IDENTIFICACION,
        ID_DIRECCION_FK = P_ID_DIRECCION_FK,
        ID_TELEFONO_CONTACTO_FK = P_ID_TELEFONO_FK,
        CLIENTE_OBSERVACIONES = P_OBSERVACIONES,
        ID_ESTADO_FK = P_ID_ESTADO_FK
    WHERE ID_CLIENTE_PK = V_ID_CLIENTE;

    SELECT 1 AS EXITO, '✅ Cliente actualizado correctamente.' AS MENSAJE;
END proc $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_CLIENTE_POR_CODIGO_SP
-- DESCRIPCIÓN: Obtiene la info de un cliente por su código generado
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_CLIENTE_POR_CODIGO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_OBTENER_CLIENTE_POR_CODIGO_SP(
    IN P_CODIGO_CLIENTE VARCHAR(30)
)
BEGIN
    DECLARE v_existe INT DEFAULT 0;

    -- 1. Verificar existencia exacta (porque tu función genera códigos sin prefijo)
    SELECT COUNT(*) INTO v_existe
    FROM HUELLITAS_CLIENTES_TB 
    WHERE CODIGO_CLIENTE = P_CODIGO_CLIENTE;

    -- 2. Si no existe, devolvemos solo este SELECT
    IF v_existe = 0 THEN
        SELECT 
            0 AS EXITO,
            '❌ No se encontró ningún cliente con el código proporcionado.' AS MENSAJE;
    ELSE
        -- 3. Si sí existe, devolvemos la data completa
        SELECT 
            C.ID_CLIENTE_PK AS ID_CLIENTE,
            C.CODIGO_CLIENTE AS CODIGO,
            C.CLIENTE_NOMBRE AS NOMBRE,
            C.CLIENTE_CORREO AS CORREO,
            C.CLIENTE_IDENTIFICACION AS IDENTIFICACION,
            C.CLIENTE_FECHA_REGISTRO AS FECHA_REGISTRO,
            C.CLIENTE_OBSERVACIONES AS OBSERVACIONES,
            C.ID_DIRECCION_FK AS ID_DIRECCION,
            C.ID_TELEFONO_CONTACTO_FK AS ID_TELEFONO,
            E.ESTADO_DESCRIPCION AS ESTADO,
            COALESCE(T.TELEFONO_CONTACTO, '') AS TELEFONO,
            COALESCE(D.DIRECCION_SENNAS, '') AS DIRECCION,
            COALESCE(PROV.NOMBRE_PROVINCIA, '') AS PROVINCIA,
            COALESCE(CANT.NOMBRE_CANTON, '') AS CANTON,
            COALESCE(DIST.NOMBRE_DISTRITO, '') AS DISTRITO,
            COALESCE(U.USUARIO_NOMBRE, '') AS USUARIO_VINCULADO,
            'CLIENTE' AS TIPO,
            1 AS EXITO,
            '✅ Cliente encontrado correctamente.' AS MENSAJE
        FROM HUELLITAS_CLIENTES_TB C
        INNER JOIN HUELLITAS_ESTADO_TB E ON C.ID_ESTADO_FK = E.ID_ESTADO_PK
        LEFT JOIN HUELLITAS_TELEFONO_CONTACTO_TB T ON C.ID_TELEFONO_CONTACTO_FK = T.ID_TELEFONO_CONTACTO_PK
        LEFT JOIN HUELLITAS_DIRECCION_TB D ON C.ID_DIRECCION_FK = D.ID_DIRECCION_PK
        LEFT JOIN HUELLITAS_DIRECCION_PROVINCIA_TB PROV ON D.ID_DIRECCION_PROVINCIA_FK = PROV.ID_DIRECCION_PROVINCIA_PK
        LEFT JOIN HUELLITAS_DIRECCION_CANTON_TB CANT ON D.ID_DIRECCION_CANTON_FK = CANT.ID_DIRECCION_CANTON_PK
        LEFT JOIN HUELLITAS_DIRECCION_DISTRITO_TB DIST ON D.ID_DIRECCION_DISTRITO_FK = DIST.ID_DIRECCION_DISTRITO_PK
        LEFT JOIN HUELLITAS_USUARIOS_TB U ON C.ID_USUARIO_VINCULADO_FK = U.ID_USUARIO_PK
        WHERE C.CODIGO_CLIENTE = P_CODIGO_CLIENTE;
    END IF;
END //
DELIMITER ;



-- ==========================================
-- NOMBRE: HUELLITAS_CONTAR_CLIENTES_SP
-- DESCRIPCIÓN: Cuenta el total de clientes registrados
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CONTAR_TODOS_CLIENTES_USUARIOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_CONTAR_TODOS_CLIENTES_USUARIOS_SP(
    IN P_SEARCH_TERM VARCHAR(100)
)
BEGIN
    DECLARE TOTAL_CLIENTES INT DEFAULT 0;
    DECLARE TOTAL_USUARIOS INT DEFAULT 0;

    -- CLIENTES ACTIVOS Y NO VINCULADOS
    SELECT COUNT(DISTINCT C.ID_CLIENTE_PK)
    INTO TOTAL_CLIENTES
    FROM HUELLITAS_CLIENTES_TB C
    LEFT JOIN HUELLITAS_MASCOTA_TB M ON C.ID_CLIENTE_PK = M.ID_CLIENTE_FK
    WHERE 
        C.ID_ESTADO_FK = 1
        AND C.ID_USUARIO_VINCULADO_FK IS NULL
        AND (
            C.CLIENTE_NOMBRE LIKE CONCAT('%', P_SEARCH_TERM, '%')
            OR C.CLIENTE_CORREO LIKE CONCAT('%', P_SEARCH_TERM, '%')
            OR C.CLIENTE_IDENTIFICACION LIKE CONCAT('%', P_SEARCH_TERM, '%')
            OR C.CODIGO_CLIENTE LIKE CONCAT('%', P_SEARCH_TERM, '%')
            OR M.NOMBRE_MASCOTA LIKE CONCAT('%', P_SEARCH_TERM, '%')
        );

    -- USUARIOS ACTIVOS
    SELECT COUNT(DISTINCT U.ID_USUARIO_PK)
    INTO TOTAL_USUARIOS
    FROM HUELLITAS_USUARIOS_TB U
    LEFT JOIN HUELLITAS_MASCOTA_TB M ON U.ID_USUARIO_PK = M.ID_USUARIO_FK
    WHERE 
        U.ID_ESTADO_FK = 1
        AND (
            U.USUARIO_NOMBRE LIKE CONCAT('%', P_SEARCH_TERM, '%')
            OR U.USUARIO_CORREO LIKE CONCAT('%', P_SEARCH_TERM, '%')
            OR U.USUARIO_IDENTIFICACION LIKE CONCAT('%', P_SEARCH_TERM, '%')
            OR U.CODIGO_USUARIO LIKE CONCAT('%', P_SEARCH_TERM, '%')
            OR M.NOMBRE_MASCOTA LIKE CONCAT('%', P_SEARCH_TERM, '%')
        );

    SELECT (TOTAL_CLIENTES + TOTAL_USUARIOS) AS TOTAL;
END //
DELIMITER ;





-- ==========================================
-- NOMBRE: HUELLITAS_BUSCAR_TODOS_CLIENTES_USUARIOS_SP
-- DESCRIPCIÓN: Lista y busca clientes veterinarios con paginación y cantidad de mascotas
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_BUSCAR_TODOS_CLIENTES_USUARIOS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_BUSCAR_TODOS_CLIENTES_USUARIOS_SP(
    IN P_SEARCH_TERM VARCHAR(100),
    IN P_LIMIT_ROWS INT,
    IN P_OFFSET_ROWS INT
)
BEGIN
    (
        SELECT 
            C.ID_CLIENTE_PK AS ID,
            C.CODIGO_CLIENTE AS CODIGO,
            C.CLIENTE_NOMBRE AS NOMBRE,
            C.CLIENTE_CORREO AS CORREO,
            C.CLIENTE_IDENTIFICACION AS IDENTIFICACION,
            E.ESTADO_DESCRIPCION AS ESTADO,
            'CLIENTE' AS TIPO,
            COALESCE(T.TELEFONO_CONTACTO, 'NO REGISTRADO') AS TELEFONO,
            COALESCE(D.DIRECCION_SENNAS, 'NO REGISTRADA') AS DIRECCION,
            GROUP_CONCAT(M.NOMBRE_MASCOTA SEPARATOR ', ') AS NOMBRES_MASCOTAS,
            COUNT(M.ID_MASCOTA_PK) AS TOTAL_MASCOTAS
        FROM HUELLITAS_CLIENTES_TB C
        INNER JOIN HUELLITAS_ESTADO_TB E ON C.ID_ESTADO_FK = E.ID_ESTADO_PK
        LEFT JOIN HUELLITAS_TELEFONO_CONTACTO_TB T ON C.ID_TELEFONO_CONTACTO_FK = T.ID_TELEFONO_CONTACTO_PK
        LEFT JOIN HUELLITAS_DIRECCION_TB D ON C.ID_DIRECCION_FK = D.ID_DIRECCION_PK
        LEFT JOIN HUELLITAS_MASCOTA_TB M ON C.ID_CLIENTE_PK = M.ID_CLIENTE_FK
        WHERE 
            C.ID_ESTADO_FK = 1
            AND C.ID_USUARIO_VINCULADO_FK IS NULL
            AND (
                C.CLIENTE_NOMBRE LIKE CONCAT('%', P_SEARCH_TERM, '%')
                OR C.CLIENTE_CORREO LIKE CONCAT('%', P_SEARCH_TERM, '%')
                OR C.CLIENTE_IDENTIFICACION LIKE CONCAT('%', P_SEARCH_TERM, '%')
                OR C.CODIGO_CLIENTE LIKE CONCAT('%', P_SEARCH_TERM, '%')
                OR M.NOMBRE_MASCOTA LIKE CONCAT('%', P_SEARCH_TERM, '%')
            )
        GROUP BY 
            C.ID_CLIENTE_PK
    )

    UNION ALL

    (
        SELECT 
            U.ID_USUARIO_PK AS ID,
            U.CODIGO_USUARIO AS CODIGO,
            U.USUARIO_NOMBRE AS NOMBRE,
            U.USUARIO_CORREO AS CORREO,
            U.USUARIO_IDENTIFICACION AS IDENTIFICACION,
            E.ESTADO_DESCRIPCION AS ESTADO,
            'USUARIO' AS TIPO,
            COALESCE(T.TELEFONO_CONTACTO, 'NO REGISTRADO') AS TELEFONO,
            COALESCE(D.DIRECCION_SENNAS, 'NO REGISTRADA') AS DIRECCION,
            GROUP_CONCAT(M.NOMBRE_MASCOTA SEPARATOR ', ') AS NOMBRES_MASCOTAS,
            COUNT(M.ID_MASCOTA_PK) AS TOTAL_MASCOTAS
        FROM HUELLITAS_USUARIOS_TB U
        INNER JOIN HUELLITAS_ESTADO_TB E ON U.ID_ESTADO_FK = E.ID_ESTADO_PK
        LEFT JOIN HUELLITAS_TELEFONO_CONTACTO_TB T ON U.ID_TELEFONO_CONTACTO_FK = T.ID_TELEFONO_CONTACTO_PK
        LEFT JOIN HUELLITAS_DIRECCION_TB D ON U.ID_DIRECCION_FK = D.ID_DIRECCION_PK
        LEFT JOIN HUELLITAS_MASCOTA_TB M ON U.ID_USUARIO_PK = M.ID_USUARIO_FK
        WHERE 
            U.ID_ESTADO_FK = 1
            AND (
                U.USUARIO_NOMBRE LIKE CONCAT('%', P_SEARCH_TERM, '%')
                OR U.USUARIO_CORREO LIKE CONCAT('%', P_SEARCH_TERM, '%')
                OR U.USUARIO_IDENTIFICACION LIKE CONCAT('%', P_SEARCH_TERM, '%')
                OR U.CODIGO_USUARIO LIKE CONCAT('%', P_SEARCH_TERM, '%')
                OR M.NOMBRE_MASCOTA LIKE CONCAT('%', P_SEARCH_TERM, '%')
            )
        GROUP BY 
            U.ID_USUARIO_PK
    )
    ORDER BY NOMBRE ASC
    LIMIT P_LIMIT_ROWS OFFSET P_OFFSET_ROWS;
END //
DELIMITER ;



-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_DETALLE_CLIENTE_POR_CODIGO_SP
-- DESCRIPCIÓN: Obtiene los datos del cliente por medio del codigo
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_DETALLE_CLIENTE_POR_CODIGO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_DETALLE_CLIENTE_POR_CODIGO_SP(
    IN p_codigo VARCHAR(30),
    IN p_tipo VARCHAR(20)
)
BEGIN
    DECLARE v_tipo_final VARCHAR(20);
    DECLARE v_id_cliente INT;
    DECLARE v_id_usuario INT;

    -- =====================================================
    -- 1. Detectar si el código pertenece a CLIENTE o USUARIO
    -- =====================================================
    SELECT ID_CLIENTE_PK, ID_USUARIO_VINCULADO_FK
    INTO v_id_cliente, v_id_usuario
    FROM HUELLITAS_CLIENTES_TB
    WHERE CODIGO_CLIENTE = p_codigo
    LIMIT 1;

    IF v_id_cliente IS NULL THEN
        SELECT ID_USUARIO_PK INTO v_id_usuario
        FROM HUELLITAS_USUARIOS_TB
        WHERE CODIGO_USUARIO = p_codigo
        LIMIT 1;
    END IF;

    IF v_id_usuario IS NOT NULL THEN
        SET v_tipo_final = 'USUARIO';
    ELSE
        SET v_tipo_final = 'CLIENTE';
    END IF;

    -- =====================================================
    -- 2. DETALLES DEL CLIENTE
    -- =====================================================
    IF v_tipo_final = 'CLIENTE' THEN

        SELECT 
            C.ID_CLIENTE_PK AS ID,
            C.CODIGO_CLIENTE AS CODIGO,
            C.CLIENTE_NOMBRE AS NOMBRE,
            C.CLIENTE_CORREO AS CORREO,
            C.CLIENTE_IDENTIFICACION AS IDENTIFICACION,
            E.ESTADO_DESCRIPCION AS ESTADO,
            D.DIRECCION_SENNAS AS DIRECCION,
            PR.NOMBRE_PROVINCIA AS PROVINCIA,
            CA.NOMBRE_CANTON AS CANTON,
            DI.NOMBRE_DISTRITO AS DISTRITO,
            T.TELEFONO_CONTACTO AS TELEFONO,
            'CLIENTE' AS TIPO
        FROM HUELLITAS_CLIENTES_TB C
        INNER JOIN HUELLITAS_ESTADO_TB E ON C.ID_ESTADO_FK = E.ID_ESTADO_PK
        LEFT JOIN HUELLITAS_DIRECCION_TB D ON C.ID_DIRECCION_FK = D.ID_DIRECCION_PK
        LEFT JOIN HUELLITAS_DIRECCION_PROVINCIA_TB PR ON D.ID_DIRECCION_PROVINCIA_FK = PR.ID_DIRECCION_PROVINCIA_PK
        LEFT JOIN HUELLITAS_DIRECCION_CANTON_TB CA ON D.ID_DIRECCION_CANTON_FK = CA.ID_DIRECCION_CANTON_PK
        LEFT JOIN HUELLITAS_DIRECCION_DISTRITO_TB DI ON D.ID_DIRECCION_DISTRITO_FK = DI.ID_DIRECCION_DISTRITO_PK
        LEFT JOIN HUELLITAS_TELEFONO_CONTACTO_TB T ON C.ID_TELEFONO_CONTACTO_FK = T.ID_TELEFONO_CONTACTO_PK
        WHERE C.CODIGO_CLIENTE = p_codigo;

        -- Mascotas del cliente
        SELECT 
            M.ID_MASCOTA_PK,
            M.CODIGO_MASCOTA,
            M.NOMBRE_MASCOTA,
            ES.NOMBRE_ESPECIE AS ESPECIE,
            R.NOMBRE_RAZA AS RAZA
        FROM HUELLITAS_MASCOTA_TB M
        LEFT JOIN HUELLITAS_MASCOTA_ESPECIE_TB ES ON M.ID_MASCOTA_ESPECIE_FK = ES.ID_MASCOTA_ESPECIE_PK
        LEFT JOIN HUELLITAS_MASCOTA_RAZA_TB R ON M.ID_MASCOTA_RAZA_FK = R.ID_MASCOTA_RAZA_PK
        WHERE M.ID_CLIENTE_FK = v_id_cliente;

    ELSE

    -- =====================================================
    -- 3. DETALLES DEL USUARIO
    -- =====================================================

        SELECT 
            U.ID_USUARIO_PK AS ID,
            U.CODIGO_USUARIO AS CODIGO,
            U.USUARIO_NOMBRE AS NOMBRE,
            U.USUARIO_CORREO AS CORREO,
            U.USUARIO_IDENTIFICACION AS IDENTIFICACION,
            E.ESTADO_DESCRIPCION AS ESTADO,
            D.DIRECCION_SENNAS AS DIRECCION,
            PR.NOMBRE_PROVINCIA AS PROVINCIA,
            CA.NOMBRE_CANTON AS CANTON,
            DI.NOMBRE_DISTRITO AS DISTRITO,
            T.TELEFONO_CONTACTO AS TELEFONO,
            'USUARIO' AS TIPO
        FROM HUELLITAS_USUARIOS_TB U
        INNER JOIN HUELLITAS_ESTADO_TB E ON U.ID_ESTADO_FK = E.ID_ESTADO_PK
        LEFT JOIN HUELLITAS_DIRECCION_TB D ON U.ID_DIRECCION_FK = D.ID_DIRECCION_PK
        LEFT JOIN HUELLITAS_DIRECCION_PROVINCIA_TB PR ON D.ID_DIRECCION_PROVINCIA_FK = PR.ID_DIRECCION_PROVINCIA_PK
        LEFT JOIN HUELLITAS_DIRECCION_CANTON_TB CA ON D.ID_DIRECCION_CANTON_FK = CA.ID_DIRECCION_CANTON_PK
        LEFT JOIN HUELLITAS_DIRECCION_DISTRITO_TB DI ON D.ID_DIRECCION_DISTRITO_FK = DI.ID_DIRECCION_DISTRITO_PK
        LEFT JOIN HUELLITAS_TELEFONO_CONTACTO_TB T ON U.ID_TELEFONO_CONTACTO_FK = T.ID_TELEFONO_CONTACTO_PK
        WHERE U.CODIGO_USUARIO = p_codigo;

        -- Mascotas del usuario
        SELECT 
            M.ID_MASCOTA_PK,
            M.CODIGO_MASCOTA,
            M.NOMBRE_MASCOTA,
            ES.NOMBRE_ESPECIE AS ESPECIE,
            R.NOMBRE_RAZA AS RAZA
        FROM HUELLITAS_MASCOTA_TB M
        LEFT JOIN HUELLITAS_MASCOTA_ESPECIE_TB ES ON M.ID_MASCOTA_ESPECIE_FK = ES.ID_MASCOTA_ESPECIE_PK
        LEFT JOIN HUELLITAS_MASCOTA_RAZA_TB R ON M.ID_MASCOTA_RAZA_FK = R.ID_MASCOTA_RAZA_PK
        WHERE M.ID_USUARIO_FK = v_id_usuario;

    END IF;

END $$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_MASCOTAS_POR_USUARIO_SP
-- DESCRIPCIÓN: Obtiene la lista de mascotas asociadas a un usuario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_MASCOTAS_POR_USUARIO_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_OBTENER_MASCOTAS_POR_USUARIO_SP(
    IN P_CODIGO_USUARIO VARCHAR(30)
)
BEGIN
    -- =====================================
    -- Validar que el usuario exista
    -- =====================================
    DECLARE V_ID_USUARIO INT;

    SELECT ID_USUARIO_PK
    INTO V_ID_USUARIO
    FROM HUELLITAS_USUARIOS_TB
    WHERE CODIGO_USUARIO = P_CODIGO_USUARIO
    LIMIT 1;

    IF V_ID_USUARIO IS NULL THEN
        SELECT 
            'ERROR' AS ESTADO,
            'No se encontró ningún usuario con el código proporcionado.' AS MENSAJE;
    ELSE
        -- =====================================
        -- Obtener las mascotas asociadas al usuario
        -- =====================================
        SELECT 
            M.ID_MASCOTA_PK,
            M.CODIGO_MASCOTA,
            M.NOMBRE_MASCOTA,
            M.FECHA_NACIMIENTO,
            M.GENERO,
            M.MASCOTA_IMAGEN_URL,
            E.NOMBRE_ESPECIE AS ESPECIE,
            R.NOMBRE_RAZA AS RAZA,
            ES.ESTADO_DESCRIPCION AS ESTADO,
            C.CLIENTE_NOMBRE AS CLIENTE_ASOCIADO,
            C.CODIGO_CLIENTE AS CODIGO_CLIENTE_ASOCIADO
        FROM HUELLITAS_MASCOTA_TB M
        INNER JOIN HUELLITAS_MASCOTA_ESPECIE_TB E 
            ON M.ID_MASCOTA_ESPECIE_FK = E.ID_MASCOTA_ESPECIE_PK
        LEFT JOIN HUELLITAS_MASCOTA_RAZA_TB R 
            ON M.ID_MASCOTA_RAZA_FK = R.ID_MASCOTA_RAZA_PK
        INNER JOIN HUELLITAS_ESTADO_TB ES 
            ON M.ID_ESTADO_FK = ES.ID_ESTADO_PK
        LEFT JOIN HUELLITAS_CLIENTES_TB C 
            ON M.ID_CLIENTE_FK = C.ID_CLIENTE_PK
        WHERE M.ID_USUARIO_FK = V_ID_USUARIO
        ORDER BY M.NOMBRE_MASCOTA ASC;
    END IF;
END //
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_MASCOTAS_SP
-- DESCRIPCIÓN: listar todas las mascotas por codigo de cliente/usuario
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_MASCOTAS_SP;
DELIMITER //
CREATE PROCEDURE HUELLITAS_OBTENER_MASCOTAS_SP(
    IN P_CODIGO VARCHAR(30)
)
BEGIN
    DECLARE V_ID_USUARIO INT DEFAULT NULL;
    DECLARE V_ID_CLIENTE INT DEFAULT NULL;

    -- ======================================================
    -- 1) Buscar si el código corresponde a un usuario
    -- ======================================================
    SELECT ID_USUARIO_PK
    INTO V_ID_USUARIO
    FROM HUELLITAS_USUARIOS_TB
    WHERE CODIGO_USUARIO = P_CODIGO
    LIMIT 1;

    -- ======================================================
    -- 2) Buscar si el código corresponde a un cliente
    -- ======================================================
    SELECT ID_CLIENTE_PK
    INTO V_ID_CLIENTE
    FROM HUELLITAS_CLIENTES_TB
    WHERE CODIGO_CLIENTE = P_CODIGO
    LIMIT 1;

    -- ======================================================
    -- 3) Si NO existe ni usuario ni cliente → Notificar
    -- ======================================================
    IF V_ID_USUARIO IS NULL AND V_ID_CLIENTE IS NULL THEN
        SELECT 
            'ERROR' AS ESTADO,
            'No se encontró usuario ni cliente con el código proporcionado.' AS MENSAJE;
    ELSE
        
        -- ======================================================
        -- 4) Obtener mascotas según lo encontrado
        -- ======================================================
        SELECT 
            M.ID_MASCOTA_PK,
            M.CODIGO_MASCOTA,
            M.NOMBRE_MASCOTA,
            M.FECHA_NACIMIENTO,
            M.GENERO,
            M.MASCOTA_IMAGEN_URL,
            E.NOMBRE_ESPECIE AS ESPECIE,
            R.NOMBRE_RAZA AS RAZA,
            ES.ESTADO_DESCRIPCION AS ESTADO,
            C.CLIENTE_NOMBRE AS CLIENTE_ASOCIADO,
            C.CODIGO_CLIENTE AS CODIGO_CLIENTE_ASOCIADO
        FROM HUELLITAS_MASCOTA_TB M
        INNER JOIN HUELLITAS_MASCOTA_ESPECIE_TB E 
            ON M.ID_MASCOTA_ESPECIE_FK = E.ID_MASCOTA_ESPECIE_PK
        LEFT JOIN HUELLITAS_MASCOTA_RAZA_TB R 
            ON M.ID_MASCOTA_RAZA_FK = R.ID_MASCOTA_RAZA_PK
        INNER JOIN HUELLITAS_ESTADO_TB ES 
            ON M.ID_ESTADO_FK = ES.ID_ESTADO_PK
        LEFT JOIN HUELLITAS_CLIENTES_TB C 
            ON M.ID_CLIENTE_FK = C.ID_CLIENTE_PK
        WHERE 
            (V_ID_USUARIO IS NOT NULL AND M.ID_USUARIO_FK = V_ID_USUARIO)
            OR
            (V_ID_CLIENTE IS NOT NULL AND M.ID_CLIENTE_FK = V_ID_CLIENTE)
        ORDER BY M.NOMBRE_MASCOTA ASC;

    END IF;

END //
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_MASCOTA_SP
-- DESCRIPCIÓN: Procedimiento almacenado para agregar mascotas
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_MASCOTA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_AGREGAR_MASCOTA_SP(
    IN p_id_estado INT,
    IN p_id_especie INT,
    IN p_id_raza INT,
    IN p_codigo_usuario VARCHAR(30),
    IN p_codigo_cliente VARCHAR(30),
    IN p_nombre VARCHAR(100),
    IN p_fecha_nacimiento DATE,
    IN p_genero VARCHAR(10),
    IN p_imagen_url VARCHAR(500),
    IN p_creado_por VARCHAR(50)
)
BEGIN
    DECLARE v_id_usuario INT DEFAULT NULL;
    DECLARE v_id_cliente INT DEFAULT NULL;
    DECLARE v_id_mascota INT DEFAULT NULL;
    DECLARE v_existente INT DEFAULT 0;

    -- =====================================
    -- OBTENER ID DE USUARIO (SI VIENE)
    -- =====================================
    IF p_codigo_usuario IS NOT NULL AND p_codigo_usuario <> '' THEN
        SELECT ID_USUARIO_PK INTO v_id_usuario
        FROM HUELLITAS_USUARIOS_TB
        WHERE CODIGO_USUARIO = p_codigo_usuario
        LIMIT 1;
    END IF;

    -- =====================================
    -- OBTENER ID DE CLIENTE (SI VIENE)
    -- =====================================
    IF p_codigo_cliente IS NOT NULL AND p_codigo_cliente <> '' THEN
        SELECT ID_CLIENTE_PK INTO v_id_cliente
        FROM HUELLITAS_CLIENTES_TB
        WHERE CODIGO_CLIENTE = p_codigo_cliente
        LIMIT 1;
    END IF;

    -- =====================================
    -- VALIDAR QUE EXISTE DUEÑO
    -- =====================================
    IF v_id_usuario IS NULL AND v_id_cliente IS NULL THEN
        SELECT 
            NULL AS ID_MASCOTA,
            NULL AS CODIGO_MASCOTA,
            0 AS EXITO,
            '⚠ Debe indicar un usuario o cliente válido.' AS MENSAJE;
        -- ❗ AQUI TERMINA LA EJECUCIÓN SIN RETURN / SIN LEAVE
        SET v_id_mascota = NULL;
    ELSE

        -- =====================================
        -- VALIDAR DUPLICADO
        -- =====================================
        SELECT COUNT(*) INTO v_existente
        FROM HUELLITAS_MASCOTA_TB
        WHERE NOMBRE_MASCOTA = p_nombre
        AND FECHA_NACIMIENTO = p_fecha_nacimiento
        AND (
            (v_id_usuario IS NOT NULL AND ID_USUARIO_FK = v_id_usuario)
            OR
            (v_id_cliente IS NOT NULL AND ID_CLIENTE_FK = v_id_cliente)
        );

        IF v_existente > 0 THEN
            SELECT 
                NULL AS ID_MASCOTA,
                NULL AS CODIGO_MASCOTA,
                0 AS EXITO,
                '⚠ Ya existe una mascota con este nombre y fecha.' AS MENSAJE;
            SET v_id_mascota = NULL;
        ELSE
            -- =====================================
            -- INSERTAR MASCOTA
            -- (DEJAMOS QUE EL TRIGGER GENERE EL CÓDIGO)
            -- =====================================
            INSERT INTO HUELLITAS_MASCOTA_TB (
                ID_ESTADO_FK,
                ID_MASCOTA_ESPECIE_FK,
                ID_MASCOTA_RAZA_FK,
                ID_USUARIO_FK,
                ID_CLIENTE_FK,
                NOMBRE_MASCOTA,
                FECHA_NACIMIENTO,
                GENERO,
                MASCOTA_IMAGEN_URL
            )
            VALUES (
                p_id_estado,
                p_id_especie,
                p_id_raza,
                v_id_usuario,
                v_id_cliente,
                p_nombre,
                p_fecha_nacimiento,
                p_genero,
                p_imagen_url
            );

            SET v_id_mascota = LAST_INSERT_ID();

            SELECT 
                v_id_mascota AS ID_MASCOTA,
                (SELECT CODIGO_MASCOTA FROM HUELLITAS_MASCOTA_TB WHERE ID_MASCOTA_PK = v_id_mascota) AS CODIGO_MASCOTA,
                1 AS EXITO,
                '🐾 Mascota registrada correctamente.' AS MENSAJE;
        END IF;
    END IF;

END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_EDITAR_MASCOTA_SP
-- DESCRIPCIÓN: Procedimiento almacenado para editar mascotas
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_EDITAR_MASCOTA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_EDITAR_MASCOTA_SP(
    IN p_codigo_mascota   VARCHAR(30),
    IN p_id_estado        INT,
    IN p_id_especie       INT,
    IN p_id_raza          INT,
    IN p_nombre           VARCHAR(100),
    IN p_fecha_nacimiento DATE,
    IN p_genero           VARCHAR(10),
    IN p_imagen_url       VARCHAR(500),
    IN p_modificado_por   VARCHAR(50)
)
BEGIN
    DECLARE v_id_mascota INT DEFAULT NULL;
    DECLARE v_id_usuario INT DEFAULT NULL;
    DECLARE v_id_cliente INT DEFAULT NULL;
    DECLARE v_existente  INT DEFAULT 0;

    -- =====================================
    -- OBTENER ID DE LA MASCOTA
    -- =====================================
    SELECT 
        ID_MASCOTA_PK,
        ID_USUARIO_FK,
        ID_CLIENTE_FK
    INTO 
        v_id_mascota,
        v_id_usuario,
        v_id_cliente
    FROM HUELLITAS_MASCOTA_TB
    WHERE CODIGO_MASCOTA = p_codigo_mascota
    LIMIT 1;

    -- Si no existe
    IF v_id_mascota IS NULL THEN
        SELECT
            NULL AS ID_MASCOTA,
            p_codigo_mascota AS CODIGO_MASCOTA,
            0 AS EXITO,
            '⚠ La mascota no existe.' AS MENSAJE;
    ELSE

        -- =====================================
        -- VALIDAR DUPLICADO (MISMO DUEÑO)
        -- =====================================
        SELECT COUNT(*)
        INTO v_existente
        FROM HUELLITAS_MASCOTA_TB
        WHERE NOMBRE_MASCOTA = p_nombre
          AND FECHA_NACIMIENTO = p_fecha_nacimiento
          AND (
                (v_id_usuario IS NOT NULL AND ID_USUARIO_FK = v_id_usuario)
                OR
                (v_id_cliente IS NOT NULL AND ID_CLIENTE_FK = v_id_cliente)
              )
          AND ID_MASCOTA_PK <> v_id_mascota; -- excluir actual

        IF v_existente > 0 THEN
            SELECT
                v_id_mascota AS ID_MASCOTA,
                p_codigo_mascota AS CODIGO_MASCOTA,
                0 AS EXITO,
                '⚠ Ya existe otra mascota con este nombre y fecha para el mismo dueño.' AS MENSAJE;
        ELSE

            -- =====================================
            -- ACTUALIZAR (SIN MODIFICAR DUEÑO)
            -- =====================================
            UPDATE HUELLITAS_MASCOTA_TB
            SET 
                ID_ESTADO_FK          = p_id_estado,
                ID_MASCOTA_ESPECIE_FK = p_id_especie,
                ID_MASCOTA_RAZA_FK    = p_id_raza,
                NOMBRE_MASCOTA        = p_nombre,
                FECHA_NACIMIENTO      = p_fecha_nacimiento,
                GENERO                = p_genero,
                MASCOTA_IMAGEN_URL    = p_imagen_url
            WHERE ID_MASCOTA_PK = v_id_mascota;

            SELECT
                v_id_mascota AS ID_MASCOTA,
                p_codigo_mascota AS CODIGO_MASCOTA,
                1 AS EXITO,
                '🐾 Mascota actualizada correctamente.' AS MENSAJE;
        END IF;

    END IF;

END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGREGAR_HISTORIAL_MEDICO_SP
-- DESCRIPCIÓN: Procedimiento para agregar histiriales medicos asociados a una mascota.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGREGAR_HISTORIAL_MEDICO_SP;
DELIMITER $$

CREATE PROCEDURE HUELLITAS_AGREGAR_HISTORIAL_MEDICO_SP(
    IN P_CODIGO_MASCOTA VARCHAR(30),
    IN P_ID_ESTADO INT,

    IN P_HISTORIA_CLINICA TEXT,
    IN P_ANAMNESIS TEXT,

    IN P_PESO DECIMAL(5,2),
    IN P_TEMPERATURA DECIMAL(4,1),
    IN P_FRECUENCIA_CARDIACA INT,
    IN P_FRECUENCIA_RESPIRATORIA INT,

    IN P_SONIDOS_PULMONARES VARCHAR(500),
    IN P_CONDICION_CORPORAL VARCHAR(255),
    IN P_REFLEJO_DEGLUTORIO VARCHAR(255),
    IN P_REFLEJO_TUSIGENO VARCHAR(255),
    IN P_LINFONODOS VARCHAR(255),
    IN P_PALPACION_ABDOMINAL VARCHAR(500),
    IN P_PIEL VARCHAR(500),
    IN P_MUCOSA VARCHAR(255),
    IN P_PULSO VARCHAR(255),
    IN P_ESTADO_MENTAL VARCHAR(255),

    IN P_LISTA_DIAGNOSTICO_PRESUNTIVO TEXT,
    IN P_LISTA_DEPURADA TEXT,
    IN P_EXAMENES TEXT,
    IN P_DIAGNOSTICO_FINAL TEXT,

    IN P_HISTORIAL_DIAGNOSTICO VARCHAR(1000),
    IN P_HISTORIAL_TRATAMIENTO VARCHAR(1000),
    IN P_HISTORIAL_NOTAS VARCHAR(1000)
)
BEGIN
    -- ==========================================
    -- Validar que el código de mascota exista
    -- ==========================================
    IF NOT EXISTS (
        SELECT 1 
        FROM HUELLITAS_MASCOTA_TB 
        WHERE CODIGO_MASCOTA = P_CODIGO_MASCOTA
    ) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'El código de mascota especificado no existe.';
    END IF;

    -- ==========================================
    -- Inserción del historial médico
    -- ==========================================
    INSERT INTO HUELLITAS_HISTORIALES_MEDICOS_TB (
        CODIGO_MASCOTA,
        ID_ESTADO_FK,

        HISTORIA_CLINICA,
        ANAMNESIS,

        PESO,
        TEMPERATURA,
        FRECUENCIA_CARDIACA,
        FRECUENCIA_RESPIRATORIA,

        SONIDOS_PULMONARES,
        CONDICION_CORPORAL,
        REFLEJO_DEGLUTORIO,
        REFLEJO_TUSIGENO,
        LINFONODOS,
        PALPACION_ABDOMINAL,
        PIEL,
        MUCOSA,
        PULSO,
        ESTADO_MENTAL,

        LISTA_DIAGNOSTICO_PRESUNTIVO,
        LISTA_DEPURADA,
        EXAMENES,
        DIAGNOSTICO_FINAL,

        HISTORIAL_DIAGNOSTICO,
        HISTORIAL_TRATAMIENTO,
        HISTORIAL_NOTAS
    )
    VALUES (
        P_CODIGO_MASCOTA,
        P_ID_ESTADO,

        P_HISTORIA_CLINICA,
        P_ANAMNESIS,

        P_PESO,
        P_TEMPERATURA,
        P_FRECUENCIA_CARDIACA,
        P_FRECUENCIA_RESPIRATORIA,

        P_SONIDOS_PULMONARES,
        P_CONDICION_CORPORAL,
        P_REFLEJO_DEGLUTORIO,
        P_REFLEJO_TUSIGENO,
        P_LINFONODOS,
        P_PALPACION_ABDOMINAL,
        P_PIEL,
        P_MUCOSA,
        P_PULSO,
        P_ESTADO_MENTAL,

        P_LISTA_DIAGNOSTICO_PRESUNTIVO,
        P_LISTA_DEPURADA,
        P_EXAMENES,
        P_DIAGNOSTICO_FINAL,

        P_HISTORIAL_DIAGNOSTICO,
        P_HISTORIAL_TRATAMIENTO,
        P_HISTORIAL_NOTAS
    );
END $$

DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_ACTUALIZAR_HISTORIAL_MEDICO_SP
-- DESCRIPCIÓN: Actualiza los datos de un historial médico existente
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_ACTUALIZAR_HISTORIAL_MEDICO_SP;
DELIMITER $$

CREATE PROCEDURE HUELLITAS_ACTUALIZAR_HISTORIAL_MEDICO_SP(
    IN P_CODIGO_HISTORIAL VARCHAR(30),
    IN P_ID_ESTADO INT,

    -- Datos clínicos
    IN P_HISTORIA_CLINICA TEXT,
    IN P_ANAMNESIS TEXT,

    -- Signos vitales
    IN P_PESO DECIMAL(5,2),
    IN P_TEMPERATURA DECIMAL(4,1),
    IN P_FRECUENCIA_CARDIACA INT,
    IN P_FRECUENCIA_RESPIRATORIA INT,

    -- Exploración física
    IN P_SONIDOS_PULMONARES VARCHAR(500),
    IN P_CONDICION_CORPORAL VARCHAR(255),
    IN P_REFLEJO_DEGLUTORIO VARCHAR(255),
    IN P_REFLEJO_TUSIGENO VARCHAR(255),
    IN P_LINFONODOS VARCHAR(255),
    IN P_PALPACION_ABDOMINAL VARCHAR(500),
    IN P_PIEL VARCHAR(500),
    IN P_MUCOSA VARCHAR(255),
    IN P_PULSO VARCHAR(255),
    IN P_ESTADO_MENTAL VARCHAR(255),

    -- Diagnósticos
    IN P_LISTA_DIAGNOSTICO_PRESUNTIVO TEXT,
    IN P_LISTA_DEPURADA TEXT,
    IN P_EXAMENES TEXT,
    IN P_DIAGNOSTICO_FINAL TEXT
)
BEGIN
    -- Validar que el historial exista
    IF NOT EXISTS (
        SELECT 1 FROM HUELLITAS_HISTORIALES_MEDICOS_TB 
        WHERE CODIGO_HISTORIAL = P_CODIGO_HISTORIAL
    ) THEN
        SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'El código de historial no existe.';
    END IF;

    -- Actualizar el registro
    UPDATE HUELLITAS_HISTORIALES_MEDICOS_TB
    SET 
        ID_ESTADO_FK = P_ID_ESTADO,

        HISTORIA_CLINICA = P_HISTORIA_CLINICA,
        ANAMNESIS = P_ANAMNESIS,

        PESO = P_PESO,
        TEMPERATURA = P_TEMPERATURA,
        FRECUENCIA_CARDIACA = P_FRECUENCIA_CARDIACA,
        FRECUENCIA_RESPIRATORIA = P_FRECUENCIA_RESPIRATORIA,

        SONIDOS_PULMONARES = P_SONIDOS_PULMONARES,
        CONDICION_CORPORAL = P_CONDICION_CORPORAL,
        REFLEJO_DEGLUTORIO = P_REFLEJO_DEGLUTORIO,
        REFLEJO_TUSIGENO = P_REFLEJO_TUSIGENO,
        LINFONODOS = P_LINFONODOS,
        PALPACION_ABDOMINAL = P_PALPACION_ABDOMINAL,
        PIEL = P_PIEL,
        MUCOSA = P_MUCOSA,
        PULSO = P_PULSO,
        ESTADO_MENTAL = P_ESTADO_MENTAL,

        LISTA_DIAGNOSTICO_PRESUNTIVO = P_LISTA_DIAGNOSTICO_PRESUNTIVO,
        LISTA_DEPURADA = P_LISTA_DEPURADA,
        EXAMENES = P_EXAMENES,
        DIAGNOSTICO_FINAL = P_DIAGNOSTICO_FINAL

    WHERE CODIGO_HISTORIAL = P_CODIGO_HISTORIAL;
END$$

DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_HISTORIALES_RESUMEN_SP
-- DESCRIPCIÓN: Listar todos los historiales medicos de la mascota solo obteniendo fechas y el codigo
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_HISTORIALES_RESUMEN_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_HISTORIALES_RESUMEN_SP(
    IN P_CODIGO_MASCOTA VARCHAR(30)
)
BEGIN
    SELECT 
        H.ID_HISTORIAL_PK,
        H.CODIGO_HISTORIAL,
        H.HISTORIAL_FECHA,
        H.HISTORIAL_HORA
    FROM HUELLITAS_HISTORIALES_MEDICOS_TB H
    WHERE H.CODIGO_MASCOTA = P_CODIGO_MASCOTA
    ORDER BY H.HISTORIAL_FECHA DESC, H.HISTORIAL_HORA DESC;
END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_HISTORIAL_COMPLETO_SP
-- DESCRIPCIÓN: Obtener 
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_HISTORIAL_COMPLETO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_HISTORIAL_COMPLETO_SP(
    IN P_CODIGO_HISTORIAL VARCHAR(30)
)
BEGIN
    SELECT 
        H.*,
        E.ESTADO_DESCRIPCION AS ESTADO
    FROM HUELLITAS_HISTORIALES_MEDICOS_TB H
    INNER JOIN HUELLITAS_ESTADO_TB E
        ON H.ID_ESTADO_FK = E.ID_ESTADO_PK
    WHERE P_CODIGO_HISTORIAL IS NOT NULL AND H.CODIGO_HISTORIAL = P_CODIGO_HISTORIAL
    LIMIT 1;
END $$

DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_OBTENER_MASCOTA_POR_CODIGO_SP
-- DESCRIPCIÓN: Obtiene toda la información de una mascota según su código
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_MASCOTA_POR_CODIGO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_MASCOTA_POR_CODIGO_SP(
    IN P_CODIGO_MASCOTA VARCHAR(30)
)
BEGIN

    SELECT 
        M.ID_MASCOTA_PK,
        M.CODIGO_MASCOTA,
        M.NOMBRE_MASCOTA,
        M.FECHA_NACIMIENTO,
        M.GENERO,
        M.MASCOTA_IMAGEN_URL,

        -- Estado
        E.ESTADO_DESCRIPCION AS ESTADO,

        -- Especie y raza
        ES.ID_MASCOTA_ESPECIE_PK AS ID_ESPECIE_FK,
        ES.NOMBRE_ESPECIE AS ESPECIE,
        R.ID_MASCOTA_RAZA_PK AS ID_MASCOTA_RAZA_FK,
        R.NOMBRE_RAZA AS RAZA,

        -- Dueño Cliente (si existe)
        C.ID_CLIENTE_PK AS CLIENTE_ID,
        C.CODIGO_CLIENTE AS CODIGO_CLIENTE,
        C.CLIENTE_NOMBRE AS CLIENTE_NOMBRE,
        C.CLIENTE_CORREO AS CLIENTE_CORREO,

        -- Dueño Usuario (si existe)
        U.ID_USUARIO_PK AS USUARIO_ID,
        U.CODIGO_USUARIO AS CODIGO_USUARIO,
        U.USUARIO_NOMBRE AS USUARIO_NOMBRE,
        U.USUARIO_CORREO AS USUARIO_CORREO

    FROM HUELLITAS_MASCOTA_TB M
    INNER JOIN HUELLITAS_ESTADO_TB E 
        ON M.ID_ESTADO_FK = E.ID_ESTADO_PK
    INNER JOIN HUELLITAS_MASCOTA_ESPECIE_TB ES 
        ON M.ID_MASCOTA_ESPECIE_FK = ES.ID_MASCOTA_ESPECIE_PK
    LEFT JOIN HUELLITAS_MASCOTA_RAZA_TB R 
        ON M.ID_MASCOTA_RAZA_FK = R.ID_MASCOTA_RAZA_PK

    LEFT JOIN HUELLITAS_CLIENTES_TB C 
        ON M.ID_CLIENTE_FK = C.ID_CLIENTE_PK

    LEFT JOIN HUELLITAS_USUARIOS_TB U 
        ON M.ID_USUARIO_FK = U.ID_USUARIO_PK

    WHERE M.CODIGO_MASCOTA = P_CODIGO_MASCOTA
    LIMIT 1;

END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_HISTORIALES_MASCOTA_CODIGO_SP
-- DESCRIPCIÓN: Procedimiento para listar todos los procedimientos almacenados de una mascota.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_HISTORIALES_MASCOTA_CODIGO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_HISTORIALES_MASCOTA_CODIGO_SP(
    IN P_CODIGO_MASCOTA VARCHAR(30)
)
BEGIN
    SELECT
        C.ID_CONSULTA_PK AS ID,
        C.CONSULTA_FECHA AS FECHA,
        DATE_FORMAT(H.HISTORIAL_FECHA_REGISTRO, '%H:%i:%s') AS HORA,
        M.DESCRIPCION_MOTIVO AS MOTIVO
    FROM HUELLITAS_MASCOTA_TB MS
    INNER JOIN HUELLITAS_HISTORIALES_MEDICOS_TB H 
        ON MS.ID_MASCOTA_PK = H.ID_MASCOTA_FK
    INNER JOIN HUELLITAS_CONSULTAS_TB C 
        ON H.ID_CONSULTA_FK = C.ID_CONSULTA_PK
    INNER JOIN HUELLITAS_CONSULTA_MOTIVO_TB M
        ON C.ID_CONSULTA_MOTIVO_FK = M.ID_CONSULTA_MOTIVO_PK
    WHERE MS.CODIGO_MASCOTA = P_CODIGO_MASCOTA
    ORDER BY C.CONSULTA_FECHA DESC, H.HISTORIAL_FECHA_REGISTRO DESC;
END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_ESPECIES_SP
-- DESCRIPCIÓN: Procedimiento para listar las especies de mascotas
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_ESPECIES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_ESPECIES_SP()
BEGIN
    SELECT 
        ID_MASCOTA_ESPECIE_PK,
        NOMBRE_ESPECIE
    FROM HUELLITAS_MASCOTA_ESPECIE_TB
    WHERE ID_ESTADO_FK = 1
    ORDER BY NOMBRE_ESPECIE ASC;
END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_RAZAS_SP
-- DESCRIPCIÓN: Procedimiento para listar todas las razas de las mascotas
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_RAZAS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_RAZAS_SP()
BEGIN
    SELECT 
        ID_MASCOTA_RAZA_PK,
        NOMBRE_RAZA
    FROM HUELLITAS_MASCOTA_RAZA_TB
    WHERE ID_ESTADO_FK = 1
    ORDER BY NOMBRE_RAZA ASC;
END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_RAZAS_POR_ESPECIE_SP
-- DESCRIPCIÓN: Procedimiento para listar todas las razas por especie
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_RAZAS_POR_ESPECIE_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_RAZAS_POR_ESPECIE_SP(
    IN P_ID_ESPECIE INT
)
BEGIN
    SELECT 
        R.ID_MASCOTA_RAZA_PK,
        R.NOMBRE_RAZA
    FROM HUELLITAS_MASCOTA_RAZA_TB R
    WHERE 
        R.ID_ESTADO_FK = 1
        AND R.ID_MASCOTA_ESPECIE_FK = P_ID_ESPECIE
    ORDER BY R.NOMBRE_RAZA ASC;
END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_BUSCAR_RAZAS_POR_ESPECIE_SP
-- DESCRIPCIÓN: Procedimiento para buscar todas las razas por especie
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_BUSCAR_RAZAS_POR_ESPECIE_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_BUSCAR_RAZAS_POR_ESPECIE_SP(
    IN P_ID_ESPECIE INT,
    IN P_BUSQUEDA VARCHAR(100)
)
BEGIN
    SELECT 
        R.ID_MASCOTA_RAZA_PK,
        R.NOMBRE_RAZA
    FROM HUELLITAS_MASCOTA_RAZA_TB R
    WHERE 
        R.ID_ESTADO_FK = 1
        AND R.ID_MASCOTA_ESPECIE_FK = P_ID_ESPECIE
        AND (
            P_BUSQUEDA = '' OR
            R.NOMBRE_RAZA LIKE CONCAT('%', P_BUSQUEDA, '%')
        )
    ORDER BY R.NOMBRE_RAZA ASC;
END $$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_AGENDAR_CITA_SP
-- DESCRIPCIÓN: Procedimiento para agendar citas
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_AGENDAR_CITA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_AGENDAR_CITA_SP(
    IN P_ID_VETERINARIO INT,
    IN P_ID_SERVICIO INT,
    IN P_CODIGO_CLIENTE VARCHAR(30),
    IN P_CODIGO_USUARIO VARCHAR(30),
    IN P_FECHA_INICIO DATETIME,
    IN P_FECHA_FIN DATETIME,
    IN P_MOTIVO VARCHAR(500),
    IN P_JSON_MASCOTAS JSON,
    IN P_CLIENTE_MANUAL JSON,

    OUT P_ID_CITA INT,
    OUT P_MENSAJE VARCHAR(300)
)
BEGIN
    DECLARE V_EXISTE INT DEFAULT 0;
    DECLARE V_ID_ESTADO_ACTIVO INT DEFAULT 1;

    DECLARE V_NOMBRE VARCHAR(200);
    DECLARE V_CORREO VARCHAR(150);
    DECLARE V_TELEFONO VARCHAR(30);
    DECLARE V_IDENTIFICACION VARCHAR(30);
    DECLARE V_MASCOTA_MANUAL VARCHAR(200);
    
	DECLARE v_id_mascota INT DEFAULT NULL;
    DECLARE mascota_codigo VARCHAR(30);
    DECLARE total INT DEFAULT 0;
    DECLARE i INT DEFAULT 0;

    SET P_ID_CITA = NULL;
    SET P_MENSAJE = '';


    /* ==========================================
       VALIDAR VETERINARIO
    ========================================== */
    SELECT COUNT(*) INTO V_EXISTE
    FROM HUELLITAS_USUARIOS_TB
    WHERE ID_USUARIO_PK = P_ID_VETERINARIO
      AND ID_ESTADO_FK = V_ID_ESTADO_ACTIVO;

    IF V_EXISTE = 0 THEN
        SET P_MENSAJE = 'El veterinario no existe o está inactivo.';
    ELSE

        /* ==========================================
           VALIDAR SERVICIO
        ========================================== */
        SELECT COUNT(*) INTO V_EXISTE
        FROM HUELLITAS_SERVICIOS_TB
        WHERE ID_SERVICIO_PK = P_ID_SERVICIO
          AND ID_ESTADO_FK = V_ID_ESTADO_ACTIVO;

        IF V_EXISTE = 0 THEN
            SET P_MENSAJE = 'El servicio no existe o está inactivo.';
        ELSE

			/* ==========================================
			   VALIDAR DISPONIBILIDAD HORARIA
			========================================== */
			SELECT COUNT(*) INTO V_EXISTE
			FROM HUELLITAS_CITAS_TB
			WHERE ID_VETERINARIO_FK = P_ID_VETERINARIO
			  AND ID_ESTADO_FK = V_ID_ESTADO_ACTIVO
			  AND (
					(P_FECHA_INICIO BETWEEN FECHA_INICIO AND FECHA_FIN)
				 OR (P_FECHA_FIN   BETWEEN FECHA_INICIO AND FECHA_FIN)
				 OR (FECHA_INICIO  BETWEEN P_FECHA_INICIO AND P_FECHA_FIN)
				  );

			IF V_EXISTE > 0 THEN
				SET P_MENSAJE = 'El veterinario ya tiene una cita activa en ese horario.';
			ELSE

                /* ======================================================
                   OBTENER DATOS DEL CLIENTE (MANUAL, REGISTRADO O USUARIO)
                ====================================================== */

                -- Caso 1: Cliente manual
                IF P_CLIENTE_MANUAL IS NOT NULL AND JSON_VALID(P_CLIENTE_MANUAL) = 1 THEN
                
                    SET V_NOMBRE         = JSON_UNQUOTE(JSON_EXTRACT(P_CLIENTE_MANUAL, '$.nombre'));
                    SET V_CORREO         = JSON_UNQUOTE(JSON_EXTRACT(P_CLIENTE_MANUAL, '$.correo'));
                    SET V_TELEFONO       = JSON_UNQUOTE(JSON_EXTRACT(P_CLIENTE_MANUAL, '$.telefono'));
                    SET V_IDENTIFICACION = JSON_UNQUOTE(JSON_EXTRACT(P_CLIENTE_MANUAL, '$.identificacion'));
                    SET V_MASCOTA_MANUAL = JSON_UNQUOTE(JSON_EXTRACT(P_CLIENTE_MANUAL, '$.mascota'));

                -- Caso 2: Cliente registrado (HUELLITAS_CLIENTES_TB)
                ELSEIF P_CODIGO_CLIENTE IS NOT NULL AND P_CODIGO_CLIENTE <> '' THEN

                    SELECT 
                        CLIENTE_NOMBRE,
                        CLIENTE_CORREO,
                        CLIENTE_IDENTIFICACION,
                        (SELECT TELEFONO_CONTACTO 
                         FROM HUELLITAS_TELEFONO_CONTACTO_TB 
                         WHERE ID_TELEFONO_CONTACTO_PK = c.ID_TELEFONO_CONTACTO_FK)
                    INTO 
                        V_NOMBRE,
                        V_CORREO,
                        V_IDENTIFICACION,
                        V_TELEFONO
                    FROM HUELLITAS_CLIENTES_TB c
                    WHERE c.CODIGO_CLIENTE = P_CODIGO_CLIENTE
                    LIMIT 1;

                -- Caso 3: Usuario registrado (HUELLITAS_USUARIOS_TB)
                ELSEIF P_CODIGO_USUARIO IS NOT NULL AND P_CODIGO_USUARIO <> '' THEN

                    SELECT 
                        USUARIO_NOMBRE,
                        USUARIO_CORREO,
                        USUARIO_IDENTIFICACION,
                        (SELECT TELEFONO_CONTACTO 
                         FROM HUELLITAS_TELEFONO_CONTACTO_TB 
                         WHERE ID_TELEFONO_CONTACTO_PK = u.ID_TELEFONO_CONTACTO_FK)
                    INTO 
                        V_NOMBRE,
                        V_CORREO,
                        V_IDENTIFICACION,
                        V_TELEFONO
                    FROM HUELLITAS_USUARIOS_TB u
                    WHERE u.CODIGO_USUARIO = P_CODIGO_USUARIO
                    LIMIT 1;

                ELSE
                    SET V_NOMBRE = NULL;
                    SET V_CORREO = NULL;
                    SET V_TELEFONO = NULL;
                    SET V_IDENTIFICACION = NULL;
                END IF;


                /* ==========================================
                   INSERTAR CITA
                ========================================== */
                INSERT INTO HUELLITAS_CITAS_TB(
                    ID_VETERINARIO_FK,
                    ID_SERVICIO_FK,
                    CODIGO_CLIENTE,
                    CODIGO_USUARIO,
                    FECHA_INICIO,
                    FECHA_FIN,
                    MOTIVO,
                    ID_ESTADO_FK,
                    CLIENTE_NOMBRE,
                    CLIENTE_CORREO,
                    CLIENTE_TELEFONO,
                    CLIENTE_IDENTIFICACION
                )
                VALUES(
                    P_ID_VETERINARIO,
                    P_ID_SERVICIO,
                    P_CODIGO_CLIENTE,
                    P_CODIGO_USUARIO,
                    P_FECHA_INICIO,
                    P_FECHA_FIN,
                    P_MOTIVO,
                    1,
                    V_NOMBRE,
                    V_CORREO,
                    V_TELEFONO,
                    V_IDENTIFICACION
                );

                SET P_ID_CITA = LAST_INSERT_ID();
                
                /* ==========================================
				   SI ES CLIENTE MANUAL → INSERTAR MASCOTA MANUAL
				========================================== */
				IF V_MASCOTA_MANUAL IS NOT NULL AND V_MASCOTA_MANUAL <> '' THEN
					INSERT INTO HUELLITAS_CITAS_MASCOTAS_TB(
						ID_CITA_FK,
						ID_MASCOTA_FK,
						MASCOTA_NOMBRE_MANUAL
					) VALUES (
						P_ID_CITA,
						NULL,
						V_MASCOTA_MANUAL
					);
				END IF;


                /* ==========================================
				INSERTAR MASCOTAS ASOCIADAS
				========================================== */
				IF P_JSON_MASCOTAS IS NOT NULL 
				   AND JSON_VALID(P_JSON_MASCOTAS) = 1
				   AND JSON_LENGTH(P_JSON_MASCOTAS) > 0 THEN

					SET total = JSON_LENGTH(P_JSON_MASCOTAS);
					SET i = 0;

					WHILE i < total DO

						SET mascota_codigo = JSON_UNQUOTE(
							JSON_EXTRACT(P_JSON_MASCOTAS, CONCAT('$[', i, ']'))
						);

						IF mascota_codigo IS NOT NULL AND mascota_codigo <> '' THEN

							-- Buscar ID real de la mascota
							SELECT ID_MASCOTA_PK INTO v_id_mascota
							FROM HUELLITAS_MASCOTA_TB
							WHERE CODIGO_MASCOTA = mascota_codigo
							LIMIT 1;

							-- Si existe mascota registrada
							IF v_id_mascota IS NOT NULL THEN
								INSERT INTO HUELLITAS_CITAS_MASCOTAS_TB(
									ID_CITA_FK,
									ID_MASCOTA_FK,
									MASCOTA_NOMBRE_MANUAL
								)
								VALUES(
									P_ID_CITA,
									v_id_mascota,
									NULL
								);

							ELSE
								-- Mascota manual (solo nombre)
								INSERT INTO HUELLITITAS_CITAS_MASCOTAS_TB(
									ID_CITA_FK,
									ID_MASCOTA_FK,
									MASCOTA_NOMBRE_MANUAL
								)
								VALUES(
									P_ID_CITA,
									NULL,
									mascota_codigo
								);
							END IF;

						END IF;

						SET i = i + 1;
					END WHILE;
				END IF;


                SET P_MENSAJE = 'Cita agendada correctamente.';

            END IF;
        END IF;
    END IF;

END$$
DELIMITER ;

-- ==========================================
-- NOMBRE: HUELLITAS_CANCELAR_CITA_SP
-- DESCRIPCIÓN: Procedimiento para cancelar citas.
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_CANCELAR_CITA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CANCELAR_CITA_SP(
    IN p_id_cita INT,
    OUT p_mensaje VARCHAR(200)
)
BEGIN
    DECLARE v_estado_cancelado INT DEFAULT 6;

    UPDATE HUELLITAS_CITAS_TB
    SET ID_ESTADO_FK = v_estado_cancelado
    WHERE ID_CITA_PK = p_id_cita;

    SET p_mensaje = 'La cita ha sido cancelada correctamente.';
END$$
DELIMITER ;


-- ==========================================
-- NOMBRE: HUELLITAS_LISTAR_CITAS_FULLCALENDAR_SP
-- DESCRIPCIÓN: Procedimiento obtener las citas agendadas para ser mostradas con fullcalendar
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_CITAS_FULLCALENDAR_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_CITAS_FULLCALENDAR_SP(
    IN P_ID_VETERINARIO INT,
    IN P_CODIGO_CLIENTE VARCHAR(30),
    IN P_CODIGO_USUARIO VARCHAR(30),
    IN P_CODIGO_MASCOTA VARCHAR(30)
)
BEGIN
    SELECT 
        C.ID_CITA_PK AS id,
        C.FECHA_INICIO AS start,
        C.FECHA_FIN AS end,

        CONCAT('Servicio: ', S.NOMBRE_SERVICIO) AS title,

        -- Mascotas registradas + manuales
        GROUP_CONCAT(
            COALESCE(M.NOMBRE_MASCOTA, CM.MASCOTA_NOMBRE_MANUAL)
            SEPARATOR ', '
        ) AS MASCOTAS,

        C.CLIENTE_NOMBRE,
        C.CODIGO_CLIENTE,
        C.CODIGO_USUARIO,
        U.USUARIO_NOMBRE AS veterinario,
        S.NOMBRE_SERVICIO AS servicio,
        C.MOTIVO,
        C.ID_ESTADO_FK

    FROM HUELLITAS_CITAS_TB C
    INNER JOIN HUELLITAS_USUARIOS_TB U 
        ON C.ID_VETERINARIO_FK = U.ID_USUARIO_PK
    INNER JOIN HUELLITAS_SERVICIOS_TB S
        ON C.ID_SERVICIO_FK = S.ID_SERVICIO_PK

    LEFT JOIN HUELLITAS_CITAS_MASCOTAS_TB CM
        ON CM.ID_CITA_FK = C.ID_CITA_PK

    LEFT JOIN HUELLITAS_MASCOTA_TB M
        ON CM.ID_MASCOTA_FK = M.ID_MASCOTA_PK   -- CORRECTO AHORA

    WHERE 
        C.ID_ESTADO_FK = 1
        AND (P_ID_VETERINARIO IS NULL OR C.ID_VETERINARIO_FK = P_ID_VETERINARIO)
        AND (P_CODIGO_CLIENTE IS NULL OR C.CODIGO_CLIENTE = P_CODIGO_CLIENTE)
        AND (P_CODIGO_USUARIO IS NULL OR C.CODIGO_USUARIO = P_CODIGO_USUARIO)

        -- Filtrar si buscan por mascota
        AND (
            P_CODIGO_MASCOTA IS NULL 
            OR M.CODIGO_MASCOTA = P_CODIGO_MASCOTA
        )

    GROUP BY C.ID_CITA_PK
    ORDER BY C.FECHA_INICIO ASC;
END$$
DELIMITER ;

-- ======================================================
-- NOMBRE: HUELLITAS_OBTENER_CITAS_FULL_SP
-- DESCRIPCIÓN: Obtener todos los datos de las citas agendadas.
-- ======================================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_CITAS_FULL_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_CITAS_FULL_SP()
BEGIN
    SELECT
        -- =============== DATOS DE LA CITA =================
        c.ID_CITA_PK,
        c.CODIGO_CLIENTE,
        c.CODIGO_USUARIO,
        c.CLIENTE_NOMBRE AS CLIENTE_MANUAL_NOMBRE,
        c.CLIENTE_CORREO AS CLIENTE_MANUAL_CORREO,
        c.CLIENTE_TELEFONO AS CLIENTE_MANUAL_TELEFONO,
        c.CLIENTE_IDENTIFICACION AS CLIENTE_MANUAL_IDENTIFICACION,

        c.FECHA_INICIO,
        c.FECHA_FIN,
        c.MOTIVO,
        c.FECHA_CREACION,

        -- Estado de la cita
        est.ESTADO_DESCRIPCION AS ESTADO_CITA,

        -- =============== DATOS DEL USUARIO CLIENTE =================
        u.ID_USUARIO_PK AS USUARIO_ID,
        u.USUARIO_NOMBRE AS USUARIO_NOMBRE,
        u.USUARIO_CORREO AS USUARIO_CORREO,
        u.USUARIO_IDENTIFICACION AS USUARIO_IDENTIFICACION,

        cli.ID_CLIENTE_PK AS CLIENTE_ID,
        cli.CLIENTE_NOMBRE AS CLIENTE_NOMBRE,
        cli.CLIENTE_CORREO AS CLIENTE_CORREO,
        cli.CLIENTE_IDENTIFICACION AS CLIENTE_IDENTIFICACION,

        -- =============== DATOS DEL VETERINARIO =================
        vet.ID_USUARIO_PK AS VETERINARIO_ID,
        vet.USUARIO_NOMBRE AS VETERINARIO_NOMBRE,
        vet.USUARIO_CORREO AS VETERINARIO_CORREO,
        vet.USUARIO_IMAGEN_URL AS VETERINARIO_IMAGEN,

        -- =============== SERVICIO =================
        s.ID_SERVICIO_PK AS SERVICIO_ID,
        s.NOMBRE_SERVICIO,
        s.DESCRIPCION_SERVICIO,
        s.IMAGEN_URL AS SERVICIO_IMAGEN,

        -- =============== MASCOTAS =================
        cm.ID_CITA_MASCOTA_PK,
        m.ID_MASCOTA_PK,
        m.CODIGO_MASCOTA,
        m.NOMBRE_MASCOTA,
        m.MASCOTA_IMAGEN_URL,
        m.GENERO AS MASCOTA_GENERO,
        m.FECHA_NACIMIENTO AS MASCOTA_FECHA_NACIMIENTO,

        -- Mascota manual
        cm.MASCOTA_NOMBRE_MANUAL

    FROM HUELLITAS_CITAS_TB c

    -- Estado
    INNER JOIN HUELLITAS_ESTADO_TB est
        ON est.ID_ESTADO_PK = c.ID_ESTADO_FK

    -- Veterinario
    INNER JOIN HUELLITAS_USUARIOS_TB vet
        ON vet.ID_USUARIO_PK = c.ID_VETERINARIO_FK

    -- Servicio
    INNER JOIN HUELLITAS_SERVICIOS_TB s
        ON s.ID_SERVICIO_PK = c.ID_SERVICIO_FK

    -- Cliente registrado mediante CODIGO_USUARIO (opcional)
    LEFT JOIN HUELLITAS_USUARIOS_TB u
        ON u.CODIGO_USUARIO = c.CODIGO_USUARIO

    -- Cliente registrado mediante CODIGO_CLIENTE (opcional)
    LEFT JOIN HUELLITAS_CLIENTES_TB cli
        ON cli.CODIGO_CLIENTE = c.CODIGO_CLIENTE

    -- Mascotas de la cita
    LEFT JOIN HUELLITAS_CITAS_MASCOTAS_TB cm
        ON cm.ID_CITA_FK = c.ID_CITA_PK

    LEFT JOIN HUELLITAS_MASCOTA_TB m
        ON m.ID_MASCOTA_PK = cm.ID_MASCOTA_FK

    ORDER BY c.FECHA_INICIO ASC, c.ID_CITA_PK;
END$$
DELIMITER ;

-- ======================================================
-- NOMBRE: HUELLITAS_LISTAR_PROXIMAS_CITAS_SP
-- DESCRIPCIÓN: Lista las citas FUTURAS de un usuario
-- ======================================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_PROXIMAS_CITAS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_PROXIMAS_CITAS_SP(
    IN P_CODIGO_USUARIO VARCHAR(30)
)
BEGIN
    SELECT 
        C.ID_CITA_PK,
        C.CODIGO_USUARIO,
        C.CODIGO_CLIENTE,

        C.FECHA_INICIO,
        C.FECHA_FIN,
        C.MOTIVO,
        C.FECHA_CREACION,

        E.ESTADO_DESCRIPCION AS ESTADO,

        S.NOMBRE_SERVICIO,

        U.USUARIO_NOMBRE AS VETERINARIO_NOMBRE,
        U.USUARIO_CORREO AS VETERINARIO_CORREO,

        C.CLIENTE_NOMBRE,
        C.CLIENTE_CORREO,
        C.CLIENTE_TELEFONO,
        C.CLIENTE_IDENTIFICACION,

        M.ID_MASCOTA_FK,
        MS.CODIGO_MASCOTA,
        MS.NOMBRE_MASCOTA,
        M.MASCOTA_NOMBRE_MANUAL

    FROM HUELLITAS_CITAS_TB C
    INNER JOIN HUELLITAS_ESTADO_TB E ON C.ID_ESTADO_FK = E.ID_ESTADO_PK
    INNER JOIN HUELLITAS_SERVICIOS_TB S ON C.ID_SERVICIO_FK = S.ID_SERVICIO_PK
    INNER JOIN HUELLITAS_USUARIOS_TB U ON C.ID_VETERINARIO_FK = U.ID_USUARIO_PK
    LEFT JOIN HUELLITAS_CITAS_MASCOTAS_TB M ON C.ID_CITA_PK = M.ID_CITA_FK
    LEFT JOIN HUELLITAS_MASCOTA_TB MS ON M.ID_MASCOTA_FK = MS.ID_MASCOTA_PK

    WHERE C.CODIGO_USUARIO = P_CODIGO_USUARIO
      AND C.FECHA_FIN > NOW()

    ORDER BY C.FECHA_INICIO ASC;
END $$
DELIMITER ;

-- ======================================================
-- NOMBRE: HUELLITAS_LISTAR_CITAS_PASADAS_SP
-- DESCRIPCIÓN: Lista las citas PASADAS de un usuario
-- ======================================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_CITAS_PASADAS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_CITAS_PASADAS_SP(
    IN P_CODIGO_USUARIO VARCHAR(30)
)
BEGIN
    SELECT 
        C.ID_CITA_PK,
        C.CODIGO_USUARIO,
        C.CODIGO_CLIENTE,

        C.FECHA_INICIO,
        C.FECHA_FIN,
        C.MOTIVO,
        C.FECHA_CREACION,

        E.ESTADO_DESCRIPCION AS ESTADO,

        S.NOMBRE_SERVICIO,

        U.USUARIO_NOMBRE AS VETERINARIO_NOMBRE,
        U.USUARIO_CORREO AS VETERINARIO_CORREO,

        C.CLIENTE_NOMBRE,
        C.CLIENTE_CORREO,
        C.CLIENTE_TELEFONO,
        C.CLIENTE_IDENTIFICACION,

        M.ID_MASCOTA_FK,
        MS.CODIGO_MASCOTA,
        MS.NOMBRE_MASCOTA,
        M.MASCOTA_NOMBRE_MANUAL

    FROM HUELLITAS_CITAS_TB C
    INNER JOIN HUELLITAS_ESTADO_TB E ON C.ID_ESTADO_FK = E.ID_ESTADO_PK
    INNER JOIN HUELLITAS_SERVICIOS_TB S ON C.ID_SERVICIO_FK = S.ID_SERVICIO_PK
    INNER JOIN HUELLITAS_USUARIOS_TB U ON C.ID_VETERINARIO_FK = U.ID_USUARIO_PK
    LEFT JOIN HUELLITAS_CITAS_MASCOTAS_TB M ON C.ID_CITA_PK = M.ID_CITA_FK
    LEFT JOIN HUELLITAS_MASCOTA_TB MS ON M.ID_MASCOTA_FK = MS.ID_MASCOTA_PK

    WHERE C.CODIGO_USUARIO = P_CODIGO_USUARIO
      AND C.FECHA_FIN < NOW()

    ORDER BY C.FECHA_INICIO DESC;
END $$
DELIMITER ;



-- ======================================================
-- NOMBRE: HUELLITAS_CLIENTE_EXISTE_SP
-- DESCRIPCIÓN: Verifica si existe un cliente veterinario por correo
-- ======================================================
DROP PROCEDURE IF EXISTS HUELLITAS_CLIENTE_EXISTE_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_CLIENTE_EXISTE_SP(
    IN P_CORREO VARCHAR(100)
)
BEGIN
    SELECT 
        ID_CLIENTE_PK
    FROM HUELLITAS_CLIENTES_TB
    WHERE CLIENTE_CORREO = P_CORREO
    LIMIT 1;
END $$
DELIMITER ;

-- ======================================================
-- NOMBRE: HUELLITAS_LISTAR_EMPLEADOS_SP
-- DESCRIPCIÓN: Procedimiento almacenado para listar los usuarios con rol de empleado
-- ======================================================
DROP PROCEDURE IF EXISTS HUELLITAS_LISTAR_EMPLEADOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_LISTAR_EMPLEADOS_SP()
BEGIN
    SELECT 
        u.ID_USUARIO_PK,
        u.CODIGO_USUARIO,
        u.USUARIO_NOMBRE,
        u.USUARIO_CORREO,
        u.USUARIO_IDENTIFICACION,
        u.ID_ROL_USUARIO_FK,
        ru.DESCRIPCION_ROL_USUARIO AS ROL,
        u.ID_ESTADO_FK,
        e.ESTADO_DESCRIPCION AS ESTADO,
        u.ID_DIRECCION_FK,
        u.ID_TELEFONO_CONTACTO_FK,
        u.USUARIO_IMAGEN_URL
    FROM HUELLITAS_USUARIOS_TB u
    INNER JOIN HUELLITAS_ROL_USUARIO_TB ru 
        ON ru.ID_ROL_USUARIO_PK = u.ID_ROL_USUARIO_FK
    INNER JOIN HUELLITAS_ESTADO_TB e 
        ON e.ID_ESTADO_PK = u.ID_ESTADO_FK
    WHERE u.ID_ROL_USUARIO_FK = (
        SELECT ID_ROL_USUARIO_PK 
        FROM HUELLITAS_ROL_USUARIO_TB 
        WHERE DESCRIPCION_ROL_USUARIO = 'EMPLEADO'
        LIMIT 1
    )
    AND u.ID_ESTADO_FK = 1
    ORDER BY u.USUARIO_NOMBRE ASC;

END$$
DELIMITER ;

-- ======================================================
-- NOMBRE: HUELLITAS_OBTENER_CITAS_MANANA_SP
-- DESCRIPCIÓN: Procedimiento para obtener las citas de mañana
-- ======================================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_CITAS_MANANA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_CITAS_MANANA_SP()
BEGIN
    SELECT 
        C.ID_CITA_PK,
        C.CLIENTE_NOMBRE,
        C.CLIENTE_CORREO,
        C.MOTIVO,
        C.FECHA_INICIO,
        GROUP_CONCAT(
            IFNULL(M.NOMBRE_MASCOTA, CM.MASCOTA_NOMBRE_MANUAL)
            SEPARATOR ', '
        ) AS MASCOTAS
    FROM HUELLITAS_CITAS_TB C
    LEFT JOIN HUELLITAS_CITAS_MASCOTAS_TB CM 
        ON CM.ID_CITA_FK = C.ID_CITA_PK
    LEFT JOIN HUELLITAS_MASCOTA_TB M 
        ON M.ID_MASCOTA_PK = CM.ID_MASCOTA_FK
    WHERE DATE(C.FECHA_INICIO) = CURDATE() + INTERVAL 1 DAY
    GROUP BY C.ID_CITA_PK;
END$$
DELIMITER ;

-- ======================================================
-- NOMBRE: HUELLITAS_OBTENER_CITAS_EN_1_HORA_SP
-- DESCRIPCIÓN: Procedimiento para obtener las citas de dentro de una hora
-- ======================================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_CITAS_EN_1_HORA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_CITAS_EN_1_HORA_SP()
BEGIN
    SELECT 
        C.ID_CITA_PK,
        C.CLIENTE_NOMBRE,
        C.CLIENTE_CORREO,
        C.MOTIVO,
        C.FECHA_INICIO,
        GROUP_CONCAT(
            IFNULL(M.NOMBRE_MASCOTA, CM.MASCOTA_NOMBRE_MANUAL)
            SEPARATOR ', '
        ) AS MASCOTAS
    FROM HUELLITAS_CITAS_TB C
    LEFT JOIN HUELLITAS_CITAS_MASCOTAS_TB CM 
        ON CM.ID_CITA_FK = C.ID_CITA_PK
    LEFT JOIN HUELLITAS_MASCOTA_TB M 
        ON M.ID_MASCOTA_PK = CM.ID_MASCOTA_FK
    WHERE 
        C.FECHA_INICIO BETWEEN NOW() 
        AND DATE_ADD(NOW(), INTERVAL 1 HOUR)
    GROUP BY C.ID_CITA_PK;
END$$
DELIMITER ;


-- ======================================================
-- NOMBRE: HUELLITAS_GENERAR_NOTIF_CITAS_MANANA_SP
-- DESCRIPCIÓN: Procedimiento para crear notificaciones de citas de mañana
-- ======================================================
DROP PROCEDURE IF EXISTS HUELLITAS_GENERAR_NOTIF_CITAS_MANANA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_GENERAR_NOTIF_CITAS_MANANA_SP()
BEGIN
    INSERT INTO HUELLITAS_NOTIFICACIONES_TB (
        ID_USUARIO_FK,
        ID_ESTADO_FK,
        TITULO_NOTIFICACION,
        MENSAJE_NOTIFICACION,
        TIPO_NOTIFICACION,
        PRIORIDAD,
        URL_REDIRECCION
    )
    SELECT 
        U.ID_USUARIO_PK AS ID_USUARIO_FK,
        1 AS ID_ESTADO_FK, -- ACTIVA
        'Recordatorio de cita para mañana' AS TITULO,
        CONCAT(
            'Estimado(a) ', C.CLIENTE_NOMBRE,
            ', tienes una cita programada para mañana a las ',
            DATE_FORMAT(C.FECHA_INICIO, '%h:%i %p'),
            '. Motivo: ', IFNULL(C.MOTIVO, 'Sin motivo registrado'),
            '. Mascotas: ',
            IFNULL(
                (SELECT GROUP_CONCAT(IFNULL(M.NOMBRE_MASCOTA, CM.MASCOTA_NOMBRE_MANUAL) SEPARATOR ', ')
                 FROM HUELLITAS_CITAS_MASCOTAS_TB CM
                 LEFT JOIN HUELLITAS_MASCOTA_TB M ON M.ID_MASCOTA_PK = CM.ID_MASCOTA_FK
                 WHERE CM.ID_CITA_FK = C.ID_CITA_PK),
            'N/A')
        ) AS MENSAJE,
        'CITA' AS TIPO_NOTIF,
        'ALTA' AS PRIORIDAD,
        CONCAT('/index.php?controller=appointment&action=misCitas') AS URL_REDIRECCION
    FROM HUELLITAS_CITAS_TB C
    LEFT JOIN HUELLITAS_USUARIOS_TB U
        ON U.CODIGO_USUARIO = C.CODIGO_USUARIO
    WHERE DATE(C.FECHA_INICIO) = CURDATE() + INTERVAL 1 DAY;
END$$
DELIMITER ;

-- ======================================================
-- NOMBRE: HUELLITAS_GENERAR_NOTIF_CITAS_EN_1_HORA_SP
-- DESCRIPCIÓN: Procedimiento para crear notificaciones de citas de cada hora
-- ======================================================
DROP PROCEDURE IF EXISTS HUELLITAS_GENERAR_NOTIF_CITAS_EN_1_HORA_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_GENERAR_NOTIF_CITAS_EN_1_HORA_SP()
BEGIN
    INSERT INTO HUELLITAS_NOTIFICACIONES_TB (
        ID_USUARIO_FK,
        ID_ESTADO_FK,
        TITULO_NOTIFICACION,
        MENSAJE_NOTIFICACION,
        TIPO_NOTIFICACION,
        PRIORIDAD,
        URL_REDIRECCION
    )
    SELECT 
        U.ID_USUARIO_PK AS ID_USUARIO_FK,
        1 AS ID_ESTADO_FK, -- ACTIVA
        'Tu cita empieza en aproximadamente 1 hora' AS TITULO,
        CONCAT(
            'Hola ', C.CLIENTE_NOMBRE,
            ', tu cita inicia a las ',
            DATE_FORMAT(C.FECHA_INICIO, '%h:%i %p'),
            '. Motivo: ', IFNULL(C.MOTIVO, 'Sin motivo registrado'),
            '. Mascotas: ',
            IFNULL(
                (SELECT GROUP_CONCAT(IFNULL(M.NOMBRE_MASCOTA, CM.MASCOTA_NOMBRE_MANUAL) SEPARATOR ', ')
                 FROM HUELLITAS_CITAS_MASCOTAS_TB CM
                 LEFT JOIN HUELLITAS_MASCOTA_TB M ON M.ID_MASCOTA_PK = CM.ID_MASCOTA_FK
                 WHERE CM.ID_CITA_FK = C.ID_CITA_PK),
            'N/A')
        ) AS MENSAJE,
        'CITA' AS TIPO_NOTIF,
        'ALTA' AS PRIORIDAD,
        CONCAT('/index.php?controller=appointment&action=misCitas') AS URL_REDIRECCION
    FROM HUELLITAS_CITAS_TB C
    LEFT JOIN HUELLITAS_USUARIOS_TB U
        ON U.CODIGO_USUARIO = C.CODIGO_USUARIO
    WHERE C.FECHA_INICIO BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 1 HOUR);
END$$
DELIMITER ;

-- ======================================================
-- NOMBRE: HUELLITAS_OBTENER_EXPEDIENTES_SP
-- DESCRIPCIÓN: Procedimiento para recopilar información para los expedientes
-- ======================================================
DROP PROCEDURE IF EXISTS HUELLITAS_OBTENER_EXPEDIENTES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_OBTENER_EXPEDIENTES_SP(
    IN p_busqueda VARCHAR(100)
)
BEGIN

    SELECT 
        m.ID_MASCOTA_PK,
        m.CODIGO_MASCOTA,
        m.NOMBRE_MASCOTA,
        m.GENERO,
        m.MASCOTA_IMAGEN_URL,

        -- Edad
        TIMESTAMPDIFF(YEAR, m.FECHA_NACIMIENTO, CURDATE()) AS EDAD_APROX,

        -- Obtener nombre del dueño desde ambas tablas
        COALESCE(cli.CLIENTE_NOMBRE, usr.USUARIO_NOMBRE, 'Sin dueño registrado') AS DUENNO_NOMBRE,
        COALESCE(cli.CLIENTE_CORREO, usr.USUARIO_CORREO, 'No disponible') AS DUENNO_CORREO,

        -- Última consulta desde historiales médicos
        (
            SELECT MAX(HISTORIAL_FECHA_REGISTRO)
            FROM HUELLITAS_HISTORIALES_MEDICOS_TB h
            WHERE h.CODIGO_MASCOTA = m.CODIGO_MASCOTA
        ) AS ULTIMA_CONSULTA

    FROM HUELLITAS_MASCOTA_TB m

    -- OWNER TIPO 1: Cliente del veterinario
    LEFT JOIN HUELLITAS_CLIENTES_TB cli 
        ON cli.ID_CLIENTE_PK = m.ID_CLIENTE_FK

    -- OWNER TIPO 2: Usuario (cliente de tienda)
    LEFT JOIN HUELLITAS_USUARIOS_TB usr
        ON usr.ID_USUARIO_PK = m.ID_USUARIO_FK

    WHERE 
        p_busqueda IS NULL
        OR p_busqueda = ''
        OR m.NOMBRE_MASCOTA LIKE CONCAT('%', p_busqueda, '%')
        OR m.CODIGO_MASCOTA LIKE CONCAT('%', p_busqueda, '%')
        OR cli.CLIENTE_NOMBRE LIKE CONCAT('%', p_busqueda, '%')
        OR usr.USUARIO_NOMBRE LIKE CONCAT('%', p_busqueda, '%')

    ORDER BY m.NOMBRE_MASCOTA ASC;

END $$
DELIMITER ;

-- ==========================================
-- STORED PROCEDURES PARA EL DASHBOARD
-- ==========================================

-- 1. CITAS CONFIRMADAS PARA HOY
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_CITAS_HOY_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_CITAS_HOY_SP()
BEGIN
    SELECT COUNT(*) AS total_citas_hoy
    FROM HUELLITAS_CITAS_TB 
    WHERE DATE(FECHA_INICIO) = CURDATE() 
    AND ID_ESTADO_FK = 1;
END$$
DELIMITER ;

-- 2. PEDIDOS PENDIENTES
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_PEDIDOS_PENDIENTES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_PEDIDOS_PENDIENTES_SP()
BEGIN
    SELECT COUNT(*) AS pedidos_pendientes
    FROM HUELLITAS_PEDIDOS_TB 
    WHERE ID_ESTADO_FK IN (3, 4);
END$$
DELIMITER ;

-- 3. TOTAL CLIENTES REGISTRADOS
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_TOTAL_CLIENTES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_TOTAL_CLIENTES_SP()
BEGIN
    SELECT 
        (SELECT COUNT(*) 
         FROM HUELLITAS_CLIENTES_TB 
         WHERE ID_ESTADO_FK = 1) +
        (SELECT COUNT(*) 
         FROM HUELLITAS_USUARIOS_TB 
         WHERE ID_ESTADO_FK = 1 
           AND ID_ROL_USUARIO_FK = 1) AS total_clientes;
END$$
DELIMITER ;

-- 4. ARTÍCULOS CON STOCK BAJO
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_STOCK_BAJO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_STOCK_BAJO_SP()
BEGIN
    SELECT COUNT(*) AS productos_stock_bajo
    FROM HUELLITAS_PRODUCTOS_TB 
    WHERE PRODUCTO_STOCK <= 5 
    AND ID_ESTADO_FK = 1;
END$$
DELIMITER ;

-- 5. CLIENTES ACTIVOS
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_CLIENTES_ACTIVOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_CLIENTES_ACTIVOS_SP()
BEGIN
    SELECT COUNT(DISTINCT C.ID_CLIENTE_PK) AS clientes_activos
    FROM HUELLITAS_CLIENTES_TB C
    INNER JOIN HUELLITAS_CITAS_TB CT ON C.CODIGO_CLIENTE = CT.CODIGO_CLIENTE
    WHERE C.ID_ESTADO_FK = 1
    AND CT.FECHA_CREACION >= DATE_SUB(NOW(), INTERVAL 30 DAY);
END$$
DELIMITER ;

-- 6. PROVEEDORES ACTIVOS
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_PROVEEDORES_ACTIVOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_PROVEEDORES_ACTIVOS_SP()
BEGIN
    SELECT COUNT(*) AS proveedores_activos
    FROM HUELLITAS_PROVEEDORES_TB 
    WHERE ID_ESTADO_FK = 1;
END$$
DELIMITER ;

-- 7. ESTADÍSTICAS MENSUALES
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_ESTADISTICAS_MENSUALES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_ESTADISTICAS_MENSUALES_SP()
BEGIN
    SELECT 
        MONTHNAME(FECHA_PEDIDO) AS mes,
        COUNT(*) AS total
    FROM HUELLITAS_PEDIDOS_TB 
    WHERE YEAR(FECHA_PEDIDO) = YEAR(CURDATE())
    GROUP BY MONTH(FECHA_PEDIDO), MONTHNAME(FECHA_PEDIDO)
    ORDER BY MONTH(FECHA_PEDIDO);
END$$
DELIMITER ;

-- 8. PRODUCTOS MÁS VENDIDOS
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_PRODUCTOS_MAS_VENDIDOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_PRODUCTOS_MAS_VENDIDOS_SP()
BEGIN
    SELECT 
        p.PRODUCTO_NOMBRE,
        p.IMAGEN_URL,
        p.PRODUCTO_PRECIO_UNITARIO AS PRECIO,
        c.DESCRIPCION_CATEGORIA AS CATEGORIA,
        p.PRODUCTO_STOCK AS STOCK,
        e.ESTADO_DESCRIPCION AS ESTADO,
        COALESCE(SUM(pd.CANTIDAD), 0) AS TOTAL_VENDIDO
    FROM HUELLITAS_PRODUCTOS_TB p
    LEFT JOIN HUELLITAS_PEDIDOS_DETALLE_TB pd ON p.ID_PRODUCTO_PK = pd.ID_PRODUCTO_FK
    INNER JOIN HUELLITAS_PRODUCTOS_CATEGORIA_TB c ON p.ID_CATEGORIA_FK = c.ID_CATEGORIA_PK
    INNER JOIN HUELLITAS_ESTADO_TB e ON p.ID_ESTADO_FK = e.ID_ESTADO_PK
    WHERE p.ID_ESTADO_FK = 1
    GROUP BY p.ID_PRODUCTO_PK, p.PRODUCTO_NOMBRE, p.IMAGEN_URL, p.PRODUCTO_PRECIO_UNITARIO, 
             c.DESCRIPCION_CATEGORIA, p.PRODUCTO_STOCK, e.ESTADO_DESCRIPCION
    ORDER BY TOTAL_VENDIDO DESC
    LIMIT 5;
END$$
DELIMITER ;

-- 9. ÚLTIMOS PEDIDOS
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_ULTIMOS_PEDIDOS_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_ULTIMOS_PEDIDOS_SP()
BEGIN
    SELECT 
        p.CODIGO_PEDIDO,
        u.USUARIO_NOMBRE AS CLIENTE,
        e.ESTADO_DESCRIPCION AS ESTADO_PEDIDO,
        p.FECHA_PEDIDO,
        p.TOTAL
    FROM HUELLITAS_PEDIDOS_TB p
    INNER JOIN HUELLITAS_USUARIOS_TB u ON p.ID_USUARIO_FK = u.ID_USUARIO_PK
    INNER JOIN HUELLITAS_ESTADO_TB e ON p.ID_ESTADO_FK = e.ID_ESTADO_PK
    ORDER BY p.FECHA_PEDIDO DESC
    LIMIT 5;
END$$
DELIMITER ;

-- ==========================================
-- SP: HUELLITAS_DASHBOARD_CITAS_HOY_SP
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_EMPLEADO_CITAS_HOY_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_EMPLEADO_CITAS_HOY_SP(IN p_id_empleado INT)
BEGIN
    SELECT 
        c.ID_CITA_PK,
        c.FECHA_INICIO,
        c.FECHA_FIN,
        s.NOMBRE_SERVICIO,
        COALESCE(m.NOMBRE_MASCOTA, cm.MASCOTA_NOMBRE_MANUAL) AS mascota_nombre,
        c.CLIENTE_NOMBRE,
        c.CLIENTE_TELEFONO,
        e.ESTADO_DESCRIPCION
    FROM HUELLITAS_CITAS_TB c
    JOIN HUELLITAS_SERVICIOS_TB s ON c.ID_SERVICIO_FK = s.ID_SERVICIO_PK
    JOIN HUELLITAS_ESTADO_TB e ON c.ID_ESTADO_FK = e.ID_ESTADO_PK
    LEFT JOIN HUELLITAS_CITAS_MASCOTAS_TB cm ON c.ID_CITA_PK = cm.ID_CITA_FK
    LEFT JOIN HUELLITAS_MASCOTA_TB m ON cm.ID_MASCOTA_FK = m.ID_MASCOTA_PK
    WHERE c.ID_VETERINARIO_FK = p_id_empleado
    AND DATE(c.FECHA_INICIO) = CURDATE()
    AND c.ID_ESTADO_FK = 1
    ORDER BY c.FECHA_INICIO;
END$$
DELIMITER ;

-- ==========================================
-- SP: HUELLITAS_DASHBOARD_CITAS_PENDIENTES_SP
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_CITAS_PENDIENTES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_CITAS_PENDIENTES_SP(IN p_id_empleado INT)
BEGIN
    SELECT COUNT(*) AS citas_pendientes
    FROM HUELLITAS_CITAS_TB 
    WHERE ID_VETERINARIO_FK = p_id_empleado
    AND DATE(FECHA_INICIO) = CURDATE()
    AND ID_ESTADO_FK = 1;
END$$
DELIMITER ;

-- ==========================================
-- SP: HUELLITAS_DASHBOARD_PEDIDOS_PENDIENTES_SP
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_PEDIDOS_PENDIENTES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_PEDIDOS_PENDIENTES_SP()
BEGIN
    SELECT 
        p.ID_PEDIDO_PK,
        p.CODIGO_PEDIDO,
        u.USUARIO_NOMBRE,
        p.FECHA_PEDIDO,
        p.TOTAL,
        e.ESTADO_DESCRIPCION
    FROM HUELLITAS_PEDIDOS_TB p
    JOIN HUELLITAS_USUARIOS_TB u ON p.ID_USUARIO_FK = u.ID_USUARIO_PK
    JOIN HUELLITAS_ESTADO_TB e ON p.ID_ESTADO_FK = e.ID_ESTADO_PK
    WHERE p.ID_ESTADO_FK IN (1, 2) -- Pendiente o Pagado
    ORDER BY p.FECHA_PEDIDO DESC
    LIMIT 10;
END$$
DELIMITER ;

-- ==========================================
-- SP: HUELLITAS_DASHBOARD_MOVIMIENTOS_INVENTARIO_SP
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_MOVIMIENTOS_INVENTARIO_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_MOVIMIENTOS_INVENTARIO_SP()
BEGIN
    SELECT 
        p.PRODUCTO_NOMBRE,
        mi.TIPO_MOVIMIENTO,
        mi.CANTIDAD,
        mi.MOTIVO,
        mi.FECHA_MOVIMIENTO,
        u.USUARIO_NOMBRE
    FROM HUELLITAS_MOVIMIENTOS_INVENTARIO_TB mi
    JOIN HUELLITAS_PRODUCTOS_TB p ON mi.ID_PRODUCTO_FK = p.ID_PRODUCTO_PK
    LEFT JOIN HUELLITAS_USUARIOS_TB u ON mi.ID_USUARIO_FK = u.ID_USUARIO_PK
    ORDER BY mi.FECHA_MOVIMIENTO DESC
    LIMIT 10;
END$$
DELIMITER ;

-- ==========================================
-- SP: HUELLITAS_DASHBOARD_SERVICIOS_MES_SP
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_SERVICIOS_MES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_SERVICIOS_MES_SP(IN p_id_empleado INT)
BEGIN
    SELECT 
        s.NOMBRE_SERVICIO,
        COUNT(*) AS total_servicios
    FROM HUELLITAS_CITAS_TB c
    JOIN HUELLITAS_SERVICIOS_TB s ON c.ID_SERVICIO_FK = s.ID_SERVICIO_PK
    WHERE c.ID_VETERINARIO_FK = p_id_empleado
    AND MONTH(c.FECHA_INICIO) = MONTH(CURDATE())
    AND YEAR(c.FECHA_INICIO) = YEAR(CURDATE())
    AND c.ID_ESTADO_FK IN (1,2)
    GROUP BY s.NOMBRE_SERVICIO
    ORDER BY total_servicios DESC;
END$$
DELIMITER ;

-- ==========================================
-- SP: HUELLITAS_DASHBOARD_CITAS_COMPARACION_MES_SP
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_CITAS_COMPARACION_MES_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_CITAS_COMPARACION_MES_SP(IN p_id_empleado INT)
BEGIN
    SELECT 
        'Mes Actual' AS periodo,
        COUNT(*) AS total_citas
    FROM HUELLITAS_CITAS_TB 
    WHERE ID_VETERINARIO_FK = p_id_empleado
    AND MONTH(FECHA_INICIO) = MONTH(CURDATE())
    AND YEAR(FECHA_INICIO) = YEAR(CURDATE())
    AND ID_ESTADO_FK IN (1,2)
    
    UNION ALL
    
    SELECT 
        'Mes Anterior' AS periodo,
        COUNT(*) AS total_citas
    FROM HUELLITAS_CITAS_TB 
    WHERE ID_VETERINARIO_FK = p_id_empleado
    AND MONTH(FECHA_INICIO) = MONTH(DATE_SUB(CURDATE(), INTERVAL 1 MONTH))
    AND YEAR(FECHA_INICIO) = YEAR(DATE_SUB(CURDATE(), INTERVAL 1 MONTH))
    AND ID_ESTADO_FK IN (1,2);
END$$
DELIMITER ;

-- ==========================================
-- SP: HUELLITAS_DASHBOARD_CIRUGIAS_HOY_SP
-- ==========================================
DROP PROCEDURE IF EXISTS HUELLITAS_DASHBOARD_CIRUGIAS_HOY_SP;
DELIMITER $$
CREATE PROCEDURE HUELLITAS_DASHBOARD_CIRUGIAS_HOY_SP(IN p_id_empleado INT)
BEGIN
    SELECT 
        rc.ID_CIRUGIA_PK,
        m.NOMBRE_MASCOTA,
        rc.CIRUGIA_FECHA_INICIO,
        rc.CIRUGIA_FECHA_FINAL,
        rc.CIRUGIA_ANOTACIONES
    FROM HUELLITAS_REGISTRO_CIRUGIAS_TB rc
    JOIN HUELLITAS_MASCOTA_TB m ON rc.ID_MASCOTA_FK = m.ID_MASCOTA_PK
    JOIN HUELLITAS_CIRUGIAS_PERSONAL_TB cp ON rc.ID_CIRUGIA_PK = cp.ID_CIRUGIA_FK
    WHERE cp.ID_USUARIO_FK = p_id_empleado
    AND DATE(rc.CIRUGIA_FECHA_INICIO) = CURDATE()
    AND rc.ID_ESTADO_FK = 1;
END$$
DELIMITER ;



